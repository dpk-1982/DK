<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primary School Karanpur - Report Card System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@latest/dist/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@300;400;700&display=swap');
        
        * {
            font-family: 'Comic Neue', cursive;
        }
        
        .marquee {
            position: fixed;
            width: 100%;
            z-index: 1000;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .marquee-top {
            top: 0;
            background: linear-gradient(45deg, #ff6b6b 0%, #feca57 100%);
        }
        
        .marquee-bottom {
            bottom: 0;
            background: linear-gradient(45deg, #48cae4 0%, #023e8a 100%);
        }
        
        .marquee-content {
            display: inline-block;
            animation: scroll 20s linear infinite;
            padding: 10px 0;
            color: white;
            font-weight: bold;
        }
        
        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .floating-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        
        .shape {
            position: absolute;
            opacity: 0.7;
            animation: float 6s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .shape:nth-child(1) { left: 10%; animation-delay: 0s; background: linear-gradient(45deg, #ff6b6b, #feca57); }
        .shape:nth-child(2) { left: 20%; animation-delay: 1s; background: linear-gradient(45deg, #4ecdc4, #45b7d1); }
        .shape:nth-child(3) { left: 30%; animation-delay: 2s; background: linear-gradient(45deg, #96ceb4, #ff9ff3); }
        .shape:nth-child(4) { left: 40%; animation-delay: 3s; background: linear-gradient(45deg, #feca57, #ff6b6b); }
        .shape:nth-child(5) { left: 50%; animation-delay: 4s; background: linear-gradient(45deg, #45b7d1, #4ecdc4); }
        .shape:nth-child(6) { left: 60%; animation-delay: 5s; background: linear-gradient(45deg, #ff9ff3, #96ceb4); }
        .shape:nth-child(7) { left: 70%; animation-delay: 6s; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); }
        .shape:nth-child(8) { left: 80%; animation-delay: 7s; background: linear-gradient(45deg, #feca57, #45b7d1); }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); }
            25% { transform: translateY(-20px) rotate(90deg) scale(1.1); }
            50% { transform: translateY(-40px) rotate(180deg) scale(0.9); }
            75% { transform: translateY(-20px) rotate(270deg) scale(1.1); }
        }
        
        .bounce-in {
            animation: bounceIn 0.8s ease-out;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .slide-in {
            animation: slideIn 0.6s ease-out;
        }
        
        @keyframes slideIn {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        body {
            padding-top: 60px;
            padding-bottom: 60px;
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 25%, #45b7d1 50%, #96ceb4 75%, #feca57 100%);
            min-height: 100vh;
            animation: rainbow-bg 10s ease-in-out infinite;
        }
        
        @keyframes rainbow-bg {
            0% { background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 25%, #45b7d1 50%, #96ceb4 75%, #feca57 100%); }
            25% { background: linear-gradient(135deg, #feca57 0%, #ff6b6b 25%, #4ecdc4 50%, #45b7d1 75%, #96ceb4 100%); }
            50% { background: linear-gradient(135deg, #96ceb4 0%, #feca57 25%, #ff6b6b 50%, #4ecdc4 75%, #45b7d1 100%); }
            75% { background: linear-gradient(135deg, #45b7d1 0%, #96ceb4 25%, #feca57 50%, #ff6b6b 75%, #4ecdc4 100%); }
            100% { background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 25%, #45b7d1 50%, #96ceb4 75%, #feca57 100%); }
        }
        
        .glass-effect {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }
        
        .instant-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10001;
            padding: 15px 25px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            animation: alertPop 0.3s ease-out;
            pointer-events: none;
            min-width: 250px;
            text-align: center;
        }
        
        .instant-alert.error {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #dc2626;
            border: 3px solid #ef4444;
        }
        
        .instant-alert.warning {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            color: #d97706;
            border: 3px solid #f59e0b;
        }
        
        .instant-alert.success {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #16a34a;
            border: 3px solid #22c55e;
        }
        
        @keyframes alertPop {
            0% { 
                transform: translate(-50%, -50%) scale(0.3);
                opacity: 0;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        .subject-item {
            cursor: move;
            transition: all 0.3s ease;
        }
        
        .subject-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .subject-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        .drag-over {
            border: 2px dashed #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body>
  
  
  
  
  
  <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyD9nE0-yeC5Ms34OKXbxSSfmfscyzUMn_Q",
    authDomain: "dd1982-54ac7.firebaseapp.com",
    databaseURL: "https://dd1982-54ac7-default-rtdb.firebaseio.com",
    projectId: "dd1982-54ac7",
    storageBucket: "dd1982-54ac7.firebasestorage.app",
    messagingSenderId: "433562739590",
    appId: "1:433562739590:web:dab8cfa164455d75404207"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>
    <!-- Top Marquee -->
    <div class="marquee marquee-top">
        <div class="floating-shapes">
            <div class="shape w-8 h-8 bg-yellow-300 rounded-full"></div>
            <div class="shape w-6 h-6 bg-pink-300 transform rotate-45"></div>
            <div class="shape w-10 h-10 bg-green-300 rounded-full"></div>
            <div class="shape w-7 h-7 bg-blue-300 transform rotate-45"></div>
            <div class="shape w-9 h-9 bg-purple-300 rounded-full"></div>
            <div class="shape w-5 h-5 bg-red-300 transform rotate-45"></div>
            <div class="shape w-8 h-8 bg-indigo-300 rounded-full"></div>
            <div class="shape w-6 h-6 bg-orange-300 transform rotate-45"></div>
        </div>
        <div class="marquee-content text-lg">
            üåü Welcome to Primary School Karanpur, A place where students learn with joy..!! üåü
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- School Header -->
        <div class="text-center mb-8 bounce-in relative">
            <div class="absolute -top-4 left-1/4 text-4xl animate-bounce">üåü</div>
            <div class="absolute -top-2 right-1/4 text-3xl animate-bounce" style="animation-delay: 0.5s;">‚≠ê</div>
            <div class="absolute top-2 left-1/6 text-2xl animate-bounce" style="animation-delay: 1s;">üéà</div>
            <div class="absolute top-4 right-1/6 text-2xl animate-bounce" style="animation-delay: 1.5s;">üéâ</div>
            
            <div class="max-w-4xl mx-auto bg-gradient-to-br from-white via-yellow-50 to-pink-50 rounded-3xl p-8 shadow-2xl border-2 border-blue-200 relative overflow-hidden">
                <div class="absolute top-2 left-2 w-6 h-6 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full"></div>
                <div class="absolute top-2 right-2 w-6 h-6 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full"></div>
                <div class="absolute bottom-2 left-2 w-6 h-6 bg-gradient-to-br from-green-400 to-blue-500 rounded-full"></div>
                <div class="absolute bottom-2 right-2 w-6 h-6 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full"></div>
                
                <h1 class="text-4xl md:text-6xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent mb-4 drop-shadow-lg relative z-10">
                    üè´ Primary School Karanpur üè´
                </h1>
                <p class="text-xl font-semibold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent drop-shadow-md relative z-10">
                    üìç Block-Behjam, District-Lakhimpur-Kheri
                </p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-8">
            <div class="bg-white rounded-full p-2 shadow-lg">
                <button id="studentTab" class="px-6 py-3 rounded-full bg-gradient-to-r from-pink-500 to-orange-500 text-white font-bold transition-all duration-300 hover:from-pink-600 hover:to-orange-600 shadow-lg transform hover:scale-110 hover:shadow-2xl">
                    üë®‚Äçüéì Student Portal
                </button>
                <button id="adminTab" class="px-6 py-3 rounded-full text-gray-600 font-bold transition-all duration-300 hover:bg-gradient-to-r hover:from-blue-400 hover:to-purple-500 hover:text-white shadow-lg transform hover:scale-110 hover:shadow-2xl">
                    üë®‚Äçüíº Admin Panel
                </button>
            </div>
        </div>

        <!-- Student Portal -->
        <div id="studentPortal" class="slide-in">
            <div class="glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                <h2 class="text-3xl font-bold text-white text-center mb-6">
                    üìä Student Report Card üìä
                </h2>
                
                <!-- Student Message Tile -->
                <div id="studentMessageTile" class="bg-gradient-to-br from-orange-100 via-yellow-100 to-red-100 rounded-2xl p-6 shadow-lg border-2 border-orange-300 transform hover:scale-105 transition-all duration-300 mb-6 relative overflow-hidden">
                    <div class="absolute top-2 left-2 text-2xl animate-bounce">üì¢</div>
                    <div class="absolute top-2 right-2 text-2xl animate-bounce" style="animation-delay: 0.5s;">üåü</div>
                    
                    <label class="block text-lg font-bold text-orange-700 mb-3 text-center">üì£ Important Message</label>
                    <div id="studentMessageContent" class="w-full p-4 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl text-center font-bold text-orange-800 text-lg border-2 border-orange-200 shadow-inner">
                        üì¢ Dear Students! First Term examination results are now available. Check your performance and keep working hard for the upcoming terms! üåüüìö
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <!-- Class Selection -->
                    <div class="bg-gradient-to-br from-blue-100 to-cyan-100 rounded-2xl p-6 shadow-lg border-2 border-blue-200 transform hover:scale-105 transition-all duration-300">
                        <label class="block text-lg font-bold text-blue-700 mb-3">üéì Select Class</label>
                        <select id="classSelect" class="w-full p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none bg-gradient-to-r from-blue-50 to-cyan-50 focus:shadow-lg transition-all duration-300">
                            <option value="">Choose Class</option>
                            <option value="1">Class 1</option>
                            <option value="2">Class 2</option>
                            <option value="3">Class 3</option>
                            <option value="4">Class 4</option>
                            <option value="5">Class 5</option>
                        </select>
                    </div>
                    
                    <!-- Term Selection -->
                    <div class="bg-gradient-to-br from-purple-100 to-pink-100 rounded-2xl p-6 shadow-lg border-2 border-purple-200 transform hover:scale-105 transition-all duration-300">
                        <label class="block text-lg font-bold text-purple-700 mb-3">üìÖ Select Term</label>
                        <select id="termSelect" class="w-full p-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none bg-gradient-to-r from-purple-50 to-pink-50 focus:shadow-lg transition-all duration-300" disabled>
                            <option value="">Choose Term</option>
                        </select>
                    </div>
                    
                    <!-- Student Selection -->
                    <div class="bg-gradient-to-br from-green-100 to-teal-100 rounded-2xl p-6 shadow-lg border-2 border-green-200 transform hover:scale-105 transition-all duration-300">
                        <label class="block text-lg font-bold text-green-700 mb-3">üë¶ Select Student</label>
                        <select id="studentSelect" class="w-full p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none bg-gradient-to-r from-green-50 to-teal-50 focus:shadow-lg transition-all duration-300" disabled>
                            <option value="">Choose Student</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Report Card Display -->
            <div id="reportCardDisplay" class="hidden glass-effect rounded-3xl p-8 shadow-2xl">
                <div id="reportCardContent"></div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden">
            <!-- Admin Login -->
            <div id="adminLogin" class="glass-effect rounded-3xl p-8 mb-8 shadow-2xl text-center">
                <h2 class="text-3xl font-bold text-white mb-6">üîê Admin Login</h2>
                <div class="max-w-md mx-auto">
                    <input type="password" id="adminPassword" placeholder="Enter Admin Password" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none mb-4">
                    <button id="adminLoginBtn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                        üö™ Login
                    </button>
                    <div id="loginMessage" class="mt-4 text-sm"></div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="hidden">
                <div class="glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h2 class="text-3xl font-bold text-white text-center mb-6">üë®‚Äçüíº Admin Dashboard</h2>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <!-- Class Selection -->
                        <div class="bg-white rounded-2xl p-4 shadow-lg">
                            <label class="block text-sm font-bold text-blue-600 mb-2">üéì Class</label>
                            <select id="adminClassSelect" class="w-full p-2 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none">
                                <option value="">Choose Class</option>
                                <option value="1">Class 1</option>
                                <option value="2">Class 2</option>
                                <option value="3">Class 3</option>
                                <option value="4">Class 4</option>
                                <option value="5">Class 5</option>
                            </select>
                        </div>
                        
                        <!-- Term Selection -->
                        <div class="bg-white rounded-2xl p-4 shadow-lg">
                            <label class="block text-sm font-bold text-purple-600 mb-2">üìÖ Term</label>
                            <select id="adminTermSelect" class="w-full p-2 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none" disabled>
                                <option value="">Choose Term</option>
                                <option value="Combined Terms">üìä Combined Terms (All)</option>
                            </select>
                        </div>
                        
                        <!-- Student Selection -->
                        <div class="bg-white rounded-2xl p-4 shadow-lg">
                            <label class="block text-sm font-bold text-green-600 mb-2">üë¶ Student</label>
                            <select id="adminStudentSelect" class="w-full p-2 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none" disabled>
                                <option value="">Choose Student</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Max Marks Configuration -->
                    <div id="maxMarksConfig" class="hidden bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl p-6 shadow-lg border-2 border-yellow-300 mb-6">
                        <h4 class="text-lg font-bold text-orange-700 mb-4 text-center">‚öôÔ∏è Configure Max Marks for Selected Term</h4>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="bg-white rounded-xl p-4 shadow-lg">
                                <label class="block text-sm font-bold text-blue-600 mb-2">üó£Ô∏è Max Oral Marks</label>
                                <input type="number" id="maxOralMarks" min="1" max="50" class="w-full p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none text-center font-bold">
                            </div>
                            <div class="bg-white rounded-xl p-4 shadow-lg">
                                <label class="block text-sm font-bold text-green-600 mb-2">‚úçÔ∏è Max Written Marks</label>
                                <input type="number" id="maxWrittenMarks" min="1" max="100" class="w-full p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none text-center font-bold">
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <button id="saveMaxMarksBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                                üíæ Save Max Marks
                            </button>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="grid md:grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
                        <button id="addStudentBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            ‚ûï Add Student
                        </button>
                        <button id="deleteStudentBtn" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üóëÔ∏è Delete Student
                        </button>
                        <button id="composeMessageBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üìù Compose Message
                        </button>
                        <button id="manageTermsBtn" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üìÖ Manage Terms
                        </button>
                        <button id="manageSubjectsBtn" class="bg-gradient-to-r from-teal-500 to-cyan-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üìö Manage Subjects
                        </button>
                        <button id="manageExamTypesBtn" class="bg-gradient-to-r from-rose-500 to-pink-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üìù Exam Types
                        </button>
                        <button id="manageProfilesBtn" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üë§ Student Profiles
                        </button>
                        <button id="downloadTabulationBtn" class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üìÑ Download Tabulation
                        </button>
                    </div>
                    
                    <!-- Action Messages -->
                    <div id="actionMessages" class="text-center mb-6"></div>
                </div>

                <!-- Add/Edit Student Form -->
                <div id="studentForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">üìù Student Information</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-2xl p-6 shadow-lg">
                            <label class="block text-lg font-bold text-blue-600 mb-3">üë¶ Student Name</label>
                            <input type="text" id="studentName" class="w-full p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none" placeholder="Enter student name">
                        </div>
                        <div class="bg-white rounded-2xl p-6 shadow-lg">
                            <label class="block text-lg font-bold text-green-600 mb-3">üë® Father's Name</label>
                            <input type="text" id="fatherName" class="w-full p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none" placeholder="Enter father's name">
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="saveStudentBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üíæ Save Student
                        </button>
                        <button id="cancelFormBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>

                <!-- Term Management Form -->
                <div id="termForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">üìÖ Manage Terms</h3>
                    
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-2xl p-6 shadow-lg">
                            <label class="block text-lg font-bold text-indigo-600 mb-3">‚ûï Add New Term</label>
                            <div class="flex gap-2">
                                <input type="text" id="newTermName" class="flex-1 p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none" placeholder="Enter term name (e.g., Mid Term, Unit Test 1)">
                                <button id="addTermBtn" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                                    ‚ûï
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6 shadow-lg">
                            <label class="block text-lg font-bold text-purple-600 mb-3">üîÑ Combined Term View</label>
                            <div class="text-purple-700 font-semibold">
                                <p class="mb-2">üìä Use "Combined Terms" to:</p>
                                <ul class="text-sm space-y-1">
                                    <li>‚Ä¢ View all terms together</li>
                                    <li>‚Ä¢ Edit marks across terms</li>
                                    <li>‚Ä¢ Compare performance</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-purple-600 mb-4">üìã Current Terms</h4>
                        <div id="termList" class="space-y-2">
                            <!-- Term items will be dynamically added here -->
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="saveTermsBtn" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üíæ Save Changes
                        </button>
                        <button id="cancelTermBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>

                <!-- Message Composition Form -->
                <div id="messageForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">üìù Compose Student Message</h3>
                    
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-2xl p-6 shadow-lg">
                            <label class="block text-lg font-bold text-purple-600 mb-3">üìÖ Select Term</label>
                            <select id="messageTermSelect" class="w-full p-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none">
                                <option value="">Choose Term</option>
                            </select>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6 shadow-lg">
                            <label class="block text-lg font-bold text-teal-600 mb-3">üîì Make Available to Students</label>
                            <div class="flex items-center">
                                <input type="checkbox" id="makeTermAvailable" class="w-5 h-5 text-teal-600 border-2 border-teal-300 rounded focus:ring-teal-500">
                                <label for="makeTermAvailable" class="ml-3 text-teal-700 font-semibold">Allow students to view this term</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <label class="block text-lg font-bold text-orange-600 mb-3">üì¢ Message for Students</label>
                        <textarea id="studentMessage" rows="4" class="w-full p-4 border-2 border-orange-300 rounded-xl focus:border-orange-500 focus:outline-none resize-none" placeholder="Enter message for students (e.g., exam announcements, important notices...)"></textarea>
                        <div class="text-sm text-gray-600 mt-2">üí° This message will be displayed to students when they select this term</div>
                    </div>
                    
                    <div class="text-center">
                        <button id="saveMessageBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üíæ Save Message & Settings
                        </button>
                        <button id="cancelMessageBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>

                <!-- Subject Management Form -->
                <div id="subjectForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">üìö Manage Subjects</h3>
                    
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-2xl p-6 shadow-lg">
                            <label class="block text-lg font-bold text-teal-600 mb-3">üéì Select Class</label>
                            <select id="subjectClassSelect" class="w-full p-3 border-2 border-teal-300 rounded-xl focus:border-teal-500 focus:outline-none">
                                <option value="">Choose Class</option>
                                <option value="1">Class 1</option>
                                <option value="2">Class 2</option>
                                <option value="3">Class 3</option>
                                <option value="4">Class 4</option>
                                <option value="5">Class 5</option>
                            </select>
                        </div>
                        <div class="bg-white rounded-2xl p-6 shadow-lg">
                            <label class="block text-lg font-bold text-cyan-600 mb-3">‚ûï Add New Subject</label>
                            <div class="flex gap-2">
                                <input type="text" id="newSubjectName" class="flex-1 p-3 border-2 border-cyan-300 rounded-xl focus:border-cyan-500 focus:outline-none" placeholder="Subject name">
                                <button id="addSubjectBtn" class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                                    ‚ûï
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="subjectListContainer" class="hidden bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-purple-600 mb-4">üìã Current Subjects (Drag to reorder)</h4>
                        <div id="subjectList" class="space-y-2">
                            <!-- Subject items will be dynamically added here -->
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="saveSubjectsBtn" class="bg-gradient-to-r from-teal-500 to-cyan-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üíæ Save Subject Order
                        </button>
                        <button id="cancelSubjectBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>

                <!-- Exam Types Management Form -->
                <div id="examTypesForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">üìù Configure Exam Types</h3>
                    
                    <div class="bg-gradient-to-br from-rose-100 to-pink-100 rounded-2xl p-6 shadow-lg border-2 border-rose-200 mb-6">
                        <div class="text-center mb-4">
                            <h4 class="text-lg font-bold text-rose-700">üí° Configure Exam Types</h4>
                            <p class="text-rose-600 text-sm">Choose which subjects should have oral exams, written exams, or both</p>
                        </div>
                        
                        <div class="bg-white rounded-xl p-4 shadow-lg">
                            <label class="block text-lg font-bold text-rose-600 mb-3">üéì Select Class</label>
                            <select id="examTypesClassSelect" class="w-full p-3 border-2 border-rose-300 rounded-xl focus:border-rose-500 focus:outline-none">
                                <option value="">Choose Class</option>
                                <option value="1">Class 1</option>
                                <option value="2">Class 2</option>
                                <option value="3">Class 3</option>
                                <option value="4">Class 4</option>
                                <option value="5">Class 5</option>
                            </select>
                        </div>
                    </div>

                    <div id="examTypesListContainer" class="hidden bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-rose-600 mb-4">üìã Configure Exam Types for Each Subject</h4>
                        <div id="examTypesList" class="space-y-4">
                            <!-- Exam types configuration will be dynamically added here -->
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="saveExamTypesBtn" class="bg-gradient-to-r from-rose-500 to-pink-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üíæ Save Exam Types
                        </button>
                        <button id="cancelExamTypesBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>

                <!-- Student Profile Management Form -->
                <div id="profileForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">üë§ Manage Student Profiles</h3>
                    
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <!-- Profile Fields Configuration -->
                        <div class="bg-gradient-to-br from-emerald-100 to-teal-100 rounded-2xl p-6 shadow-lg border-2 border-emerald-200">
                            <h4 class="text-lg font-bold text-emerald-700 mb-4">‚öôÔ∏è Configure Profile Fields</h4>
                            <p class="text-emerald-600 text-sm mb-4">Add custom profile fields that will be available for all students</p>
                            
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="newProfileField" class="flex-1 p-3 border-2 border-emerald-300 rounded-xl focus:border-emerald-500 focus:outline-none" placeholder="Enter field name (e.g., Date of Birth, Address)">
                                <button id="addProfileFieldBtn" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                                    ‚ûï
                                </button>
                            </div>
                            
                            <div class="bg-white rounded-xl p-4 shadow-lg">
                                <h5 class="text-md font-bold text-emerald-600 mb-3">üìã Available Profile Fields</h5>
                                <div id="profileFieldsList" class="space-y-2">
                                    <!-- Profile fields will be dynamically added here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Display Settings -->
                        <div class="bg-gradient-to-br from-teal-100 to-cyan-100 rounded-2xl p-6 shadow-lg border-2 border-teal-200">
                            <h4 class="text-lg font-bold text-teal-700 mb-4">üëÅÔ∏è Report Card Display Settings</h4>
                            <p class="text-teal-600 text-sm mb-4">Choose which profile fields to show on report cards</p>
                            
                            <div class="bg-white rounded-xl p-4 shadow-lg">
                                <h5 class="text-md font-bold text-teal-600 mb-3">‚úÖ Fields to Show on Report Card</h5>
                                <div id="displayFieldsList" class="space-y-2">
                                    <!-- Display settings will be dynamically added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student Profile Editor -->
                    <div class="bg-gradient-to-br from-cyan-100 to-blue-100 rounded-2xl p-6 shadow-lg border-2 border-cyan-200 mb-6">
                        <h4 class="text-lg font-bold text-cyan-700 mb-4">‚úèÔ∏è Edit Student Profile</h4>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-white rounded-xl p-4 shadow-lg">
                                <label class="block text-lg font-bold text-cyan-600 mb-3">üéì Select Class</label>
                                <select id="profileClassSelect" class="w-full p-3 border-2 border-cyan-300 rounded-xl focus:border-cyan-500 focus:outline-none">
                                    <option value="">Choose Class</option>
                                    <option value="1">Class 1</option>
                                    <option value="2">Class 2</option>
                                    <option value="3">Class 3</option>
                                    <option value="4">Class 4</option>
                                    <option value="5">Class 5</option>
                                </select>
                            </div>
                            
                            <div class="bg-white rounded-xl p-4 shadow-lg">
                                <label class="block text-lg font-bold text-blue-600 mb-3">üë¶ Select Student</label>
                                <select id="profileStudentSelect" class="w-full p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none" disabled>
                                    <option value="">Choose Student</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="studentProfileEditor" class="hidden bg-white rounded-xl p-6 shadow-lg">
                            <h5 class="text-lg font-bold text-blue-600 mb-4">üìù Student Profile Information</h5>
                            <div id="profileInputs" class="grid md:grid-cols-2 gap-4">
                                <!-- Profile input fields will be dynamically added here -->
                            </div>
                            
                            <div class="text-center mt-6">
                                <button id="saveStudentProfileBtn" class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                                    üíæ Save Profile
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="saveProfileSettingsBtn" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üíæ Save Profile Settings
                        </button>
                        <button id="cancelProfileBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>

                <!-- Student Marks Table -->
                <div id="studentMarksTable" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 id="studentMarksTableTitle" class="text-2xl font-bold text-white text-center mb-6">üìä Student Marks</h3>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white rounded-2xl shadow-lg overflow-hidden">
                            <thead class="bg-gradient-to-r from-purple-500 to-pink-600 text-white">
                                <tr>
                                    <th class="py-4 px-4 text-center font-bold text-lg">üìö Subject</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">üó£Ô∏è Oral Marks</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">‚úçÔ∏è Written Marks</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">üìù Total</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">üíØ Max Marks</th>
                                </tr>
                            </thead>
                            <tbody id="studentMarksTableBody">
                                <!-- Dynamic rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-center mt-6">
                        <button id="saveAllMarksBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üíæ Save All Marks
                        </button>
                    </div>
                    
                    <div id="saveMarksMessage" class="mt-4 text-center"></div>
                </div>

                <!-- Combined Terms Table -->
                <div id="combinedMarksTable" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 id="combinedMarksTableTitle" class="text-2xl font-bold text-white text-center mb-6">üìä Combined Terms - All Marks</h3>
                    
                    <div class="overflow-x-auto">
                        <div id="combinedMarksContent">
                            <!-- Dynamic combined table will be added here -->
                        </div>
                    </div>
                    
                    <div class="text-center mt-6">
                        <button id="saveCombinedMarksBtn" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            üíæ Save All Combined Marks
                        </button>
                    </div>
                    
                    <div id="saveCombinedMarksMessage" class="mt-4 text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Marquee -->
    <div class="marquee marquee-bottom">
        <div class="floating-shapes">
            <div class="shape w-8 h-8 bg-yellow-300 rounded-full"></div>
            <div class="shape w-6 h-6 bg-pink-300 transform rotate-45"></div>
            <div class="shape w-10 h-10 bg-green-300 rounded-full"></div>
            <div class="shape w-7 h-7 bg-blue-300 transform rotate-45"></div>
            <div class="shape w-9 h-9 bg-purple-300 rounded-full"></div>
            <div class="shape w-5 h-5 bg-red-300 transform rotate-45"></div>
            <div class="shape w-8 h-8 bg-indigo-300 rounded-full"></div>
            <div class="shape w-6 h-6 bg-orange-300 transform rotate-45"></div>
        </div>
        <div class="marquee-content text-lg">
            üíù This site is developed by Mr. Deepak Kumar Vaishya, Assistant Teacher at Primary School Karanpur, Behjam-Kheri and dedicated to the loving students..!! üíù
        </div>
    </div>

    <script>
        // Global message storage - now term-specific
        let termMessages = {
            "First Term": "üì¢ Dear Students! First Term examination results are now available. Check your performance and keep working hard for the upcoming terms! üåüüìö",
            "Second Term": "üì¢ Second Term results are ready! Keep up the excellent work and prepare for the final term! üåüüìö",
            "Final Term": "üì¢ Final Term results are here! Congratulations on completing the academic year! üéâüìö"
        };
        
        // Available terms for students (controlled by admin)
        let availableTerms = ["First Term"];
        
        // All terms in the system (including custom ones)
        let allTerms = ["First Term", "Second Term", "Final Term"];
        
        // Global subject configuration for each class
        let classSubjects = {
            "1": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"],
            "2": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"],
            "3": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"],
            "4": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"],
            "5": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"]
        };

        // Subject exam type configuration (oral, written, or both)
        let subjectExamTypes = {
            "1": {
                "HINDI": { hasOral: true, hasWritten: true },
                "ENGLISH": { hasOral: true, hasWritten: true },
                "MATHS": { hasOral: true, hasWritten: true },
                "EVS": { hasOral: true, hasWritten: true },
                "SANSKRIT": { hasOral: true, hasWritten: true }
            },
            "2": {
                "HINDI": { hasOral: true, hasWritten: true },
                "ENGLISH": { hasOral: true, hasWritten: true },
                "MATHS": { hasOral: true, hasWritten: true },
                "EVS": { hasOral: true, hasWritten: true },
                "SANSKRIT": { hasOral: true, hasWritten: true }
            },
            "3": {
                "HINDI": { hasOral: true, hasWritten: true },
                "ENGLISH": { hasOral: true, hasWritten: true },
                "MATHS": { hasOral: true, hasWritten: true },
                "EVS": { hasOral: true, hasWritten: true },
                "SANSKRIT": { hasOral: true, hasWritten: true }
            },
            "4": {
                "HINDI": { hasOral: true, hasWritten: true },
                "ENGLISH": { hasOral: true, hasWritten: true },
                "MATHS": { hasOral: true, hasWritten: true },
                "EVS": { hasOral: true, hasWritten: true },
                "SANSKRIT": { hasOral: true, hasWritten: true }
            },
            "5": {
                "HINDI": { hasOral: true, hasWritten: true },
                "ENGLISH": { hasOral: true, hasWritten: true },
                "MATHS": { hasOral: true, hasWritten: true },
                "EVS": { hasOral: true, hasWritten: true },
                "SANSKRIT": { hasOral: true, hasWritten: true }
            }
        };

        // Profile fields configuration
        let profileFields = [
            "Student Name",
            "Father's Name", 
            "Mother's Name",
            "Date of Birth",
            "Address",
            "Phone Number",
            "Roll Number",
            "Admission Number",
            "Blood Group",
            "Religion",
            "Category",
            "Previous School"
        ];

        // Fields to display on report card (admin configurable)
        let displayFields = [
            "Student Name",
            "Father's Name",
            "Roll Number",
            "Date of Birth"
        ];

        // Term-wise max marks configuration
        let termMaxMarks = {
            "First Term": { oral: 5, written: 15 },
            "Second Term": { oral: 5, written: 15 },
            "Final Term": { oral: 5, written: 15 }
        };

        // Sample data structure
        let studentsData = {
            "1": {
                "student1": {
                    name: "Aarav Sharma",
                    fatherName: "Rajesh Sharma",
                    class: "1",
                    profile: {
                        "Student Name": "Aarav Sharma",
                        "Father's Name": "Rajesh Sharma",
                        "Mother's Name": "Sunita Sharma",
                        "Date of Birth": "15/08/2015",
                        "Address": "Village Karanpur, Behjam",
                        "Phone Number": "9876543210",
                        "Roll Number": "001",
                        "Admission Number": "KP2023001",
                        "Blood Group": "B+",
                        "Religion": "Hindu",
                        "Category": "General",
                        "Previous School": "N/A"
                    },
                    marks: {
                        "First Term": {
                            "HINDI": { oral: 3, written: 7 },
                            "ENGLISH": { oral: 2, written: 6 },
                            "MATHS": { oral: 3, written: 7 }
                        },
                        "Second Term": {
                            "HINDI": { oral: 3, written: 7 },
                            "ENGLISH": { oral: "A", written: 6 },
                            "MATHS": { oral: 3, written: "A" },
                            "EVS": { oral: 2, written: 8 }
                        }
                    }
                },
                "student2": {
                    name: "Priya Singh",
                    fatherName: "Suresh Singh",
                    class: "1",
                    profile: {
                        "Student Name": "Priya Singh",
                        "Father's Name": "Suresh Singh",
                        "Mother's Name": "Kavita Singh",
                        "Date of Birth": "22/11/2015",
                        "Address": "Village Karanpur, Behjam",
                        "Phone Number": "9876543211",
                        "Roll Number": "002",
                        "Admission Number": "KP2023002",
                        "Blood Group": "A+",
                        "Religion": "Hindu",
                        "Category": "OBC",
                        "Previous School": "N/A"
                    },
                    marks: {
                        "First Term": {
                            "HINDI": { oral: 3, written: 8 },
                            "ENGLISH": { oral: 3, written: 7 }
                        }
                    }
                }
            },
            "2": {
                "student3": {
                    name: "Rohit Kumar",
                    fatherName: "Mohan Kumar",
                    class: "2",
                    profile: {
                        "Student Name": "Rohit Kumar",
                        "Father's Name": "Mohan Kumar",
                        "Mother's Name": "Geeta Kumar",
                        "Date of Birth": "10/05/2014",
                        "Address": "Village Karanpur, Behjam",
                        "Phone Number": "9876543212",
                        "Roll Number": "001",
                        "Admission Number": "KP2022001",
                        "Blood Group": "O+",
                        "Religion": "Hindu",
                        "Category": "SC",
                        "Previous School": "N/A"
                    },
                    marks: {
                        "First Term": {
                            "HINDI": { oral: 3, written: 8 },
                            "ENGLISH": { oral: 3, written: 9 },
                            "MATHS": { oral: 3, written: 9 }
                        }
                    }
                }
            }
        };

        // Admin password
        const ADMIN_PASSWORD = "admin123";
        let isAdminLoggedIn = false;
        let currentEditingStudent = null;

        // DOM Elements
        const studentTab = document.getElementById('studentTab');
        const adminTab = document.getElementById('adminTab');
        const studentPortal = document.getElementById('studentPortal');
        const adminPanel = document.getElementById('adminPanel');
        const adminLogin = document.getElementById('adminLogin');
        const adminDashboard = document.getElementById('adminDashboard');

        // Instant Alert Function
        function showInstantAlert(message, type = 'error') {
            const existingAlerts = document.querySelectorAll('.instant-alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `instant-alert ${type}`;
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.style.animation = 'alertPop 0.3s ease-out reverse';
                    setTimeout(() => {
                        alertDiv.remove();
                    }, 300);
                }
            }, 2000);
        }

        // Message display function
        function showMessage(element, message, type) {
            if (!element) return;
            
            element.innerHTML = message;
            element.className = `text-center mt-2 font-bold ${
                type === 'success' ? 'text-green-600' : 
                type === 'warning' ? 'text-yellow-600' : 
                'text-red-600'
            }`;
            
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }

        // Tab switching
        studentTab.addEventListener('click', () => {
            studentTab.className = "px-6 py-3 rounded-full bg-gradient-to-r from-pink-500 to-orange-500 text-white font-bold transition-all duration-300 hover:from-pink-600 hover:to-orange-600 shadow-lg";
            adminTab.className = "px-6 py-3 rounded-full text-gray-600 font-bold transition-all duration-300 hover:bg-gradient-to-r hover:from-blue-400 hover:to-purple-500 hover:text-white shadow-lg";
            studentPortal.classList.remove('hidden');
            adminPanel.classList.add('hidden');
        });

        adminTab.addEventListener('click', () => {
            adminTab.className = "px-6 py-3 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 text-white font-bold transition-all duration-300 hover:from-blue-500 hover:to-purple-600 shadow-lg";
            studentTab.className = "px-6 py-3 rounded-full text-gray-600 font-bold transition-all duration-300 hover:bg-gradient-to-r hover:from-pink-400 hover:to-orange-400 hover:text-white shadow-lg";
            studentPortal.classList.add('hidden');
            adminPanel.classList.remove('hidden');
        });

        // Student Portal Functions
        const classSelect = document.getElementById('classSelect');
        const termSelect = document.getElementById('termSelect');
        const studentSelect = document.getElementById('studentSelect');
        const reportCardDisplay = document.getElementById('reportCardDisplay');

        classSelect.addEventListener('change', function() {
            const selectedClass = this.value;
            termSelect.innerHTML = '<option value="">Choose Term</option>';
            studentSelect.innerHTML = '<option value="">Choose Student</option>';
            
            if (selectedClass) {
                termSelect.disabled = false;
                // Load available terms
                availableTerms.forEach(term => {
                    const option = document.createElement('option');
                    option.value = term;
                    option.textContent = term;
                    termSelect.appendChild(option);
                });
                
                // Load students for this class
                if (studentsData[selectedClass]) {
                    studentSelect.disabled = false;
                    Object.keys(studentsData[selectedClass]).forEach(studentId => {
                        const student = studentsData[selectedClass][studentId];
                        const option = document.createElement('option');
                        option.value = studentId;
                        option.textContent = student.name;
                        studentSelect.appendChild(option);
                    });
                }
            } else {
                termSelect.disabled = true;
                studentSelect.disabled = true;
                reportCardDisplay.classList.add('hidden');
            }
            
            // Update message display
            updateStudentMessage();
        });

        termSelect.addEventListener('change', function() {
            updateStudentMessage();
            if (this.value && classSelect.value && studentSelect.value) {
                displayReportCard(classSelect.value, studentSelect.value, this.value);
            } else {
                reportCardDisplay.classList.add('hidden');
            }
        });

        studentSelect.addEventListener('change', function() {
            if (this.value && classSelect.value && termSelect.value) {
                displayReportCard(classSelect.value, this.value, termSelect.value);
            } else {
                reportCardDisplay.classList.add('hidden');
            }
        });

        function updateStudentMessage() {
            const selectedTerm = termSelect.value;
            const messageContent = document.getElementById('studentMessageContent');
            
            if (selectedTerm && termMessages[selectedTerm]) {
                messageContent.textContent = termMessages[selectedTerm];
            } else {
                messageContent.textContent = "üì¢ Please select a term to view the message! üåü";
            }
        }

        function displayReportCard(classId, studentId, term) {
            const student = studentsData[classId][studentId];
            const marks = student.marks[term];
            
            if (!marks || Object.keys(marks).length === 0) {
                showInstantAlert('No marks found for this term! ‚ö†Ô∏è', 'warning');
                return;
            }

            // Filter subjects that have actual marks entered (not just default 0,0)
            const subjectsWithMarks = Object.keys(marks).filter(subject => {
                const subjectMarks = marks[subject];
                return (subjectMarks.oral !== 0 && subjectMarks.oral !== '') || 
                       (subjectMarks.written !== 0 && subjectMarks.written !== '') ||
                       subjectMarks.oral === 'A' || subjectMarks.written === 'A';
            });

            if (subjectsWithMarks.length === 0) {
                showInstantAlert('No marks have been entered for this term yet! ‚ö†Ô∏è', 'warning');
                return;
            }

            let totalMarks = 0;
            let maxTotalMarks = 0;
            let totalOralMarks = 0;
            let totalWrittenMarks = 0;
            let subjectsHTML = '';
            let absentSubjects = [];

            // Get max marks for this term
            const termMaxMark = termMaxMarks[term] || { oral: 5, written: 15 };
            const subjectMaxMarks = termMaxMark.oral + termMaxMark.written;

            // Only show subjects that have marks entered
            subjectsWithMarks.forEach(subject => {
                const subjectMarks = marks[subject];
                
                // Get exam type configuration for this subject
                const examConfig = subjectExamTypes[classId] && subjectExamTypes[classId][subject] 
                    ? subjectExamTypes[classId][subject] 
                    : { hasOral: true, hasWritten: true };
                
                // Calculate totals and check for absences based on exam configuration
                let oralMark = examConfig.hasOral ? subjectMarks.oral : 'N/A';
                let writtenMark = examConfig.hasWritten ? subjectMarks.written : 'N/A';
                let total = 0;
                let subjectMaxMarks = 0;
                
                // Calculate max marks based on exam configuration
                if (examConfig.hasOral) subjectMaxMarks += termMaxMark.oral;
                if (examConfig.hasWritten) subjectMaxMarks += termMaxMark.written;
                
                // Calculate totals based on what exams are configured
                if (examConfig.hasOral && examConfig.hasWritten) {
                    // Both oral and written
                    if (oralMark === 'A') {
                        absentSubjects.push(`${subject} (Oral)`);
                    } else if (oralMark !== '' && oralMark !== 'N/A') {
                        totalOralMarks += parseInt(oralMark) || 0;
                        total += parseInt(oralMark) || 0;
                    }
                    
                    if (writtenMark === 'A') {
                        absentSubjects.push(`${subject} (Written)`);
                    } else if (writtenMark !== '' && writtenMark !== 'N/A') {
                        totalWrittenMarks += parseInt(writtenMark) || 0;
                        total += parseInt(writtenMark) || 0;
                    }
                } else if (examConfig.hasOral && !examConfig.hasWritten) {
                    // Only oral
                    if (oralMark === 'A') {
                        absentSubjects.push(`${subject} (Oral)`);
                    } else if (oralMark !== '' && oralMark !== 'N/A') {
                        totalOralMarks += parseInt(oralMark) || 0;
                        total += parseInt(oralMark) || 0;
                    }
                } else if (!examConfig.hasOral && examConfig.hasWritten) {
                    // Only written
                    if (writtenMark === 'A') {
                        absentSubjects.push(`${subject} (Written)`);
                    } else if (writtenMark !== '' && writtenMark !== 'N/A') {
                        totalWrittenMarks += parseInt(writtenMark) || 0;
                        total += parseInt(writtenMark) || 0;
                    }
                }
                
                // Add to totals if not completely absent
                const isCompletelyAbsent = (examConfig.hasOral && examConfig.hasWritten && oralMark === 'A' && writtenMark === 'A') ||
                                         (examConfig.hasOral && !examConfig.hasWritten && oralMark === 'A') ||
                                         (!examConfig.hasOral && examConfig.hasWritten && writtenMark === 'A');
                
                if (!isCompletelyAbsent && total > 0) {
                    totalMarks += total;
                    maxTotalMarks += subjectMaxMarks;
                }

                const percentage = subjectMaxMarks > 0 && total > 0 ? ((total / subjectMaxMarks) * 100).toFixed(1) : '0.0';
                let grade = 'F';
                let gradeColor = 'text-red-600';
                
                if (isCompletelyAbsent) {
                    grade = 'AB';
                    gradeColor = 'text-gray-600';
                } else if (percentage >= 90) { grade = 'A+'; gradeColor = 'text-green-600'; }
                else if (percentage >= 80) { grade = 'A'; gradeColor = 'text-green-500'; }
                else if (percentage >= 70) { grade = 'B+'; gradeColor = 'text-blue-600'; }
                else if (percentage >= 60) { grade = 'B'; gradeColor = 'text-blue-500'; }
                else if (percentage >= 50) { grade = 'C'; gradeColor = 'text-yellow-600'; }
                else if (percentage >= 40) { grade = 'D'; gradeColor = 'text-orange-600'; }

                subjectsHTML += `
                    <tr class="border-b-2 border-gray-100 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-300">
                        <td class="py-4 px-4 font-bold text-purple-700 text-center">${subject}</td>
                        <td class="py-4 px-4 text-center font-semibold ${oralMark === 'A' ? 'text-red-600' : oralMark === 'N/A' ? 'text-gray-400' : 'text-blue-600'}">${oralMark}</td>
                        <td class="py-4 px-4 text-center font-semibold ${writtenMark === 'A' ? 'text-red-600' : writtenMark === 'N/A' ? 'text-gray-400' : 'text-green-600'}">${writtenMark}</td>
                        <td class="py-4 px-4 text-center font-bold text-indigo-700">${isCompletelyAbsent ? 'AB' : total}</td>
                        <td class="py-4 px-4 text-center font-semibold text-gray-600">${subjectMaxMarks}</td>
                        <td class="py-4 px-4 text-center font-semibold text-purple-600">${isCompletelyAbsent ? 'AB' : percentage + '%'}</td>
                    </tr>
                `;
            });

            const overallPercentage = maxTotalMarks > 0 ? ((totalMarks / maxTotalMarks) * 100).toFixed(1) : '0.0';
            let overallGrade = 'F';
            let overallGradeColor = 'text-red-600';
            
            if (overallPercentage >= 90) { overallGrade = 'A+'; overallGradeColor = 'text-green-600'; }
            else if (overallPercentage >= 80) { overallGrade = 'A'; overallGradeColor = 'text-green-500'; }
            else if (overallPercentage >= 70) { overallGrade = 'B+'; overallGradeColor = 'text-blue-600'; }
            else if (overallPercentage >= 60) { overallGrade = 'B'; overallGradeColor = 'text-blue-500'; }
            else if (overallPercentage >= 50) { overallGrade = 'C'; overallGradeColor = 'text-yellow-600'; }
            else if (overallPercentage >= 40) { overallGrade = 'D'; overallGradeColor = 'text-orange-600'; }

            const reportCardHTML = `
                <div class="bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-3xl p-8 shadow-2xl border-4 border-blue-300 relative overflow-hidden">
                    <div class="absolute top-4 left-4 text-3xl animate-bounce">üèÜ</div>
                    <div class="absolute top-4 right-4 text-3xl animate-bounce" style="animation-delay: 0.5s;">‚≠ê</div>
                    <div class="absolute bottom-4 left-4 text-2xl animate-bounce" style="animation-delay: 1s;">üìö</div>
                    <div class="absolute bottom-4 right-4 text-2xl animate-bounce" style="animation-delay: 1.5s;">üéâ</div>
                    
                    <div class="text-center mb-8">
                        <h3 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-6">üìã REPORT CARD üìã</h3>
                        
                        <!-- Student Profile Information -->
                        <div class="grid md:grid-cols-3 gap-4 mb-6">
                            ${generateProfileTiles(student, term)}
                        </div>
                    </div>

                    <div class="overflow-x-auto mb-6">
                        <table class="w-full bg-white rounded-2xl shadow-lg overflow-hidden">
                            <thead class="bg-gradient-to-r from-purple-500 to-pink-600 text-white">
                                <tr>
                                    <th class="py-4 px-4 text-center font-bold text-lg">üìö Subject</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">üó£Ô∏è Oral</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">‚úçÔ∏è Written</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">üìù Total</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">üíØ Max</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">üìä %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${subjectsHTML}
                                <tr class="bg-gradient-to-r from-yellow-100 to-orange-100 border-t-4 border-orange-300">
                                    <td class="py-4 px-4 font-bold text-orange-700 text-center text-lg">üèÜ TOTAL</td>
                                    <td class="py-4 px-4 text-center font-bold text-blue-700 text-lg">${totalOralMarks}</td>
                                    <td class="py-4 px-4 text-center font-bold text-green-700 text-lg">${totalWrittenMarks}</td>
                                    <td class="py-4 px-4 text-center font-bold text-orange-700 text-xl">${totalMarks}</td>
                                    <td class="py-4 px-4 text-center font-bold text-lg">${maxTotalMarks}</td>
                                    <td class="py-4 px-4 text-center font-bold text-orange-700 text-xl">${overallPercentage}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-gradient-to-r from-green-100 to-blue-100 rounded-2xl p-6 shadow-lg border-2 border-green-200">
                            <h5 class="text-xl font-bold text-green-700 mb-3">üìà Performance Summary</h5>
                            <div class="space-y-2">
                                <p class="font-semibold text-green-600">üéØ Overall Grade: <span class="${overallGradeColor} text-lg">${overallGrade}</span></p>
                                <p class="font-semibold text-blue-600">üìä Percentage: <span class="text-blue-700 text-lg">${overallPercentage}%</span></p>
                                <p class="font-semibold text-purple-600">üìö Subjects: <span class="text-purple-700">${Object.keys(marks).length}</span></p>
                                ${absentSubjects.length > 0 ? `<p class="font-semibold text-red-600">‚ö†Ô∏è Absent in: <span class="text-red-700">${absentSubjects.length} exam(s)</span></p>` : ''}
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl p-6 shadow-lg border-2 border-purple-200">
                            <h5 class="text-xl font-bold text-purple-700 mb-3">üí¨ Teacher's Remarks</h5>
                            <p class="text-purple-600 font-semibold">
                                ${absentSubjects.length > 0 ? '‚ö†Ô∏è Please ensure regular attendance for all examinations. ' : ''}
                                ${overallPercentage >= 90 ? 'üåü Excellent performance! Keep up the outstanding work!' :
                                  overallPercentage >= 80 ? 'üëè Very good work! Continue your efforts!' :
                                  overallPercentage >= 70 ? 'üëç Good progress! Keep improving!' :
                                  overallPercentage >= 60 ? 'üìö Satisfactory work. Focus on weak areas!' :
                                  overallPercentage >= 40 ? '‚ö†Ô∏è Needs improvement. Work harder!' :
                                  'üîÑ Requires significant effort. Please study more!'}
                            </p>
                        </div>
                    </div>
                    
                    ${absentSubjects.length > 0 ? `
                    <div class="bg-gradient-to-r from-red-100 to-orange-100 rounded-2xl p-6 shadow-lg border-2 border-red-200 mt-6">
                        <h5 class="text-xl font-bold text-red-700 mb-3">‚ö†Ô∏è Absence Details</h5>
                        <div class="bg-white rounded-xl p-4">
                            <p class="text-red-600 font-semibold mb-2">Student was absent in the following examinations:</p>
                            <ul class="list-disc list-inside space-y-1">
                                ${absentSubjects.map(subject => `<li class="text-red-700 font-medium">üìù ${subject}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    ` : ''}

                    <div class="text-center mt-6">
                        <div class="bg-gradient-to-r from-blue-100 to-purple-100 rounded-2xl p-4 border-2 border-blue-200">
                            <p class="text-blue-700 font-bold text-lg">üéâ Great job! Keep up the excellent work! üåü</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('reportCardContent').innerHTML = reportCardHTML;
            reportCardDisplay.classList.remove('hidden');
            reportCardDisplay.scrollIntoView({ behavior: 'smooth' });
        }

        // Admin Functions
        document.getElementById('adminLoginBtn').addEventListener('click', function() {
            const password = document.getElementById('adminPassword').value;
            const loginMessage = document.getElementById('loginMessage');
            
            if (password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                adminLogin.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                showInstantAlert('Welcome Admin! üéâ', 'success');
            } else {
                showMessage(loginMessage, 'Incorrect password! ‚ùå', 'error');
                document.getElementById('adminPassword').value = '';
            }
        });

        // Admin class selection
        document.getElementById('adminClassSelect').addEventListener('change', function() {
            const selectedClass = this.value;
            const adminTermSelect = document.getElementById('adminTermSelect');
            const adminStudentSelect = document.getElementById('adminStudentSelect');
            
            // Reset dependent selectors
            adminTermSelect.innerHTML = '<option value="">Choose Term</option>';
            adminStudentSelect.innerHTML = '<option value="">Choose Student</option>';
            
            if (selectedClass) {
                // Enable term selector and load all terms
                adminTermSelect.disabled = false;
                adminTermSelect.innerHTML = '<option value="">Choose Term</option>';
                adminTermSelect.innerHTML += '<option value="Combined Terms">üìä Combined Terms (All)</option>';
                
                allTerms.forEach(term => {
                    const option = document.createElement('option');
                    option.value = term;
                    option.textContent = term;
                    adminTermSelect.appendChild(option);
                });
                
                // Load students for this class
                if (studentsData[selectedClass]) {
                    adminStudentSelect.disabled = false;
                    Object.keys(studentsData[selectedClass]).forEach(studentId => {
                        const student = studentsData[selectedClass][studentId];
                        const option = document.createElement('option');
                        option.value = studentId;
                        option.textContent = student.name;
                        adminStudentSelect.appendChild(option);
                    });
                }
            } else {
                adminTermSelect.disabled = true;
                adminStudentSelect.disabled = true;
            }
            
            hideStudentMarksTable();
            hideCombinedMarksTable();
        });

        // Admin term selection
        document.getElementById('adminTermSelect').addEventListener('change', function() {
            const selectedTerm = this.value;
            
            if (selectedTerm && selectedTerm !== 'Combined Terms') {
                // Show max marks configuration for individual terms
                document.getElementById('maxMarksConfig').classList.remove('hidden');
                
                // Load current max marks for this term
                const currentMaxMarks = termMaxMarks[selectedTerm] || { oral: 5, written: 15 };
                document.getElementById('maxOralMarks').value = currentMaxMarks.oral;
                document.getElementById('maxWrittenMarks').value = currentMaxMarks.written;
            } else {
                document.getElementById('maxMarksConfig').classList.add('hidden');
            }
            
            hideStudentMarksTable();
            hideCombinedMarksTable();
        });

        // Admin student selection
        document.getElementById('adminStudentSelect').addEventListener('change', function() {
            const selectedTerm = document.getElementById('adminTermSelect').value;
            
            if (this.value && selectedTerm) {
                if (selectedTerm === 'Combined Terms') {
                    showCombinedMarksTable();
                } else {
                    showStudentMarksTable();
                }
            } else {
                hideStudentMarksTable();
                hideCombinedMarksTable();
            }
        });

        // Add Student Button
        document.getElementById('addStudentBtn').addEventListener('click', function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            if (!selectedClass) {
                showInstantAlert('Please select a class first! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            currentEditingStudent = null;
            document.getElementById('studentName').value = '';
            document.getElementById('fatherName').value = '';
            document.getElementById('studentForm').classList.remove('hidden');
            document.getElementById('studentForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Save Student Button
        document.getElementById('saveStudentBtn').addEventListener('click', function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            const studentName = document.getElementById('studentName').value.trim();
            const fatherName = document.getElementById('fatherName').value.trim();
            
            if (!selectedClass) {
                showInstantAlert('Please select a class! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            if (!studentName || !fatherName) {
                showInstantAlert('Please fill all fields! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            // Initialize class if it doesn't exist
            if (!studentsData[selectedClass]) {
                studentsData[selectedClass] = {};
            }
            
            // Generate student ID
            const studentId = currentEditingStudent || `student${Date.now()}`;
            
            // Create student object
            studentsData[selectedClass][studentId] = {
                name: studentName,
                fatherName: fatherName,
                class: selectedClass,
                profile: {
                    "Student Name": studentName,
                    "Father's Name": fatherName
                },
                marks: {}
            };
            
            // Initialize profile with default values for other fields
            profileFields.forEach(field => {
                if (!studentsData[selectedClass][studentId].profile[field]) {
                    studentsData[selectedClass][studentId].profile[field] = '';
                }
            });
            
            // Refresh admin student selector
            const adminStudentSelect = document.getElementById('adminStudentSelect');
            adminStudentSelect.innerHTML = '<option value="">Choose Student</option>';
            Object.keys(studentsData[selectedClass]).forEach(id => {
                const student = studentsData[selectedClass][id];
                const option = document.createElement('option');
                option.value = id;
                option.textContent = student.name;
                adminStudentSelect.appendChild(option);
            });
            
            // Hide form and show success message
            document.getElementById('studentForm').classList.add('hidden');
            showInstantAlert('Student saved successfully! ‚úÖ', 'success');
            
            // Clear form
            document.getElementById('studentName').value = '';
            document.getElementById('fatherName').value = '';
            currentEditingStudent = null;
        });

        // Cancel Form Button
        document.getElementById('cancelFormBtn').addEventListener('click', function() {
            document.getElementById('studentForm').classList.add('hidden');
            document.getElementById('studentName').value = '';
            document.getElementById('fatherName').value = '';
            currentEditingStudent = null;
        });

        // Delete Student Button
        document.getElementById('deleteStudentBtn').addEventListener('click', function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            const selectedStudent = document.getElementById('adminStudentSelect').value;
            
            if (!selectedClass || !selectedStudent) {
                showInstantAlert('Please select a class and student! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            const student = studentsData[selectedClass][selectedStudent];
            if (confirm(`Are you sure you want to delete ${student.name}?`)) {
                delete studentsData[selectedClass][selectedStudent];
                
                // Refresh student selector
                const adminStudentSelect = document.getElementById('adminStudentSelect');
                adminStudentSelect.innerHTML = '<option value="">Choose Student</option>';
                Object.keys(studentsData[selectedClass]).forEach(id => {
                    const student = studentsData[selectedClass][id];
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = student.name;
                    adminStudentSelect.appendChild(option);
                });
                
                hideStudentMarksTable();
                showInstantAlert('Student deleted successfully! ‚úÖ', 'success');
            }
        });

        // Manage Terms Button
        document.getElementById('manageTermsBtn').addEventListener('click', function() {
            displayTermList();
            document.getElementById('termForm').classList.remove('hidden');
            document.getElementById('termForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Save Max Marks Button
        document.getElementById('saveMaxMarksBtn').addEventListener('click', function() {
            const selectedTerm = document.getElementById('adminTermSelect').value;
            const maxOral = parseInt(document.getElementById('maxOralMarks').value);
            const maxWritten = parseInt(document.getElementById('maxWrittenMarks').value);
            
            if (!selectedTerm || selectedTerm === 'Combined Terms') {
                showInstantAlert('Please select a valid term! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            if (!maxOral || !maxWritten || maxOral < 1 || maxWritten < 1) {
                showInstantAlert('Please enter valid max marks! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            // Update max marks for this term
            termMaxMarks[selectedTerm] = { oral: maxOral, written: maxWritten };
            
            showInstantAlert(`Max marks updated for ${selectedTerm}! ‚úÖ`, 'success');
        });

        // Add Term Button
        document.getElementById('addTermBtn').addEventListener('click', function() {
            const newTerm = document.getElementById('newTermName').value.trim();
            
            if (!newTerm) {
                showInstantAlert('Please enter a term name! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            if (allTerms.includes(newTerm)) {
                showInstantAlert('Term already exists! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            allTerms.push(newTerm);
            
            // Initialize term message and max marks
            if (!termMessages[newTerm]) {
                termMessages[newTerm] = `üì¢ Dear Students! ${newTerm} examination results are now available. Check your performance and keep working hard! üåüüìö`;
            }
            
            if (!termMaxMarks[newTerm]) {
                termMaxMarks[newTerm] = { oral: 5, written: 15 };
            }
            
            document.getElementById('newTermName').value = '';
            displayTermList();
            refreshMessageTermSelect();
            showInstantAlert('Term added successfully! ‚úÖ', 'success');
        });

        // Save Terms Button
        document.getElementById('saveTermsBtn').addEventListener('click', function() {
            document.getElementById('termForm').classList.add('hidden');
            showInstantAlert('Terms saved successfully! ‚úÖ', 'success');
        });

        // Cancel Term Button
        document.getElementById('cancelTermBtn').addEventListener('click', function() {
            document.getElementById('termForm').classList.add('hidden');
        });

        // Compose Message Button
        document.getElementById('composeMessageBtn').addEventListener('click', function() {
            refreshMessageTermSelect();
            document.getElementById('messageForm').classList.remove('hidden');
            document.getElementById('messageForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Message Term Selection
        document.getElementById('messageTermSelect').addEventListener('change', function() {
            const selectedTerm = this.value;
            const messageTextarea = document.getElementById('studentMessage');
            const makeAvailableCheckbox = document.getElementById('makeTermAvailable');
            
            if (selectedTerm) {
                messageTextarea.value = termMessages[selectedTerm] || '';
                makeAvailableCheckbox.checked = availableTerms.includes(selectedTerm);
            } else {
                messageTextarea.value = '';
                makeAvailableCheckbox.checked = false;
            }
        });

        // Save Message Button
        document.getElementById('saveMessageBtn').addEventListener('click', function() {
            const selectedTerm = document.getElementById('messageTermSelect').value;
            const newMessage = document.getElementById('studentMessage').value.trim();
            const makeAvailable = document.getElementById('makeTermAvailable').checked;
            
            if (!selectedTerm) {
                showInstantAlert('Please select a term! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            if (!newMessage) {
                showInstantAlert('Please enter a message! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            // Update term message
            termMessages[selectedTerm] = newMessage;
            
            // Update available terms
            if (makeAvailable && !availableTerms.includes(selectedTerm)) {
                availableTerms.push(selectedTerm);
            } else if (!makeAvailable && availableTerms.includes(selectedTerm)) {
                availableTerms = availableTerms.filter(term => term !== selectedTerm);
            }
            
            // Refresh student portal term selector if class is selected
            const studentClassSelect = document.getElementById('classSelect');
            if (studentClassSelect.value) {
                const studentTermSelect = document.getElementById('termSelect');
                const currentSelection = studentTermSelect.value;
                studentTermSelect.innerHTML = '<option value="">Choose Term</option>';
                
                availableTerms.forEach(term => {
                    const option = document.createElement('option');
                    option.value = term;
                    option.textContent = term;
                    studentTermSelect.appendChild(option);
                });
                
                // Restore selection if still available
                if (availableTerms.includes(currentSelection)) {
                    studentTermSelect.value = currentSelection;
                }
                
                updateStudentMessage();
            }
            
            document.getElementById('messageForm').classList.add('hidden');
            showInstantAlert(`Message for ${selectedTerm} updated successfully! ‚úÖ`, 'success');
        });

        // Cancel Message Button
        document.getElementById('cancelMessageBtn').addEventListener('click', function() {
            document.getElementById('messageForm').classList.add('hidden');
        });

        // Manage Subjects Button
        document.getElementById('manageSubjectsBtn').addEventListener('click', function() {
            document.getElementById('subjectForm').classList.remove('hidden');
            document.getElementById('subjectForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Manage Exam Types Button
        document.getElementById('manageExamTypesBtn').addEventListener('click', function() {
            document.getElementById('examTypesForm').classList.remove('hidden');
            document.getElementById('examTypesForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Subject Class Selection
        document.getElementById('subjectClassSelect').addEventListener('change', function() {
            const selectedClass = this.value;
            if (selectedClass) {
                displaySubjectList(selectedClass);
                document.getElementById('subjectListContainer').classList.remove('hidden');
            } else {
                document.getElementById('subjectListContainer').classList.add('hidden');
            }
        });

        // Add Subject Button
        document.getElementById('addSubjectBtn').addEventListener('click', function() {
            const selectedClass = document.getElementById('subjectClassSelect').value;
            const newSubject = document.getElementById('newSubjectName').value.trim().toUpperCase();
            
            if (!selectedClass) {
                showInstantAlert('Please select a class first! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            if (!newSubject) {
                showInstantAlert('Please enter a subject name! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            if (classSubjects[selectedClass].includes(newSubject)) {
                showInstantAlert('Subject already exists! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            classSubjects[selectedClass].push(newSubject);
            
            // Initialize exam types for the new subject (default: both oral and written)
            if (!subjectExamTypes[selectedClass]) {
                subjectExamTypes[selectedClass] = {};
            }
            subjectExamTypes[selectedClass][newSubject] = { hasOral: true, hasWritten: true };
            
            document.getElementById('newSubjectName').value = '';
            displaySubjectList(selectedClass);
            showInstantAlert('Subject added successfully! ‚úÖ', 'success');
        });

        // Save Subjects Button
        document.getElementById('saveSubjectsBtn').addEventListener('click', function() {
            document.getElementById('subjectForm').classList.add('hidden');
            showInstantAlert('Subject order saved successfully! ‚úÖ', 'success');
        });

        // Cancel Subject Button
        document.getElementById('cancelSubjectBtn').addEventListener('click', function() {
            document.getElementById('subjectForm').classList.add('hidden');
        });

        // Exam Types Class Selection
        document.getElementById('examTypesClassSelect').addEventListener('change', function() {
            const selectedClass = this.value;
            if (selectedClass) {
                displayExamTypesList(selectedClass);
                document.getElementById('examTypesListContainer').classList.remove('hidden');
            } else {
                document.getElementById('examTypesListContainer').classList.add('hidden');
            }
        });

        // Save Exam Types Button
        document.getElementById('saveExamTypesBtn').addEventListener('click', function() {
            document.getElementById('examTypesForm').classList.add('hidden');
            showInstantAlert('Exam types saved successfully! ‚úÖ', 'success');
        });

        // Cancel Exam Types Button
        document.getElementById('cancelExamTypesBtn').addEventListener('click', function() {
            document.getElementById('examTypesForm').classList.add('hidden');
        });

        // Manage Profiles Button
        document.getElementById('manageProfilesBtn').addEventListener('click', function() {
            displayProfileFields();
            displayDisplayFields();
            document.getElementById('profileForm').classList.remove('hidden');
            document.getElementById('profileForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Add Profile Field Button
        document.getElementById('addProfileFieldBtn').addEventListener('click', function() {
            const newField = document.getElementById('newProfileField').value.trim();
            
            if (!newField) {
                showInstantAlert('Please enter a field name! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            if (profileFields.includes(newField)) {
                showInstantAlert('Field already exists! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            profileFields.push(newField);
            document.getElementById('newProfileField').value = '';
            displayProfileFields();
            displayDisplayFields();
            showInstantAlert('Profile field added successfully! ‚úÖ', 'success');
        });

        // Profile Class Selection
        document.getElementById('profileClassSelect').addEventListener('change', function() {
            const selectedClass = this.value;
            const profileStudentSelect = document.getElementById('profileStudentSelect');
            
            profileStudentSelect.innerHTML = '<option value="">Choose Student</option>';
            
            if (selectedClass && studentsData[selectedClass]) {
                profileStudentSelect.disabled = false;
                Object.keys(studentsData[selectedClass]).forEach(studentId => {
                    const student = studentsData[selectedClass][studentId];
                    const option = document.createElement('option');
                    option.value = studentId;
                    option.textContent = student.name;
                    profileStudentSelect.appendChild(option);
                });
            } else {
                profileStudentSelect.disabled = true;
            }
            
            document.getElementById('studentProfileEditor').classList.add('hidden');
        });

        // Profile Student Selection
        document.getElementById('profileStudentSelect').addEventListener('change', function() {
            const selectedClass = document.getElementById('profileClassSelect').value;
            const selectedStudent = this.value;
            
            if (selectedClass && selectedStudent) {
                displayStudentProfileEditor(selectedClass, selectedStudent);
            } else {
                document.getElementById('studentProfileEditor').classList.add('hidden');
            }
        });

        // Save Student Profile Button
        document.getElementById('saveStudentProfileBtn').addEventListener('click', function() {
            const selectedClass = document.getElementById('profileClassSelect').value;
            const selectedStudent = document.getElementById('profileStudentSelect').value;
            
            if (!selectedClass || !selectedStudent) {
                showInstantAlert('Please select class and student! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            const student = studentsData[selectedClass][selectedStudent];
            if (!student.profile) {
                student.profile = {};
            }
            
            // Save all profile field values
            profileFields.forEach(field => {
                const input = document.getElementById(`profile-${field.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (input) {
                    student.profile[field] = input.value.trim();
                }
            });
            
            showInstantAlert('Student profile saved successfully! ‚úÖ', 'success');
        });

        // Save Profile Settings Button
        document.getElementById('saveProfileSettingsBtn').addEventListener('click', function() {
            document.getElementById('profileForm').classList.add('hidden');
            showInstantAlert('Profile settings saved successfully! ‚úÖ', 'success');
        });

        // Cancel Profile Button
        document.getElementById('cancelProfileBtn').addEventListener('click', function() {
            document.getElementById('profileForm').classList.add('hidden');
        });

        function displaySubjectList(classId) {
            const subjectList = document.getElementById('subjectList');
            subjectList.innerHTML = '';
            
            classSubjects[classId].forEach((subject, index) => {
                const subjectItem = document.createElement('div');
                subjectItem.className = 'subject-item bg-gradient-to-r from-purple-100 to-pink-100 p-4 rounded-xl border-2 border-purple-200 flex items-center justify-between shadow-lg';
                subjectItem.draggable = true;
                subjectItem.dataset.subject = subject;
                subjectItem.dataset.index = index;
                
                subjectItem.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üìö</span>
                        <span class="font-bold text-purple-700">${subject}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-500 text-sm">üîÑ Drag to reorder</span>
                        <button onclick="removeSubject('${classId}', '${subject}')" class="bg-red-500 text-white px-3 py-1 rounded-lg font-bold hover:bg-red-600 transition-all duration-300">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
                
                // Add drag and drop event listeners
                subjectItem.addEventListener('dragstart', handleDragStart);
                subjectItem.addEventListener('dragover', handleDragOver);
                subjectItem.addEventListener('drop', handleDrop);
                subjectItem.addEventListener('dragend', handleDragEnd);
                
                subjectList.appendChild(subjectItem);
            });
        }

        function displayExamTypesList(classId) {
            const examTypesList = document.getElementById('examTypesList');
            examTypesList.innerHTML = '';
            
            // Initialize exam types for this class if not exists
            if (!subjectExamTypes[classId]) {
                subjectExamTypes[classId] = {};
                classSubjects[classId].forEach(subject => {
                    subjectExamTypes[classId][subject] = { hasOral: true, hasWritten: true };
                });
            }
            
            classSubjects[classId].forEach(subject => {
                // Ensure subject exists in exam types
                if (!subjectExamTypes[classId][subject]) {
                    subjectExamTypes[classId][subject] = { hasOral: true, hasWritten: true };
                }
                
                const examConfig = subjectExamTypes[classId][subject];
                
                const examTypeItem = document.createElement('div');
                examTypeItem.className = 'bg-gradient-to-r from-rose-100 to-pink-100 p-4 rounded-xl border-2 border-rose-200 shadow-lg';
                
                examTypeItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üìö</span>
                            <span class="font-bold text-rose-700 text-lg">${subject}</span>
                        </div>
                        <div class="flex items-center gap-6">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" ${examConfig.hasOral ? 'checked' : ''} 
                                       onchange="updateExamType('${classId}', '${subject}', 'hasOral', this.checked)"
                                       class="w-5 h-5 text-blue-600 border-2 border-blue-300 rounded focus:ring-blue-500 mr-2">
                                <span class="font-semibold text-blue-700">üó£Ô∏è Oral Exam</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" ${examConfig.hasWritten ? 'checked' : ''} 
                                       onchange="updateExamType('${classId}', '${subject}', 'hasWritten', this.checked)"
                                       class="w-5 h-5 text-green-600 border-2 border-green-300 rounded focus:ring-green-500 mr-2">
                                <span class="font-semibold text-green-700">‚úçÔ∏è Written Exam</span>
                            </label>
                        </div>
                    </div>
                    <div class="mt-3 text-sm text-rose-600">
                        <span class="font-semibold">Current Configuration: </span>
                        ${examConfig.hasOral && examConfig.hasWritten ? 'üó£Ô∏è Oral + ‚úçÔ∏è Written' :
                          examConfig.hasOral ? 'üó£Ô∏è Oral Only' :
                          examConfig.hasWritten ? '‚úçÔ∏è Written Only' :
                          '‚ùå No Exams (Invalid)'}
                    </div>
                `;
                
                examTypesList.appendChild(examTypeItem);
            });
        }

        function updateExamType(classId, subject, type, value) {
            if (!subjectExamTypes[classId]) {
                subjectExamTypes[classId] = {};
            }
            if (!subjectExamTypes[classId][subject]) {
                subjectExamTypes[classId][subject] = { hasOral: true, hasWritten: true };
            }
            
            subjectExamTypes[classId][subject][type] = value;
            
            // Ensure at least one exam type is selected
            const config = subjectExamTypes[classId][subject];
            if (!config.hasOral && !config.hasWritten) {
                showInstantAlert('At least one exam type must be selected! ‚ö†Ô∏è', 'warning');
                // Revert the change
                subjectExamTypes[classId][subject][type] = true;
                // Refresh the display
                displayExamTypesList(classId);
                return;
            }
            
            // Refresh the display to show updated configuration
            displayExamTypesList(classId);
        }

        function displayProfileFields() {
            const profileFieldsList = document.getElementById('profileFieldsList');
            profileFieldsList.innerHTML = '';
            
            profileFields.forEach((field, index) => {
                const fieldItem = document.createElement('div');
                fieldItem.className = 'bg-gradient-to-r from-emerald-100 to-teal-100 p-3 rounded-xl border-2 border-emerald-200 flex items-center justify-between shadow-lg';
                
                fieldItem.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-lg mr-3">üìù</span>
                        <span class="font-bold text-emerald-700">${field}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        ${!['Student Name', 'Father\'s Name'].includes(field) ? `
                            <button onclick="deleteProfileField('${field}')" class="bg-red-500 text-white px-2 py-1 rounded-lg font-bold hover:bg-red-600 transition-all duration-300 text-sm">
                                üóëÔ∏è Delete
                            </button>
                        ` : `
                            <span class="text-xs text-gray-500 font-semibold">Required Field</span>
                        `}
                    </div>
                `;
                
                profileFieldsList.appendChild(fieldItem);
            });
        }

        function displayDisplayFields() {
            const displayFieldsList = document.getElementById('displayFieldsList');
            displayFieldsList.innerHTML = '';
            
            profileFields.forEach(field => {
                const fieldItem = document.createElement('div');
                fieldItem.className = 'bg-gradient-to-r from-teal-100 to-cyan-100 p-3 rounded-xl border-2 border-teal-200 flex items-center justify-between shadow-lg';
                
                const isDisplayed = displayFields.includes(field);
                
                fieldItem.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-lg mr-3">${isDisplayed ? '‚úÖ' : '‚ùå'}</span>
                        <span class="font-bold text-teal-700">${field}</span>
                    </div>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" ${isDisplayed ? 'checked' : ''} 
                               onchange="toggleDisplayField('${field}', this.checked)"
                               class="w-5 h-5 text-teal-600 border-2 border-teal-300 rounded focus:ring-teal-500 mr-2">
                        <span class="font-semibold text-teal-700">Show on Report</span>
                    </label>
                `;
                
                displayFieldsList.appendChild(fieldItem);
            });
        }

        function displayStudentProfileEditor(classId, studentId) {
            const student = studentsData[classId][studentId];
            const profileInputs = document.getElementById('profileInputs');
            
            // Initialize profile if it doesn't exist
            if (!student.profile) {
                student.profile = {};
                profileFields.forEach(field => {
                    if (field === 'Student Name') {
                        student.profile[field] = student.name;
                    } else if (field === 'Father\'s Name') {
                        student.profile[field] = student.fatherName;
                    } else {
                        student.profile[field] = '';
                    }
                });
            }
            
            profileInputs.innerHTML = '';
            
            profileFields.forEach(field => {
                const fieldId = `profile-${field.replace(/[^a-zA-Z0-9]/g, '')}`;
                const value = student.profile[field] || '';
                
                const inputDiv = document.createElement('div');
                inputDiv.className = 'bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-4 shadow-lg border-2 border-blue-200';
                
                inputDiv.innerHTML = `
                    <label class="block text-sm font-bold text-blue-600 mb-2">üìù ${field}</label>
                    <input type="text" id="${fieldId}" value="${value}" 
                           class="w-full p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none"
                           placeholder="Enter ${field.toLowerCase()}">
                `;
                
                profileInputs.appendChild(inputDiv);
            });
            
            document.getElementById('studentProfileEditor').classList.remove('hidden');
        }

        function deleteProfileField(field) {
            if (['Student Name', 'Father\'s Name'].includes(field)) {
                showInstantAlert('Cannot delete required fields! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            if (confirm(`‚ö†Ô∏è Are you sure you want to delete "${field}"?\n\nThis will permanently remove this field from all student profiles and cannot be undone!`)) {
                // Remove from profile fields array
                profileFields = profileFields.filter(f => f !== field);
                
                // Remove from display fields array
                displayFields = displayFields.filter(f => f !== field);
                
                // Remove from all student profiles across all classes
                Object.keys(studentsData).forEach(classId => {
                    Object.keys(studentsData[classId]).forEach(studentId => {
                        if (studentsData[classId][studentId].profile && studentsData[classId][studentId].profile[field]) {
                            delete studentsData[classId][studentId].profile[field];
                        }
                    });
                });
                
                // Refresh the displays
                displayProfileFields();
                displayDisplayFields();
                
                // If student profile editor is open, refresh it
                const profileClassSelect = document.getElementById('profileClassSelect');
                const profileStudentSelect = document.getElementById('profileStudentSelect');
                if (profileClassSelect.value && profileStudentSelect.value) {
                    displayStudentProfileEditor(profileClassSelect.value, profileStudentSelect.value);
                }
                
                showInstantAlert(`Profile field "${field}" deleted successfully! ‚úÖ`, 'success');
            }
        }

        function removeProfileField(field) {
            // Keep this function for backward compatibility, but redirect to deleteProfileField
            deleteProfileField(field);
        }

        function toggleDisplayField(field, show) {
            if (show && !displayFields.includes(field)) {
                displayFields.push(field);
            } else if (!show && displayFields.includes(field)) {
                displayFields = displayFields.filter(f => f !== field);
            }
            
            displayDisplayFields();
        }

        function generateProfileTiles(student, term) {
            const colors = [
                'from-blue-100 to-cyan-100 border-blue-200 text-blue-800 text-blue-900',
                'from-green-100 to-teal-100 border-green-200 text-green-800 text-green-900',
                'from-purple-100 to-pink-100 border-purple-200 text-purple-800 text-purple-900',
                'from-orange-100 to-yellow-100 border-orange-200 text-orange-800 text-orange-900',
                'from-red-100 to-pink-100 border-red-200 text-red-800 text-red-900',
                'from-indigo-100 to-purple-100 border-indigo-200 text-indigo-800 text-indigo-900',
                'from-teal-100 to-cyan-100 border-teal-200 text-teal-800 text-teal-900',
                'from-rose-100 to-pink-100 border-rose-200 text-rose-800 text-rose-900'
            ];
            
            const icons = {
                'Student Name': 'üë¶',
                'Father\'s Name': 'üë®',
                'Mother\'s Name': 'üë©',
                'Date of Birth': 'üìÖ',
                'Address': 'üè†',
                'Phone Number': 'üìû',
                'Roll Number': 'üî¢',
                'Admission Number': 'üìã',
                'Blood Group': 'ü©∏',
                'Religion': 'üïâÔ∏è',
                'Category': 'üìä',
                'Previous School': 'üè´'
            };
            
            let tilesHTML = '';
            let colorIndex = 0;
            
            // Add Term tile first
            const termColors = colors[colorIndex % colors.length].split(' ');
            tilesHTML += `
                <div class="bg-gradient-to-br ${termColors[0]} ${termColors[1]} rounded-2xl p-4 shadow-lg border-2 ${termColors[2]} transform hover:scale-105 transition-all duration-300">
                    <div class="text-2xl mb-2">üìÖ</div>
                    <h4 class="text-lg font-bold ${termColors[3]} mb-1">Term</h4>
                    <p class="text-xl font-bold ${termColors[4]}">${term}</p>
                </div>
            `;
            colorIndex++;
            
            // Add Class tile
            const classColors = colors[colorIndex % colors.length].split(' ');
            tilesHTML += `
                <div class="bg-gradient-to-br ${classColors[0]} ${classColors[1]} rounded-2xl p-4 shadow-lg border-2 ${classColors[2]} transform hover:scale-105 transition-all duration-300">
                    <div class="text-2xl mb-2">üéì</div>
                    <h4 class="text-lg font-bold ${classColors[3]} mb-1">Class</h4>
                    <p class="text-xl font-bold ${classColors[4]}">${student.class}</p>
                </div>
            `;
            colorIndex++;
            
            // Add profile fields that are set to display
            displayFields.forEach(field => {
                if (student.profile && student.profile[field]) {
                    const fieldColors = colors[colorIndex % colors.length].split(' ');
                    const icon = icons[field] || 'üìù';
                    const value = student.profile[field];
                    
                    tilesHTML += `
                        <div class="bg-gradient-to-br ${fieldColors[0]} ${fieldColors[1]} rounded-2xl p-4 shadow-lg border-2 ${fieldColors[2]} transform hover:scale-105 transition-all duration-300">
                            <div class="text-2xl mb-2">${icon}</div>
                            <h4 class="text-lg font-bold ${fieldColors[3]} mb-1">${field}</h4>
                            <p class="text-xl font-bold ${fieldColors[4]}">${value}</p>
                        </div>
                    `;
                    colorIndex++;
                }
            });
            
            return tilesHTML;
        }

        function removeSubject(classId, subject) {
            if (classSubjects[classId].length <= 1) {
                showInstantAlert('Cannot remove the last subject! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            if (confirm(`Are you sure you want to remove ${subject}?`)) {
                classSubjects[classId] = classSubjects[classId].filter(s => s !== subject);
                displaySubjectList(classId);
                showInstantAlert('Subject removed successfully! ‚úÖ', 'success');
            }
        }

        // Drag and Drop Functions
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            this.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const classId = document.getElementById('subjectClassSelect').value;
                const draggedSubject = draggedElement.dataset.subject;
                const targetSubject = this.dataset.subject;
                
                const draggedIndex = classSubjects[classId].indexOf(draggedSubject);
                const targetIndex = classSubjects[classId].indexOf(targetSubject);
                
                // Remove dragged subject and insert at new position
                classSubjects[classId].splice(draggedIndex, 1);
                classSubjects[classId].splice(targetIndex, 0, draggedSubject);
                
                displaySubjectList(classId);
            }
            
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.subject-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function showStudentMarksTable() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            const selectedTerm = document.getElementById('adminTermSelect').value;
            const selectedStudent = document.getElementById('adminStudentSelect').value;
            
            if (!selectedClass || !selectedTerm || !selectedStudent) {
                return;
            }
            
            const student = studentsData[selectedClass][selectedStudent];
            const subjects = classSubjects[selectedClass] || ['HINDI', 'ENGLISH', 'MATHS', 'EVS', 'SANSKRIT'];
            const termMaxMark = termMaxMarks[selectedTerm] || { oral: 5, written: 15 };
            
            // Initialize marks for this term if they don't exist
            if (!student.marks[selectedTerm]) {
                student.marks[selectedTerm] = {};
            }
            
            // Update table title
            document.getElementById('studentMarksTableTitle').textContent = `üìä ${student.name} - ${selectedTerm} Marks (Max: ${termMaxMark.oral} Oral, ${termMaxMark.written} Written)`;
            
            // Generate table rows
            const tableBody = document.getElementById('studentMarksTableBody');
            tableBody.innerHTML = '';
            
            subjects.forEach(subject => {
                // Get exam type configuration for this subject
                const examConfig = subjectExamTypes[selectedClass] && subjectExamTypes[selectedClass][subject] 
                    ? subjectExamTypes[selectedClass][subject] 
                    : { hasOral: true, hasWritten: true };
                
                // Only get existing marks, don't create default ones
                const marks = student.marks[selectedTerm][subject] || { oral: '', written: '' };
                let total = '';
                
                // Calculate total based on exam configuration
                if (examConfig.hasOral && examConfig.hasWritten) {
                    if (marks.oral === 'A' && marks.written === 'A') {
                        total = 'AB';
                    } else if (marks.oral === 'A' || marks.written === 'A') {
                        if (marks.oral === 'A') {
                            total = marks.written !== '' ? parseInt(marks.written) || 0 : '';
                        } else {
                            total = marks.oral !== '' ? parseInt(marks.oral) || 0 : '';
                        }
                    } else if (marks.oral !== '' || marks.written !== '') {
                        total = (parseInt(marks.oral) || 0) + (parseInt(marks.written) || 0);
                    }
                } else if (examConfig.hasOral && !examConfig.hasWritten) {
                    // Only oral exam
                    if (marks.oral === 'A') {
                        total = 'AB';
                    } else if (marks.oral !== '') {
                        total = parseInt(marks.oral) || 0;
                    }
                } else if (!examConfig.hasOral && examConfig.hasWritten) {
                    // Only written exam
                    if (marks.written === 'A') {
                        total = 'AB';
                    } else if (marks.written !== '') {
                        total = parseInt(marks.written) || 0;
                    }
                }
                
                // Calculate max marks based on exam configuration
                let maxMarks = 0;
                if (examConfig.hasOral) maxMarks += termMaxMark.oral;
                if (examConfig.hasWritten) maxMarks += termMaxMark.written;
                
                const row = document.createElement('tr');
                row.className = 'border-b-2 border-gray-100 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-300';
                row.innerHTML = `
                    <td class="py-4 px-4 font-bold text-purple-700 text-center">${subject}</td>
                    <td class="py-4 px-4 text-center">
                        ${examConfig.hasOral ? `
                            <input type="text" value="${marks.oral}" placeholder="0 or A" 
                                   class="w-20 p-2 border-2 border-blue-300 rounded-lg text-center font-bold focus:border-blue-500 focus:outline-none"
                                   onchange="updateMarkWithValidation('${selectedClass}', '${selectedStudent}', '${selectedTerm}', '${subject}', 'oral', this.value, ${termMaxMark.oral})">
                        ` : `
                            <span class="text-gray-400 font-semibold">N/A</span>
                        `}
                    </td>
                    <td class="py-4 px-4 text-center">
                        ${examConfig.hasWritten ? `
                            <input type="text" value="${marks.written}" placeholder="0 or A"
                                   class="w-20 p-2 border-2 border-green-300 rounded-lg text-center font-bold focus:border-green-500 focus:outline-none"
                                   onchange="updateMarkWithValidation('${selectedClass}', '${selectedStudent}', '${selectedTerm}', '${subject}', 'written', this.value, ${termMaxMark.written})">
                        ` : `
                            <span class="text-gray-400 font-semibold">N/A</span>
                        `}
                    </td>
                    <td class="py-4 px-4 text-center font-bold text-indigo-700 text-lg" id="total-${subject}">${total}</td>
                    <td class="py-4 px-4 text-center font-semibold text-gray-600">${maxMarks}</td>
                `;
                tableBody.appendChild(row);
            });
            
            document.getElementById('studentMarksTable').classList.remove('hidden');
            document.getElementById('studentMarksTable').scrollIntoView({ behavior: 'smooth' });
        }

        function hideStudentMarksTable() {
            document.getElementById('studentMarksTable').classList.add('hidden');
        }

        function hideCombinedMarksTable() {
            document.getElementById('combinedMarksTable').classList.add('hidden');
        }

        function displayTermList() {
            const termList = document.getElementById('termList');
            termList.innerHTML = '';
            
            allTerms.forEach((term, index) => {
                const termItem = document.createElement('div');
                termItem.className = 'bg-gradient-to-r from-indigo-100 to-purple-100 p-4 rounded-xl border-2 border-indigo-200 flex items-center justify-between shadow-lg';
                
                termItem.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üìÖ</span>
                        <span class="font-bold text-indigo-700">${term}</span>
                        <span class="ml-3 text-sm ${availableTerms.includes(term) ? 'text-green-600 font-semibold' : 'text-gray-500'}">
                            ${availableTerms.includes(term) ? '‚úÖ Available to students' : 'üîí Hidden from students'}
                        </span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleTermAvailability('${term}')" class="px-3 py-1 rounded-lg font-bold transition-all duration-300 ${availableTerms.includes(term) ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white'}">
                            ${availableTerms.includes(term) ? 'üîí Hide' : 'üîì Show'}
                        </button>
                        ${!['First Term', 'Second Term', 'Final Term'].includes(term) ? `
                            <button onclick="removeTerm('${term}')" class="bg-red-500 text-white px-3 py-1 rounded-lg font-bold hover:bg-red-600 transition-all duration-300">
                                üóëÔ∏è
                            </button>
                        ` : ''}
                    </div>
                `;
                
                termList.appendChild(termItem);
            });
        }

        function toggleTermAvailability(term) {
            if (availableTerms.includes(term)) {
                availableTerms = availableTerms.filter(t => t !== term);
            } else {
                availableTerms.push(term);
            }
            displayTermList();
            
            // Refresh student portal if needed
            const studentClassSelect = document.getElementById('classSelect');
            if (studentClassSelect.value) {
                const studentTermSelect = document.getElementById('termSelect');
                const currentSelection = studentTermSelect.value;
                studentTermSelect.innerHTML = '<option value="">Choose Term</option>';
                
                availableTerms.forEach(availableTerm => {
                    const option = document.createElement('option');
                    option.value = availableTerm;
                    option.textContent = availableTerm;
                    studentTermSelect.appendChild(option);
                });
                
                if (availableTerms.includes(currentSelection)) {
                    studentTermSelect.value = currentSelection;
                }
                
                updateStudentMessage();
            }
        }

        function removeTerm(term) {
            if (['First Term', 'Second Term', 'Final Term'].includes(term)) {
                showInstantAlert('Cannot remove default terms! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            if (confirm(`Are you sure you want to remove "${term}"? This will delete all marks for this term!`)) {
                // Remove from all terms
                allTerms = allTerms.filter(t => t !== term);
                
                // Remove from available terms
                availableTerms = availableTerms.filter(t => t !== term);
                
                // Remove term message
                delete termMessages[term];
                
                // Remove marks data for this term from all students
                Object.keys(studentsData).forEach(classId => {
                    Object.keys(studentsData[classId]).forEach(studentId => {
                        if (studentsData[classId][studentId].marks[term]) {
                            delete studentsData[classId][studentId].marks[term];
                        }
                    });
                });
                
                displayTermList();
                refreshMessageTermSelect();
                showInstantAlert('Term removed successfully! ‚úÖ', 'success');
            }
        }

        function refreshMessageTermSelect() {
            const messageTermSelect = document.getElementById('messageTermSelect');
            messageTermSelect.innerHTML = '<option value="">Choose Term</option>';
            
            allTerms.forEach(term => {
                const option = document.createElement('option');
                option.value = term;
                option.textContent = term;
                messageTermSelect.appendChild(option);
            });
        }

        function updateMarkWithValidation(classId, studentId, term, subject, type, value, maxMark) {
            let finalValue = value.toString().toUpperCase().trim();
            
            // Allow empty values (admin doesn't have to fill all subjects)
            if (finalValue === '') {
                finalValue = '';
            } else if (finalValue === 'A') {
                // Absent is allowed
                finalValue = 'A';
            } else {
                const numValue = parseInt(finalValue);
                if (isNaN(numValue) || numValue < 0) {
                    showInstantAlert('Please enter a valid number, "A" for absent, or leave empty! ‚ö†Ô∏è', 'warning');
                    return;
                }
                if (numValue > maxMark) {
                    showInstantAlert(`Marks cannot exceed ${maxMark}! ‚ö†Ô∏è`, 'warning');
                    return;
                }
                finalValue = numValue;
            }
            
            if (!studentsData[classId][studentId].marks[term]) {
                studentsData[classId][studentId].marks[term] = {};
            }
            
            if (!studentsData[classId][studentId].marks[term][subject]) {
                studentsData[classId][studentId].marks[term][subject] = { oral: '', written: '' };
            }
            
            studentsData[classId][studentId].marks[term][subject][type] = finalValue;
            
            // Update total display
            const marks = studentsData[classId][studentId].marks[term][subject];
            let total = '';
            
            if (marks.oral === 'A' && marks.written === 'A') {
                total = 'AB';
            } else if (marks.oral === 'A' || marks.written === 'A') {
                // If one is absent, show only the other mark
                if (marks.oral === 'A') {
                    total = marks.written !== '' ? parseInt(marks.written) || 0 : '';
                } else {
                    total = marks.oral !== '' ? parseInt(marks.oral) || 0 : '';
                }
            } else if (marks.oral !== '' || marks.written !== '') {
                // If at least one mark is entered, calculate total
                total = (parseInt(marks.oral) || 0) + (parseInt(marks.written) || 0);
            } else {
                // No marks entered yet
                total = '';
            }
            
            const totalElement = document.getElementById(`total-${subject}`) || document.getElementById(`total-${term}-${subject}`);
            if (totalElement) {
                totalElement.textContent = total;
            }
        }

        function updateMark(classId, studentId, term, subject, type, value) {
            const numValue = parseInt(value) || 0;
            
            if (!studentsData[classId][studentId].marks[term]) {
                studentsData[classId][studentId].marks[term] = {};
            }
            
            if (!studentsData[classId][studentId].marks[term][subject]) {
                studentsData[classId][studentId].marks[term][subject] = { oral: 0, written: 0 };
            }
            
            studentsData[classId][studentId].marks[term][subject][type] = numValue;
            
            // Update total display
            const marks = studentsData[classId][studentId].marks[term][subject];
            const total = marks.oral + marks.written;
            const totalElement = document.getElementById(`total-${subject}`) || document.getElementById(`total-${term}-${subject}`);
            if (totalElement) {
                totalElement.textContent = total;
            }
        }

        function updateCombinedMarkWithValidation(classId, studentId, term, subject, type, value, maxMark) {
            let finalValue = value.toString().toUpperCase().trim();
            
            // Validate input
            if (finalValue === 'A') {
                // Absent is allowed
            } else {
                const numValue = parseInt(finalValue);
                if (isNaN(numValue) || numValue < 0) {
                    showInstantAlert('Please enter a valid number or "A" for absent! ‚ö†Ô∏è', 'warning');
                    return;
                }
                if (numValue > maxMark) {
                    showInstantAlert(`Marks cannot exceed ${maxMark}! ‚ö†Ô∏è`, 'warning');
                    return;
                }
                finalValue = numValue;
            }
            
            if (!studentsData[classId][studentId].marks[term]) {
                studentsData[classId][studentId].marks[term] = {};
            }
            
            if (!studentsData[classId][studentId].marks[term][subject]) {
                studentsData[classId][studentId].marks[term][subject] = { oral: '', written: '' };
            }
            
            studentsData[classId][studentId].marks[term][subject][type] = finalValue;
            
            // Update total display for this term-subject
            const marks = studentsData[classId][studentId].marks[term][subject];
            let total = '';
            
            // Get exam type configuration for this subject
            const examConfig = subjectExamTypes[classId] && subjectExamTypes[classId][subject] 
                ? subjectExamTypes[classId][subject] 
                : { hasOral: true, hasWritten: true };
            
            // Calculate total based on exam configuration
            if (examConfig.hasOral && examConfig.hasWritten) {
                if (marks.oral === 'A' && marks.written === 'A') {
                    total = 'AB';
                } else if (marks.oral === 'A' || marks.written === 'A') {
                    if (marks.oral === 'A') {
                        total = marks.written !== '' ? parseInt(marks.written) || 0 : '';
                    } else {
                        total = marks.oral !== '' ? parseInt(marks.oral) || 0 : '';
                    }
                } else if (marks.oral !== '' || marks.written !== '') {
                    total = (parseInt(marks.oral) || 0) + (parseInt(marks.written) || 0);
                }
            } else if (examConfig.hasOral && !examConfig.hasWritten) {
                if (marks.oral === 'A') {
                    total = 'AB';
                } else if (marks.oral !== '') {
                    total = parseInt(marks.oral) || 0;
                }
            } else if (!examConfig.hasOral && examConfig.hasWritten) {
                if (marks.written === 'A') {
                    total = 'AB';
                } else if (marks.written !== '') {
                    total = parseInt(marks.written) || 0;
                }
            }
            
            const totalElement = document.getElementById(`total-${term}-${subject}`);
            if (totalElement) {
                totalElement.textContent = total;
            }
            
            // Update grand totals for this subject
            const student = studentsData[classId][studentId];
            let grandOralTotal = 0;
            let grandWrittenTotal = 0;
            
            allTerms.forEach(termName => {
                const termMarks = student.marks[termName] && student.marks[termName][subject] ? student.marks[termName][subject] : { oral: '', written: '' };
                
                // Only add numeric values to grand total (skip 'A' for absent)
                if (termMarks.oral !== 'A' && termMarks.oral !== '') {
                    grandOralTotal += parseInt(termMarks.oral) || 0;
                }
                if (termMarks.written !== 'A' && termMarks.written !== '') {
                    grandWrittenTotal += parseInt(termMarks.written) || 0;
                }
            });
            
            const grandSubjectTotal = grandOralTotal + grandWrittenTotal;
            
            // Update grand total displays
            const grandOralElement = document.getElementById(`grandoral-${subject}`);
            const grandWrittenElement = document.getElementById(`grandwritten-${subject}`);
            const grandTotalElement = document.getElementById(`grandtotal-${subject}`);
            
            if (grandOralElement) grandOralElement.textContent = grandOralTotal;
            if (grandWrittenElement) grandWrittenElement.textContent = grandWrittenTotal;
            if (grandTotalElement) grandTotalElement.textContent = grandSubjectTotal;
        }

        function updateCombinedMark(classId, studentId, term, subject, type, value) {
            updateMark(classId, studentId, term, subject, type, value);
            
            // Update grand total for this subject
            let subjectGrandTotal = 0;
            allTerms.forEach(termName => {
                if (studentsData[classId][studentId].marks[termName] && studentsData[classId][studentId].marks[termName][subject]) {
                    const marks = studentsData[classId][studentId].marks[termName][subject];
                    subjectGrandTotal += marks.oral + marks.written;
                }
            });
            
            const grandTotalElement = document.getElementById(`grandtotal-${subject}`);
            if (grandTotalElement) {
                grandTotalElement.textContent = subjectGrandTotal;
            }
        }

        function showCombinedMarksTable() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            const selectedStudent = document.getElementById('adminStudentSelect').value;
            
            if (!selectedClass || !selectedStudent) {
                return;
            }
            
            const student = studentsData[selectedClass][selectedStudent];
            const subjects = classSubjects[selectedClass] || ['HINDI', 'ENGLISH', 'MATHS', 'EVS', 'SANSKRIT'];
            
            // Update table title
            document.getElementById('combinedMarksTableTitle').textContent = `üìä ${student.name} - Combined Terms (All Marks)`;
            
            // Initialize marks for all terms if they don't exist
            allTerms.forEach(term => {
                if (!student.marks[term]) {
                    student.marks[term] = {};
                    subjects.forEach(subject => {
                        student.marks[term][subject] = { oral: 0, written: 0, maxMarks: 10 };
                    });
                }
            });
            
            // Generate combined table
            let tableHTML = `
                <table class="w-full bg-white rounded-2xl shadow-lg overflow-hidden">
                    <thead class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white">
                        <tr>
                            <th class="py-4 px-2 text-center font-bold text-sm">üìö Subject</th>
            `;
            
            // Add term headers
            allTerms.forEach(term => {
                tableHTML += `
                    <th colspan="3" class="py-4 px-2 text-center font-bold text-sm border-l-2 border-white">${term}</th>
                `;
            });
            
            // Add Grand Total header columns
            tableHTML += `
                    <th colspan="3" class="py-4 px-2 text-center font-bold text-sm border-l-4 border-yellow-400 bg-gradient-to-r from-yellow-200 to-orange-200">üìä GRAND TOTALS</th>
                        </tr>
                        <tr class="bg-gradient-to-r from-indigo-400 to-purple-500">
                            <th class="py-2 px-2 text-center font-bold text-xs">Name</th>
            `;
            
            // Add sub-headers for each term
            allTerms.forEach(term => {
                tableHTML += `
                    <th class="py-2 px-1 text-center font-bold text-xs border-l-2 border-white">üó£Ô∏è Oral</th>
                    <th class="py-2 px-1 text-center font-bold text-xs">‚úçÔ∏è Written</th>
                    <th class="py-2 px-1 text-center font-bold text-xs">üìù Total</th>
                `;
            });
            
            // Add Grand Total sub-headers with vertical text
            tableHTML += `
                    <th class="py-2 px-1 text-center font-bold text-xs border-l-4 border-yellow-400 bg-gradient-to-r from-yellow-200 to-orange-200" style="writing-mode: vertical-rl; text-orientation: mixed;">
                        <div class="transform rotate-180">üó£Ô∏è All Oral</div>
                    </th>
                    <th class="py-2 px-1 text-center font-bold text-xs bg-gradient-to-r from-yellow-200 to-orange-200" style="writing-mode: vertical-rl; text-orientation: mixed;">
                        <div class="transform rotate-180">‚úçÔ∏è All Written</div>
                    </th>
                    <th class="py-2 px-1 text-center font-bold text-xs bg-gradient-to-r from-yellow-200 to-orange-200" style="writing-mode: vertical-rl; text-orientation: mixed;">
                        <div class="transform rotate-180">üìù Grand Total</div>
                    </th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Generate rows for each subject
            subjects.forEach(subject => {
                tableHTML += `
                    <tr class="border-b-2 border-gray-100 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-300">
                        <td class="py-3 px-2 font-bold text-purple-700 text-center text-sm">${subject}</td>
                `;
                
                allTerms.forEach(term => {
                    const marks = student.marks[term] && student.marks[term][subject] ? student.marks[term][subject] : { oral: 0, written: 0 };
                    const termMaxMark = termMaxMarks[term] || { oral: 5, written: 15 };
                    
                    // Get exam type configuration for this subject
                    const examConfig = subjectExamTypes[selectedClass] && subjectExamTypes[selectedClass][subject] 
                        ? subjectExamTypes[selectedClass][subject] 
                        : { hasOral: true, hasWritten: true };
                    
                    let total = 0;
                    
                    // Calculate total based on exam configuration
                    if (examConfig.hasOral && examConfig.hasWritten) {
                        if (marks.oral !== 'A' && marks.written !== 'A') {
                            total = (parseInt(marks.oral) || 0) + (parseInt(marks.written) || 0);
                        } else if (marks.oral === 'A' && marks.written !== 'A') {
                            total = parseInt(marks.written) || 0;
                        } else if (marks.oral !== 'A' && marks.written === 'A') {
                            total = parseInt(marks.oral) || 0;
                        } else {
                            total = 'AB';
                        }
                    } else if (examConfig.hasOral && !examConfig.hasWritten) {
                        if (marks.oral === 'A') {
                            total = 'AB';
                        } else {
                            total = parseInt(marks.oral) || 0;
                        }
                    } else if (!examConfig.hasOral && examConfig.hasWritten) {
                        if (marks.written === 'A') {
                            total = 'AB';
                        } else {
                            total = parseInt(marks.written) || 0;
                        }
                    }
                    
                    tableHTML += `
                        <td class="py-3 px-1 text-center border-l-2 border-gray-200">
                            ${examConfig.hasOral ? `
                                <input type="text" value="${marks.oral}" placeholder="0 or A"
                                       class="w-12 p-1 border border-blue-300 rounded text-center text-xs font-bold focus:border-blue-500 focus:outline-none"
                                       onchange="updateCombinedMarkWithValidation('${selectedClass}', '${selectedStudent}', '${term}', '${subject}', 'oral', this.value, ${termMaxMark.oral})">
                            ` : `
                                <span class="text-gray-400 text-xs font-semibold">N/A</span>
                            `}
                        </td>
                        <td class="py-3 px-1 text-center">
                            ${examConfig.hasWritten ? `
                                <input type="text" value="${marks.written}" placeholder="0 or A"
                                       class="w-12 p-1 border border-green-300 rounded text-center text-xs font-bold focus:border-green-500 focus:outline-none"
                                       onchange="updateCombinedMarkWithValidation('${selectedClass}', '${selectedStudent}', '${term}', '${subject}', 'written', this.value, ${termMaxMark.written})">
                            ` : `
                                <span class="text-gray-400 text-xs font-semibold">N/A</span>
                            `}
                        </td>
                        <td class="py-3 px-1 text-center font-bold text-indigo-700 text-sm" id="total-${term}-${subject}">${total}</td>
                    `;
                });
                
                // Calculate grand totals for this subject across all terms
                let grandOralTotal = 0;
                let grandWrittenTotal = 0;
                let grandSubjectTotal = 0;
                
                allTerms.forEach(term => {
                    const marks = student.marks[term] && student.marks[term][subject] ? student.marks[term][subject] : { oral: '', written: '' };
                    
                    // Only add numeric values to grand total (skip 'A' for absent)
                    if (marks.oral !== 'A' && marks.oral !== '') {
                        grandOralTotal += parseInt(marks.oral) || 0;
                    }
                    if (marks.written !== 'A' && marks.written !== '') {
                        grandWrittenTotal += parseInt(marks.written) || 0;
                    }
                });
                
                grandSubjectTotal = grandOralTotal + grandWrittenTotal;
                
                // Add Grand Total columns for this subject
                tableHTML += `
                    <td class="py-3 px-1 text-center font-bold text-orange-700 text-sm border-l-4 border-yellow-400 bg-gradient-to-r from-yellow-50 to-orange-50" id="grandoral-${subject}">${grandOralTotal}</td>
                    <td class="py-3 px-1 text-center font-bold text-orange-700 text-sm bg-gradient-to-r from-yellow-50 to-orange-50" id="grandwritten-${subject}">${grandWrittenTotal}</td>
                    <td class="py-3 px-1 text-center font-bold text-orange-800 text-lg bg-gradient-to-r from-yellow-50 to-orange-50" id="grandtotal-${subject}">${grandSubjectTotal}</td>
                `;
                
                tableHTML += `</tr>`;
            });
            
            // Add totals row
            tableHTML += `
                <tr class="bg-gradient-to-r from-yellow-100 to-orange-100 border-t-4 border-orange-300">
                    <td class="py-3 px-2 font-bold text-orange-700 text-center text-sm">üèÜ TOTALS</td>
            `;
            
            // Calculate totals for each term
            let allTermsOralTotal = 0;
            let allTermsWrittenTotal = 0;
            let allTermsGrandTotal = 0;
            
            allTerms.forEach(term => {
                let termOralTotal = 0;
                let termWrittenTotal = 0;
                let termGrandTotal = 0;
                
                subjects.forEach(subject => {
                    const marks = student.marks[term] && student.marks[term][subject] ? student.marks[term][subject] : { oral: '', written: '' };
                    
                    // Only add numeric values to totals (skip 'A' for absent)
                    if (marks.oral !== 'A' && marks.oral !== '') {
                        const oralValue = parseInt(marks.oral) || 0;
                        termOralTotal += oralValue;
                        allTermsOralTotal += oralValue;
                    }
                    if (marks.written !== 'A' && marks.written !== '') {
                        const writtenValue = parseInt(marks.written) || 0;
                        termWrittenTotal += writtenValue;
                        allTermsWrittenTotal += writtenValue;
                    }
                });
                
                termGrandTotal = termOralTotal + termWrittenTotal;
                
                tableHTML += `
                    <td class="py-3 px-1 text-center font-bold text-blue-700 text-sm border-l-2 border-gray-300">${termOralTotal}</td>
                    <td class="py-3 px-1 text-center font-bold text-green-700 text-sm">${termWrittenTotal}</td>
                    <td class="py-3 px-1 text-center font-bold text-orange-700 text-sm">${termGrandTotal}</td>
                `;
            });
            
            allTermsGrandTotal = allTermsOralTotal + allTermsWrittenTotal;
            
            // Add Grand Total columns for totals row
            tableHTML += `
                    <td class="py-3 px-1 text-center font-bold text-orange-800 text-lg border-l-4 border-yellow-400 bg-gradient-to-r from-yellow-200 to-orange-200">${allTermsOralTotal}</td>
                    <td class="py-3 px-1 text-center font-bold text-orange-800 text-lg bg-gradient-to-r from-yellow-200 to-orange-200">${allTermsWrittenTotal}</td>
                    <td class="py-3 px-1 text-center font-bold text-orange-900 text-xl bg-gradient-to-r from-yellow-200 to-orange-200">${allTermsGrandTotal}</td>
                </tr>
            </tbody>
        </table>
            `;
            
            document.getElementById('combinedMarksContent').innerHTML = tableHTML;
            document.getElementById('combinedMarksTable').classList.remove('hidden');
            document.getElementById('combinedMarksTable').scrollIntoView({ behavior: 'smooth' });
        }

        // Save All Marks Button
        document.getElementById('saveAllMarksBtn').addEventListener('click', function() {
            showMessage(document.getElementById('saveMarksMessage'), 'All marks saved successfully! ‚úÖ', 'success');
        });

        // Save Combined Marks Button
        document.getElementById('saveCombinedMarksBtn').addEventListener('click', function() {
            showMessage(document.getElementById('saveCombinedMarksMessage'), 'All combined marks saved successfully! ‚úÖ', 'success');
        });

        // Download Tabulation Button
        document.getElementById('downloadTabulationBtn').addEventListener('click', function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            const selectedTerm = document.getElementById('adminTermSelect').value;
            
            if (!selectedClass || !selectedTerm) {
                showInstantAlert('Please select class and term! ‚ö†Ô∏è', 'warning');
                return;
            }
            
            downloadTabulation(selectedClass, selectedTerm);
        });

        function downloadTabulation(classId, term) {
            if (!studentsData[classId]) {
                showInstantAlert('No students found for this class! ‚ö†Ô∏è', 'warning');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(16);
            doc.text('Primary School Karanpur - Tabulation Sheet', 20, 20);
            doc.setFontSize(12);
            doc.text(`Class: ${classId} | Term: ${term}`, 20, 30);
            
            // Prepare data for table
            const tableData = [];
            const subjects = classSubjects[classId] || ['HINDI', 'ENGLISH', 'MATHS', 'EVS', 'SANSKRIT'];
            
            Object.keys(studentsData[classId]).forEach(studentId => {
                const student = studentsData[classId][studentId];
                const row = [student.name, student.fatherName];
                
                let totalMarks = 0;
                let maxTotalMarks = 0;
                
                subjects.forEach(subject => {
                    const marks = student.marks[term] && student.marks[term][subject] 
                        ? student.marks[term][subject] 
                        : { oral: 0, written: 0, maxMarks: 10 };
                    
                    const total = marks.oral + marks.written;
                    totalMarks += total;
                    maxTotalMarks += marks.maxMarks;
                    row.push(total);
                });
                
                row.push(totalMarks);
                const percentage = ((totalMarks / maxTotalMarks) * 100).toFixed(1);
                row.push(percentage + '%');
                
                tableData.push(row);
            });
            
            // Create table
            const headers = ['Student Name', 'Father Name', ...subjects, 'Total', 'Percentage'];
            
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 40,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [100, 100, 255] }
            });
            
            doc.save(`Class_${classId}_${term}_Tabulation.pdf`);
            showInstantAlert('Tabulation downloaded! üìÑ', 'success');
        }

        function downloadReportCard(studentName, term) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('Primary School Karanpur', 20, 20);
            doc.setFontSize(14);
            doc.text(`Report Card - ${studentName}`, 20, 30);
            doc.text(`Term: ${term}`, 20, 40);
            
            doc.save(`${studentName}_${term}_ReportCard.pdf`);
            showInstantAlert('Report card downloaded! üìÑ', 'success');
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set default active tab
            studentTab.click();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97e6f86277945a18',t:'MTc1Nzc1OTQzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
