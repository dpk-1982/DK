<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primary School Karanpur - Report Card System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, child, push, remove, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9nE0-yeC5Ms34OKXbxSSfmfscyzUMn_Q",
            authDomain: "dd1982-54ac7.firebaseapp.com",
            databaseURL: "https://dd1982-54ac7-default-rtdb.firebaseio.com",
            projectId: "dd1982-54ac7",
            storageBucket: "dd1982-54ac7.firebasestorage.app",
            messagingSenderId: "433562739590",
            appId: "1:433562739590:web:dab8cfa164455d75404207"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase functions globally available
        window.firebaseDB = {
            database,
            ref,
            set,
            get,
            child,
            push,
            remove,
            onValue
        };
        
        // Initialize the app after Firebase is loaded
        window.addEventListener('load', () => {
            if (window.initializeApp) {
                window.initializeApp();
            }
        });
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@300;400;700&display=swap');
        
        * {
            font-family: 'Comic Neue', cursive;
        }
        
        .marquee {
            position: fixed;
            width: 100%;
            z-index: 1000;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .marquee-top {
            top: 0;
            background: linear-gradient(45deg, #ff6b6b 0%, #feca57 100%);
        }
        
        .marquee-bottom {
            bottom: 0;
            background: linear-gradient(45deg, #48cae4 0%, #023e8a 100%);
        }
        
        .marquee-content {
            display: inline-block;
            animation: scroll 20s linear infinite;
            padding: 10px 0;
            color: white;
            font-weight: bold;
        }
        
        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        body {
            padding-top: 60px;
            padding-bottom: 60px;
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 25%, #45b7d1 50%, #96ceb4 75%, #feca57 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10001;
            padding: 15px 25px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            min-width: 250px;
            text-align: center;
        }
        
        .alert.error {
            background: #fee2e2;
            color: #dc2626;
            border: 3px solid #ef4444;
        }
        
        .alert.success {
            background: #dcfce7;
            color: #16a34a;
            border: 3px solid #22c55e;
        }
        
        .alert.warning {
            background: #fef3c7;
            color: #d97706;
            border: 3px solid #f59e0b;
        }
    </style>
</head>
<body>
    <!-- Top Marquee -->
    <div class="marquee marquee-top">
        <div class="marquee-content text-lg">
            🌟 Welcome to Primary School Karanpur - A place where students learn with joy! 🌟
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- School Header -->
        <div class="text-center mb-8">
            <div class="max-w-4xl mx-auto bg-gradient-to-br from-white via-yellow-50 to-pink-50 rounded-3xl p-8 shadow-2xl border-2 border-blue-200">
                <h1 class="text-4xl md:text-6xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent mb-4">
                    🏫 Primary School Karanpur 🏫
                </h1>
                <p class="text-xl font-semibold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent">
                    📍 Block-Behjam, District-Lakhimpur-Kheri
                </p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-8">
            <div class="bg-white rounded-full p-2 shadow-lg">
                <button id="studentTab" class="px-6 py-3 rounded-full bg-gradient-to-r from-pink-500 to-orange-500 text-white font-bold transition-all duration-300">
                    👨‍🎓 Student Portal
                </button>
                <button id="adminTab" class="px-6 py-3 rounded-full text-gray-600 font-bold transition-all duration-300 hover:bg-gradient-to-r hover:from-blue-400 hover:to-purple-500 hover:text-white">
                    👨‍💼 Admin Panel
                </button>
            </div>
        </div>

        <!-- Student Portal -->
        <div id="studentPortal">
            <div class="glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                <h2 class="text-3xl font-bold text-white text-center mb-6">
                    📊 Student Report Card 📊
                </h2>
                
                <!-- Global Student Message -->
                <div class="bg-gradient-to-br from-orange-100 via-yellow-100 to-red-100 rounded-2xl p-6 shadow-lg border-2 border-orange-300 mb-6">
                    <div class="text-center">
                        <div class="text-2xl mb-2">📢</div>
                        <h3 class="text-lg font-bold text-orange-700 mb-3">Important Message</h3>
                        <div id="globalStudentMessage" class="text-orange-800 font-bold text-lg">
                            📢 Welcome to the Student Report Card Portal! Select your class and name to view your report cards. 🌟📚
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <!-- Class Selection -->
                    <div class="bg-gradient-to-br from-blue-100 to-cyan-100 rounded-2xl p-6 shadow-lg border-2 border-blue-200">
                        <label class="block text-lg font-bold text-blue-700 mb-3">🎓 Select Class</label>
                        <select id="classSelect" class="w-full p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none bg-white">
                            <option value="">Choose Class</option>
                            <option value="1">Class 1</option>
                            <option value="2">Class 2</option>
                            <option value="3">Class 3</option>
                            <option value="4">Class 4</option>
                            <option value="5">Class 5</option>
                        </select>
                    </div>
                    
                    <!-- Student Selection -->
                    <div class="bg-gradient-to-br from-green-100 to-teal-100 rounded-2xl p-6 shadow-lg border-2 border-green-200">
                        <label class="block text-lg font-bold text-green-700 mb-3">👦 Select Student</label>
                        <select id="studentSelect" class="w-full p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none bg-white" disabled>
                            <option value="">Choose Student</option>
                        </select>
                    </div>
                </div>
                
                <!-- Available Terms Display -->
                <div id="availableTermsSection" class="hidden bg-gradient-to-br from-purple-100 to-pink-100 rounded-2xl p-6 shadow-lg border-2 border-purple-200 mb-6">
                    <h4 class="text-lg font-bold text-purple-700 mb-4">📅 Available Report Cards</h4>
                    <div id="termButtons" class="flex flex-wrap gap-3 justify-center">
                        <!-- Term buttons will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Report Card Display -->
            <div id="reportCardDisplay" class="hidden glass-effect rounded-3xl p-8 shadow-2xl">
                <div id="reportCardContent"></div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden">
            <!-- Admin Login -->
            <div id="adminLogin" class="glass-effect rounded-3xl p-8 mb-8 shadow-2xl text-center">
                <h2 class="text-3xl font-bold text-white mb-6">🔐 Admin Login</h2>
                <div class="max-w-md mx-auto">
                    <input type="password" id="adminPassword" placeholder="Enter Admin Password" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none mb-4">
                    <button id="adminLoginBtn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                        🚪 Login
                    </button>
                    <div id="loginMessage" class="mt-4 text-sm"></div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="hidden">
                <div class="glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h2 class="text-3xl font-bold text-white text-center mb-6">👨‍💼 Admin Dashboard</h2>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white rounded-2xl p-4 shadow-lg">
                            <label class="block text-sm font-bold text-blue-600 mb-2">🎓 Class</label>
                            <select id="adminClassSelect" class="w-full p-2 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none">
                                <option value="">Choose Class</option>
                                <option value="1">Class 1</option>
                                <option value="2">Class 2</option>
                                <option value="3">Class 3</option>
                                <option value="4">Class 4</option>
                                <option value="5">Class 5</option>
                            </select>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-4 shadow-lg">
                            <label class="block text-sm font-bold text-purple-600 mb-2">📅 Term</label>
                            <select id="adminTermSelect" class="w-full p-2 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none" disabled>
                                <option value="">Choose Term</option>
                            </select>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-4 shadow-lg">
                            <label class="block text-sm font-bold text-green-600 mb-2">👦 Student</label>
                            <div class="flex gap-2">
                                <select id="adminStudentSelect" class="flex-1 p-2 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none" disabled>
                                    <option value="">Choose Student</option>
                                </select>
                                <button id="addStudentBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-4 py-2 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm" disabled>
                                    ➕ Add
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
                        <button id="editStudentBtn" class="bg-gradient-to-r from-cyan-500 to-teal-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            ✏️ Edit Student
                        </button>
                        <button id="deleteStudentBtn" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            🗑️ Delete Student
                        </button>
                        <button id="manageMarksBtn" class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            📊 Manage Marks
                        </button>
                        <button id="profileFieldsBtn" class="bg-gradient-to-r from-violet-500 to-purple-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            👤 Profile Fields Manager
                        </button>
                        <button id="termManagementBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            📅 Term Management
                        </button>
                        <button id="combinedTermsBtn" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            📋 All Terms Manager
                        </button>
                        <button id="globalMessageBtn" class="bg-gradient-to-r from-pink-500 to-rose-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            📢 Global Message
                        </button>
                        <button id="photoSettingsBtn" class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            📸 Photo Settings
                        </button>
                        <button id="downloadTabulationBtn" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            📊 Download Tabulation
                        </button>
                    </div>
                </div>

                <!-- Student Form -->
                <div id="studentForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 id="studentFormTitle" class="text-2xl font-bold text-white text-center mb-6">📝 Student Information</h3>
                    <div id="studentFormFields" class="grid md:grid-cols-2 gap-6 mb-6">
                        <!-- Dynamic fields will be generated here -->
                    </div>
                    <div class="text-center">
                        <button id="saveStudentBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save Student
                        </button>
                        <button id="cancelFormBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Profile Fields Management -->
                <div id="profileFieldsForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">👤 Profile Fields Manager</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-indigo-600 mb-4">➕ Add New Profile Field</h4>
                        <div class="grid md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-indigo-600 mb-2">📝 Field Name</label>
                                <input type="text" id="newFieldName" class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none" placeholder="Enter field name">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-indigo-600 mb-2">🏷️ Display Label</label>
                                <input type="text" id="newFieldLabel" class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none" placeholder="Enter display label">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-indigo-600 mb-2">🎨 Icon</label>
                                <input type="text" id="newFieldIcon" class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none" placeholder="Enter emoji icon">
                            </div>
                        </div>
                        <button id="addNewFieldBtn" class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            ➕ Add Field
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-violet-600 mb-4">📋 Manage Existing Profile Fields</h4>
                        <div id="profileFieldsList" class="space-y-4">
                            <!-- Profile fields will be dynamically generated here -->
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="saveProfileFieldsBtn" class="bg-gradient-to-r from-violet-500 to-purple-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save All Changes
                        </button>
                        <button id="cancelProfileFieldsBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Term Management -->
                <div id="termManagementForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">📅 Term Management</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-orange-600 mb-4">➕ Add New Term</h4>
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-orange-600 mb-2">📝 Term Name</label>
                                <input type="text" id="newTermName" class="w-full p-3 border-2 border-orange-300 rounded-xl focus:border-orange-500 focus:outline-none" placeholder="Enter term name">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-orange-600 mb-2">👁️ Visibility</label>
                                <div class="flex items-center mt-3">
                                    <input type="checkbox" id="newTermVisible" class="w-5 h-5 text-orange-600 border-2 border-orange-300 rounded focus:ring-orange-500">
                                    <label for="newTermVisible" class="ml-3 text-orange-700 font-semibold">Make visible to students</label>
                                </div>
                            </div>
                        </div>
                        <button id="addTermBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            ➕ Add Term
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-purple-600 mb-4">📋 Manage Existing Terms</h4>
                        <div id="termsList" class="space-y-4">
                            <!-- Terms will be dynamically generated here -->
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="saveTermSettingsBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save All Term Settings
                        </button>
                        <button id="cancelTermManagementBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Combined Terms Manager -->
                <div id="combinedTermsForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">📋 All Terms Manager</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-teal-600 mb-4">📊 All Terms Overview</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead class="bg-gradient-to-r from-teal-500 to-emerald-600 text-white">
                                    <tr>
                                        <th class="py-3 px-4 text-left font-bold">📅 Term Name</th>
                                        <th class="py-3 px-4 text-center font-bold">👁️ Visible</th>
                                        <th class="py-3 px-4 text-center font-bold">⚙️ Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="allTermsTableBody">
                                    <!-- Terms will be dynamically generated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="saveCombinedTermsBtn" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save All Changes
                        </button>
                        <button id="cancelCombinedTermsBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Global Message Management -->
                <div id="globalMessageForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">📢 Global Student Message</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-pink-600 mb-4">✏️ Edit Global Message</h4>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-pink-600 mb-2">📝 Message Content</label>
                            <textarea id="globalMessageContent" rows="4" class="w-full p-4 border-2 border-pink-300 rounded-xl focus:border-pink-500 focus:outline-none resize-none text-lg" placeholder="Enter the global message for all students...">📢 Welcome to the Student Report Card Portal! Select your class and name to view your report cards. 🌟📚</textarea>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-pink-600 mb-2">🎨 Message Style</label>
                                <select id="globalMessageStyle" class="w-full p-3 border-2 border-pink-300 rounded-xl focus:border-pink-500 focus:outline-none">
                                    <option value="info">📢 Information (Orange)</option>
                                    <option value="success">✅ Success (Green)</option>
                                    <option value="warning">⚠️ Warning (Yellow)</option>
                                    <option value="announcement">📣 Announcement (Blue)</option>
                                </select>
                            </div>
                            <div class="flex items-center justify-center">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="globalMessageEnabled" class="w-5 h-5 text-pink-600 border-2 border-pink-300 rounded focus:ring-pink-500" checked>
                                    <span class="ml-3 text-pink-700 font-semibold">Show message to students</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-4 border-2 border-gray-200">
                            <h5 class="text-sm font-bold text-gray-600 mb-2">📋 Preview:</h5>
                            <div id="globalMessagePreview" class="bg-gradient-to-br from-orange-100 via-yellow-100 to-red-100 rounded-xl p-4 border-2 border-orange-300">
                                <div class="text-center">
                                    <div class="text-xl mb-2">📢</div>
                                    <h6 class="text-md font-bold text-orange-700 mb-2">Important Message</h6>
                                    <div class="text-orange-800 font-bold">📢 Welcome to the Student Report Card Portal! Select your class and name to view your report cards. 🌟📚</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="saveGlobalMessageBtn" class="bg-gradient-to-r from-pink-500 to-rose-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save Global Message
                        </button>
                        <button id="cancelGlobalMessageBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Photo Settings Management -->
                <div id="photoSettingsForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">📸 Student Photo Settings</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-indigo-600 mb-4">📋 Photo Display Configuration</h4>
                        
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-bold text-indigo-600 mb-2">👁️ Show Photos on Report Cards</label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="showPhotosOnReportCard" class="w-5 h-5 text-indigo-600 border-2 border-indigo-300 rounded focus:ring-indigo-500" checked>
                                    <span class="ml-3 text-indigo-700 font-semibold">Display student photos on report cards</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-indigo-600 mb-2">📏 Photo Size</label>
                                <select id="photoSizeSelect" class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none">
                                    <option value="small">Small (80x80px)</option>
                                    <option value="medium" selected>Medium (120x120px)</option>
                                    <option value="large">Large (160x160px)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-indigo-600 mb-2">📍 Photo Position on Report Card</label>
                            <select id="photoPositionSelect" class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none">
                                <option value="top" selected>Top of Profile Section</option>
                                <option value="left">Left Side of Profile</option>
                                <option value="right">Right Side of Profile</option>
                            </select>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-4 border-2 border-gray-200">
                            <h5 class="text-sm font-bold text-gray-600 mb-2">📋 Preview Settings:</h5>
                            <div id="photoSettingsPreview" class="text-gray-700">
                                <p><strong>Display:</strong> <span id="previewDisplay">Enabled</span></p>
                                <p><strong>Size:</strong> <span id="previewSize">Medium (120x120px)</span></p>
                                <p><strong>Position:</strong> <span id="previewPosition">Top of Profile Section</span></p>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="savePhotoSettingsBtn" class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save Photo Settings
                        </button>
                        <button id="cancelPhotoSettingsBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Tabulation Download Form -->
                <div id="tabulationDownloadForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">📊 Download Tabulation Sheet</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-green-600 mb-4">📋 Select Download Options</h4>
                        
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-bold text-green-600 mb-2">🎓 Select Class</label>
                                <select id="tabulationClassSelect" class="w-full p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none">
                                    <option value="">Choose Class</option>
                                    <option value="1">Class 1</option>
                                    <option value="2">Class 2</option>
                                    <option value="3">Class 3</option>
                                    <option value="4">Class 4</option>
                                    <option value="5">Class 5</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-green-600 mb-2">📅 Select Term</label>
                                <select id="tabulationTermSelect" class="w-full p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none" disabled>
                                    <option value="">Choose Term</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex gap-4">
                            <button id="generateTabulationBtn" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-700 transition-all duration-300 flex items-center" disabled>
                                <span class="mr-2">📊</span> Generate & Download CSV
                            </button>
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="cancelTabulationBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Marks Management -->
                <div id="marksTable" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 id="marksTableTitle" class="text-2xl font-bold text-white text-center mb-6">📊 Manage Marks</h3>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white rounded-2xl shadow-lg overflow-hidden">
                            <thead class="bg-gradient-to-r from-purple-500 to-pink-600 text-white">
                                <tr>
                                    <th class="py-4 px-4 text-center font-bold text-lg">📚 Subject</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">🗣️ Oral (Max 5)</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">✍️ Written (Max 15)</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">📝 Total</th>
                                </tr>
                            </thead>
                            <tbody id="marksTableBody">
                                <!-- Dynamic rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-center mt-6">
                        <button id="saveMarksBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save All Marks
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Marquee -->
    <div class="marquee marquee-bottom">
        <div class="marquee-content text-lg">
            💝 This site is developed by Mr. Deepak Kumar Vaishya, Assistant Teacher at Primary School Karanpur 💝
        </div>
    </div>

    <script>
        // Global Data - Initialize with working sample data
        const ADMIN_PASSWORD = "admin123";
        let isAdminLoggedIn = false;
        let currentEditingStudent = null;
        let isFirebaseLoaded = false;
        
        // Available terms for students
        let availableTerms = ["First Term"];
        
        // All terms in system
        let allTerms = ["First Term", "Second Term", "Final Term"];
        
        // Term messages
        let termMessages = {
            "First Term": "📢 Dear Students! First Term examination results are now available. Check your performance and keep working hard! 🌟📚",
            "Second Term": "📢 Second Term results are ready! Keep up the excellent work and prepare for the final term! 🌟📚",
            "Final Term": "📢 Final Term results are here! Congratulations on completing the academic year! 🎉📚"
        };

        // Global student message
        let globalStudentMessage = {
            content: "📢 Welcome to the Student Report Card Portal! Select your class and name to view your report cards. 🌟📚",
            style: "info",
            enabled: true
        };

        // Profile field configuration
        let profileFields = {
            name: { label: "Student Name", show: true, required: true, icon: "👦" },
            fatherName: { label: "Father's Name", show: true, required: true, icon: "👨" },
            motherName: { label: "Mother's Name", show: true, required: false, icon: "👩" },
            rollNumber: { label: "Roll Number", show: true, required: false, icon: "🔢" },
            dateOfBirth: { label: "Date of Birth", show: false, required: false, icon: "📅" },
            address: { label: "Address", show: false, required: false, icon: "🏠" },
            phoneNumber: { label: "Phone Number", show: false, required: false, icon: "📞" },
            bloodGroup: { label: "Blood Group", show: false, required: false, icon: "🩸" },
            admissionDate: { label: "Admission Date", show: false, required: false, icon: "📝" },
            previousSchool: { label: "Previous School", show: false, required: false, icon: "🏫" }
        };

        // Photo display settings
        let photoSettings = {
            showOnReportCard: true,
            photoSize: "medium", // small, medium, large
            photoPosition: "top" // top, left, right
        };

        // Default message template
        let defaultMessageTemplate = "📢 Dear Students! {TERM_NAME} examination results are now available. Check your performance and keep working hard! 🌟📚";
        
        // Subjects for each class
        let classSubjects = {
            "1": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"],
            "2": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"],
            "3": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"],
            "4": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"],
            "5": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"]
        };

        // Sample student data - This ensures the system always has working data
        let studentsData = {
            "1": {
                "student_1_001": {
                    name: "Aarav Sharma",
                    fatherName: "Rajesh Sharma",
                    motherName: "Sunita Sharma",
                    rollNumber: "001",
                    dateOfBirth: "2018-05-15",
                    address: "Village Karanpur, Behjam",
                    phoneNumber: "9876543210",
                    bloodGroup: "A+",
                    admissionDate: "2024-04-01",
                    previousSchool: "None",
                    photo: null,
                    class: "1",
                    marks: {
                        "First Term": {
                            "HINDI": { oral: 4, written: 12 },
                            "ENGLISH": { oral: 3, written: 10 },
                            "MATHS": { oral: 5, written: 14 },
                            "EVS": { oral: 4, written: 11 },
                            "SANSKRIT": { oral: 3, written: 9 }
                        }
                    }
                },
                "student_1_002": {
                    name: "Priya Singh",
                    fatherName: "Suresh Singh",
                    motherName: "Kavita Singh",
                    rollNumber: "002",
                    dateOfBirth: "2018-08-22",
                    address: "Village Behjam, Kheri",
                    phoneNumber: "9876543211",
                    bloodGroup: "B+",
                    admissionDate: "2024-04-01",
                    previousSchool: "None",
                    photo: null,
                    class: "1",
                    marks: {
                        "First Term": {
                            "HINDI": { oral: 5, written: 14 },
                            "ENGLISH": { oral: 4, written: 12 },
                            "MATHS": { oral: 5, written: 15 },
                            "EVS": { oral: 5, written: 13 },
                            "SANSKRIT": { oral: 4, written: 11 }
                        }
                    }
                }
            },
            "2": {
                "student_2_001": {
                    name: "Rohit Kumar",
                    fatherName: "Mohan Kumar",
                    motherName: "Geeta Kumar",
                    rollNumber: "003",
                    dateOfBirth: "2017-12-10",
                    address: "Village Karanpur, Behjam",
                    phoneNumber: "9876543212",
                    bloodGroup: "O+",
                    admissionDate: "2023-04-01",
                    previousSchool: "Anganwadi Center",
                    photo: null,
                    class: "2",
                    marks: {
                        "First Term": {
                            "HINDI": { oral: 4, written: 13 },
                            "ENGLISH": { oral: 3, written: 11 },
                            "MATHS": { oral: 5, written: 15 },
                            "EVS": { oral: 4, written: 12 },
                            "SANSKRIT": { oral: 3, written: 10 }
                        }
                    }
                }
            }
        };

        // Firebase Database Functions
        async function initializeFirebase() {
            try {
                console.log('Initializing Firebase connection...');
                
                // Test Firebase connection
                const testRef = window.firebaseDB.ref(window.firebaseDB.database, 'test');
                await window.firebaseDB.set(testRef, { connected: true, timestamp: Date.now() });
                
                isFirebaseLoaded = true;
                console.log('✅ Firebase connected successfully!');
                
                // Load data from Firebase
                await loadAllDataFromFirebase();
                
                showAlert('🔥 Firebase database connected! All data synced. ✅', 'success');
            } catch (error) {
                console.error('❌ Firebase connection failed:', error);
                showAlert('⚠️ Using offline mode. Changes will not be saved permanently.', 'warning');
                isFirebaseLoaded = false;
            }
        }

        async function loadAllDataFromFirebase() {
            try {
                console.log('Loading data from Firebase...');
                
                // Load students data
                const studentsRef = window.firebaseDB.ref(window.firebaseDB.database, 'students');
                const studentsSnapshot = await window.firebaseDB.get(studentsRef);
                if (studentsSnapshot.exists()) {
                    studentsData = studentsSnapshot.val();
                    console.log('✅ Students data loaded from Firebase');
                }

                // Load profile fields
                const profileFieldsRef = window.firebaseDB.ref(window.firebaseDB.database, 'profileFields');
                const profileFieldsSnapshot = await window.firebaseDB.get(profileFieldsRef);
                if (profileFieldsSnapshot.exists()) {
                    profileFields = profileFieldsSnapshot.val();
                    console.log('✅ Profile fields loaded from Firebase');
                }

                // Load terms data
                const termsRef = window.firebaseDB.ref(window.firebaseDB.database, 'terms');
                const termsSnapshot = await window.firebaseDB.get(termsRef);
                if (termsSnapshot.exists()) {
                    const termsData = termsSnapshot.val();
                    availableTerms = termsData.availableTerms || availableTerms;
                    allTerms = termsData.allTerms || allTerms;
                    termMessages = termsData.termMessages || termMessages;
                    console.log('✅ Terms data loaded from Firebase');
                }

                // Load global message
                const messageRef = window.firebaseDB.ref(window.firebaseDB.database, 'globalMessage');
                const messageSnapshot = await window.firebaseDB.get(messageRef);
                if (messageSnapshot.exists()) {
                    globalStudentMessage = messageSnapshot.val();
                    updateGlobalStudentMessage();
                    console.log('✅ Global message loaded from Firebase');
                }

                // Load photo settings
                const photoRef = window.firebaseDB.ref(window.firebaseDB.database, 'photoSettings');
                const photoSnapshot = await window.firebaseDB.get(photoRef);
                if (photoSnapshot.exists()) {
                    photoSettings = photoSnapshot.val();
                    console.log('✅ Photo settings loaded from Firebase');
                }

                console.log('🎉 All data loaded from Firebase successfully!');
                
            } catch (error) {
                console.error('❌ Error loading data from Firebase:', error);
                showAlert('⚠️ Error loading some data from database. Using local defaults.', 'warning');
            }
        }

        async function saveStudentsToFirebase() {
            if (!isFirebaseLoaded) return;
            
            try {
                const studentsRef = window.firebaseDB.ref(window.firebaseDB.database, 'students');
                await window.firebaseDB.set(studentsRef, studentsData);
                console.log('✅ Students data saved to Firebase');
            } catch (error) {
                console.error('❌ Error saving students to Firebase:', error);
                showAlert('⚠️ Error saving student data to database!', 'warning');
            }
        }

        async function saveProfileFieldsToFirebase() {
            if (!isFirebaseLoaded) return;
            
            try {
                const profileFieldsRef = window.firebaseDB.ref(window.firebaseDB.database, 'profileFields');
                await window.firebaseDB.set(profileFieldsRef, profileFields);
                console.log('✅ Profile fields saved to Firebase');
            } catch (error) {
                console.error('❌ Error saving profile fields to Firebase:', error);
                showAlert('⚠️ Error saving profile fields to database!', 'warning');
            }
        }

        async function saveTermsToFirebase() {
            if (!isFirebaseLoaded) return;
            
            try {
                const termsData = {
                    availableTerms,
                    allTerms,
                    termMessages
                };
                const termsRef = window.firebaseDB.ref(window.firebaseDB.database, 'terms');
                await window.firebaseDB.set(termsRef, termsData);
                console.log('✅ Terms data saved to Firebase');
            } catch (error) {
                console.error('❌ Error saving terms to Firebase:', error);
                showAlert('⚠️ Error saving terms data to database!', 'warning');
            }
        }

        async function saveGlobalMessageToFirebase() {
            if (!isFirebaseLoaded) return;
            
            try {
                const messageRef = window.firebaseDB.ref(window.firebaseDB.database, 'globalMessage');
                await window.firebaseDB.set(messageRef, globalStudentMessage);
                console.log('✅ Global message saved to Firebase');
            } catch (error) {
                console.error('❌ Error saving global message to Firebase:', error);
                showAlert('⚠️ Error saving global message to database!', 'warning');
            }
        }

        async function savePhotoSettingsToFirebase() {
            if (!isFirebaseLoaded) return;
            
            try {
                const photoRef = window.firebaseDB.ref(window.firebaseDB.database, 'photoSettings');
                await window.firebaseDB.set(photoRef, photoSettings);
                console.log('✅ Photo settings saved to Firebase');
            } catch (error) {
                console.error('❌ Error saving photo settings to Firebase:', error);
                showAlert('⚠️ Error saving photo settings to database!', 'warning');
            }
        }

        // Initialize Firebase when the app loads
        window.initializeApp = async function() {
            console.log('🚀 Starting application initialization...');
            await initializeFirebase();
            console.log('✅ Application initialized successfully!');
        };

        // Utility Functions
        function showAlert(message, type = 'error') {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        function showMessage(element, message, type) {
            if (!element) return;
            
            element.innerHTML = message;
            element.className = `text-center mt-2 font-bold ${
                type === 'success' ? 'text-green-600' : 
                type === 'warning' ? 'text-yellow-600' : 
                'text-red-600'
            }`;
            
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }

        // Tab Switching
        document.getElementById('studentTab').addEventListener('click', function() {
            this.className = "px-6 py-3 rounded-full bg-gradient-to-r from-pink-500 to-orange-500 text-white font-bold transition-all duration-300";
            document.getElementById('adminTab').className = "px-6 py-3 rounded-full text-gray-600 font-bold transition-all duration-300 hover:bg-gradient-to-r hover:from-blue-400 hover:to-purple-500 hover:text-white";
            document.getElementById('studentPortal').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
        });

        document.getElementById('adminTab').addEventListener('click', function() {
            this.className = "px-6 py-3 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 text-white font-bold transition-all duration-300";
            document.getElementById('studentTab').className = "px-6 py-3 rounded-full text-gray-600 font-bold transition-all duration-300 hover:bg-gradient-to-r hover:from-pink-400 hover:to-orange-400 hover:text-white";
            document.getElementById('studentPortal').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
        });

        // Student Portal Functions
        document.getElementById('classSelect').addEventListener('change', function() {
            const selectedClass = this.value;
            const studentSelect = document.getElementById('studentSelect');
            const availableTermsSection = document.getElementById('availableTermsSection');
            
            // Reset dependent elements
            studentSelect.innerHTML = '<option value="">Choose Student</option>';
            document.getElementById('reportCardDisplay').classList.add('hidden');
            availableTermsSection.classList.add('hidden');
            
            if (selectedClass) {
                // Enable student selection if students exist
                if (studentsData[selectedClass]) {
                    studentSelect.disabled = false;
                    Object.keys(studentsData[selectedClass]).forEach(studentId => {
                        const student = studentsData[selectedClass][studentId];
                        const option = document.createElement('option');
                        option.value = studentId;
                        option.textContent = student.name;
                        studentSelect.appendChild(option);
                    });
                }
            } else {
                studentSelect.disabled = true;
            }
        });

        document.getElementById('studentSelect').addEventListener('change', function() {
            const selectedClass = document.getElementById('classSelect').value;
            const selectedStudent = this.value;
            const availableTermsSection = document.getElementById('availableTermsSection');
            
            document.getElementById('reportCardDisplay').classList.add('hidden');
            
            if (selectedClass && selectedStudent) {
                // Show available terms for this student
                showAvailableTerms(selectedClass, selectedStudent);
                availableTermsSection.classList.remove('hidden');
            } else {
                availableTermsSection.classList.add('hidden');
            }
        });

        function showAvailableTerms(classId, studentId) {
            const student = studentsData[classId][studentId];
            const termButtons = document.getElementById('termButtons');
            termButtons.innerHTML = '';
            
            // Show only terms that are available and have marks for this student
            availableTerms.forEach(term => {
                if (student.marks && student.marks[term]) {
                    const button = document.createElement('button');
                    button.className = 'bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300';
                    button.textContent = `📊 View ${term} Report`;
                    button.onclick = () => displayReportCard(classId, studentId, term);
                    termButtons.appendChild(button);
                }
            });
            
            // If no terms have marks, show message
            if (termButtons.children.length === 0) {
                termButtons.innerHTML = '<p class="text-purple-700 font-bold text-lg">📝 No report cards available yet. Please check back later!</p>';
            }
        }

        function displayReportCard(classId, studentId, term) {
            console.log('Displaying report card:', { classId, studentId, term });
            
            // Validate data exists
            if (!studentsData[classId] || !studentsData[classId][studentId]) {
                showAlert('Student data not found!', 'error');
                return;
            }
            
            const student = studentsData[classId][studentId];
            
            if (!student.marks || !student.marks[term]) {
                showAlert(`No marks found for ${term}!`, 'warning');
                return;
            }
            
            const marks = student.marks[term];
            
            // Calculate totals - only include subjects with marks
            let totalMarks = 0;
            let totalOralMarks = 0;
            let totalWrittenMarks = 0;
            let maxTotalMarks = 0;
            let maxOralMarks = 0;
            let maxWrittenMarks = 0;
            let subjectsHTML = '';
            let subjectsWithMarks = 0;
            
            Object.keys(marks).forEach(subject => {
                const subjectMarks = marks[subject];
                const oral = subjectMarks.oral || 0;
                const written = subjectMarks.written || 0;
                const total = oral + written;
                
                // Only show subjects that have marks (either oral or written > 0)
                if (total > 0) {
                    const maxMarks = 20; // 5 oral + 15 written
                    const percentage = ((total / maxMarks) * 100).toFixed(1);
                    
                    totalMarks += total;
                    totalOralMarks += oral;
                    totalWrittenMarks += written;
                    maxTotalMarks += maxMarks;
                    maxOralMarks += 5;
                    maxWrittenMarks += 15;
                    subjectsWithMarks++;
                    
                    subjectsHTML += `
                        <tr class="border-b-2 border-gray-100 hover:bg-blue-50 transition-all duration-300">
                            <td class="py-4 px-4 font-bold text-purple-700 text-center">${subject}</td>
                            <td class="py-4 px-4 text-center font-semibold text-blue-600">${oral}</td>
                            <td class="py-4 px-4 text-center font-semibold text-green-600">${written}</td>
                            <td class="py-4 px-4 text-center font-bold text-indigo-700">${total}</td>
                            <td class="py-4 px-4 text-center font-semibold text-gray-600">20</td>
                            <td class="py-4 px-4 text-center font-semibold text-purple-600">${percentage}%</td>
                        </tr>
                    `;
                }
            });
            
            // If no subjects have marks, show message
            if (subjectsWithMarks === 0) {
                showAlert(`No marks have been entered for ${term} yet!`, 'warning');
                return;
            }
            
            const overallPercentage = ((totalMarks / maxTotalMarks) * 100).toFixed(1);
            
            // Generate dynamic profile section
            let profileHTML = '';
            let fieldsShown = 0;
            
            const fieldColors = ['blue', 'green', 'purple', 'orange', 'teal', 'pink'];
            let colorIndex = 0;
            
            // Always show class and term
            profileHTML += `
                <div class="bg-gradient-to-br from-purple-100 to-pink-100 rounded-2xl p-4 shadow-lg border-2 border-purple-200">
                    <div class="text-2xl mb-2">🎓</div>
                    <h4 class="text-lg font-bold text-purple-800 mb-1">Class & Term</h4>
                    <p class="text-xl font-bold text-purple-900">Class ${student.class} - ${term}</p>
                </div>
            `;
            fieldsShown++;
            
            Object.keys(profileFields).forEach(fieldKey => {
                const field = profileFields[fieldKey];
                
                if (field.show && student[fieldKey] && fieldsShown < 6) {
                    const color = fieldColors[colorIndex % fieldColors.length];
                    colorIndex++;
                    
                    let displayValue = student[fieldKey];
                    if (fieldKey === 'dateOfBirth' || fieldKey === 'admissionDate') {
                        displayValue = new Date(student[fieldKey]).toLocaleDateString();
                    }
                    
                    profileHTML += `
                        <div class="bg-gradient-to-br from-${color}-100 to-${color === 'yellow' ? 'orange' : color}-100 rounded-2xl p-4 shadow-lg border-2 border-${color}-200">
                            <div class="text-2xl mb-2">${field.icon}</div>
                            <h4 class="text-lg font-bold text-${color}-800 mb-1">${field.label}</h4>
                            <p class="text-xl font-bold text-${color}-900">${displayValue}</p>
                        </div>
                    `;
                    fieldsShown++;
                }
            });
            
            // Generate report card HTML
            const reportCardHTML = `
                <div class="bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-3xl p-8 shadow-2xl border-4 border-blue-300">
                    <div class="text-center mb-8">
                        <h3 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-6">📋 REPORT CARD 📋</h3>
                        
                        <div class="grid md:grid-cols-3 gap-4 mb-6">
                            ${profileHTML}
                        </div>
                    </div>

                    <div class="overflow-x-auto mb-6">
                        <table class="w-full bg-white rounded-2xl shadow-lg overflow-hidden">
                            <thead class="bg-gradient-to-r from-purple-500 to-pink-600 text-white">
                                <tr>
                                    <th class="py-4 px-4 text-center font-bold text-lg">📚 Subject</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">🗣️ Oral</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">✍️ Written</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">📝 Total</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">💯 Max</th>
                                    <th class="py-4 px-4 text-center font-bold text-lg">📊 %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${subjectsHTML}
                                <tr class="bg-gradient-to-r from-yellow-100 to-orange-100 border-t-4 border-orange-300">
                                    <td class="py-4 px-4 font-bold text-orange-700 text-center text-lg">🏆 TOTAL</td>
                                    <td class="py-4 px-4 text-center font-bold text-blue-700 text-xl">${totalOralMarks}</td>
                                    <td class="py-4 px-4 text-center font-bold text-green-700 text-xl">${totalWrittenMarks}</td>
                                    <td class="py-4 px-4 text-center font-bold text-orange-700 text-xl">${totalMarks}</td>
                                    <td class="py-4 px-4 text-center font-bold text-lg">${maxTotalMarks}</td>
                                    <td class="py-4 px-4 text-center font-bold text-orange-700 text-xl">${overallPercentage}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-gradient-to-r from-green-100 to-blue-100 rounded-2xl p-6 shadow-lg border-2 border-green-200">
                            <h5 class="text-xl font-bold text-green-700 mb-3">📈 Performance Summary</h5>
                            <div class="space-y-2">
                                <p class="font-semibold text-blue-600">📊 Overall Percentage: <span class="text-blue-700 text-lg">${overallPercentage}%</span></p>
                                <p class="font-semibold text-purple-600">📚 Subjects Evaluated: <span class="text-purple-700">${subjectsWithMarks}</span></p>
                                <p class="font-semibold text-orange-600">🗣️ Total Oral Marks: <span class="text-orange-700">${totalOralMarks}/${maxOralMarks}</span></p>
                                <p class="font-semibold text-teal-600">✍️ Total Written Marks: <span class="text-teal-700">${totalWrittenMarks}/${maxWrittenMarks}</span></p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl p-6 shadow-lg border-2 border-purple-200">
                            <h5 class="text-xl font-bold text-purple-700 mb-3">💬 Teacher's Remarks</h5>
                            <p class="text-purple-600 font-semibold">
                                ${overallPercentage >= 90 ? '🌟 Excellent performance! Keep up the outstanding work!' :
                                  overallPercentage >= 80 ? '👏 Very good work! Continue your efforts!' :
                                  overallPercentage >= 70 ? '👍 Good progress! Keep improving!' :
                                  overallPercentage >= 60 ? '📚 Satisfactory work. Focus on weak areas!' :
                                  overallPercentage >= 40 ? '⚠️ Needs improvement. Work harder!' :
                                  '🔄 Requires significant effort. Please study more!'}
                            </p>
                        </div>
                    </div>

                    <div class="text-center mt-6">
                        <div class="bg-gradient-to-r from-blue-100 to-purple-100 rounded-2xl p-4 border-2 border-blue-200">
                            <p class="text-blue-700 font-bold text-lg">🎉 Great job! Keep up the excellent work! 🌟</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('reportCardContent').innerHTML = reportCardHTML;
            document.getElementById('reportCardDisplay').classList.remove('hidden');
            document.getElementById('reportCardDisplay').scrollIntoView({ behavior: 'smooth' });
            
            showAlert('Report card loaded successfully! ✅', 'success');
        }

        // Admin Functions
        document.getElementById('adminLoginBtn').addEventListener('click', function() {
            const password = document.getElementById('adminPassword').value;
            const loginMessage = document.getElementById('loginMessage');
            
            if (password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                showAlert('Welcome Admin! 🎉', 'success');
            } else {
                showMessage(loginMessage, 'Incorrect password! ❌', 'error');
                document.getElementById('adminPassword').value = '';
            }
        });

        // Admin class selection
        document.getElementById('adminClassSelect').addEventListener('change', function() {
            const selectedClass = this.value;
            const adminTermSelect = document.getElementById('adminTermSelect');
            const adminStudentSelect = document.getElementById('adminStudentSelect');
            const addStudentBtn = document.getElementById('addStudentBtn');
            
            // Reset dependent dropdowns
            adminTermSelect.innerHTML = '<option value="">Choose Term</option>';
            adminStudentSelect.innerHTML = '<option value="">Choose Student</option>';
            document.getElementById('marksTable').classList.add('hidden');
            
            if (selectedClass) {
                // Enable term selection
                adminTermSelect.disabled = false;
                allTerms.forEach(term => {
                    const option = document.createElement('option');
                    option.value = term;
                    option.textContent = term;
                    adminTermSelect.appendChild(option);
                });
                
                // Enable student selection and add button
                adminStudentSelect.disabled = false;
                addStudentBtn.disabled = false;
                
                if (studentsData[selectedClass]) {
                    Object.keys(studentsData[selectedClass]).forEach(studentId => {
                        const student = studentsData[selectedClass][studentId];
                        const option = document.createElement('option');
                        option.value = studentId;
                        option.textContent = student.name;
                        adminStudentSelect.appendChild(option);
                    });
                }
            } else {
                adminTermSelect.disabled = true;
                adminStudentSelect.disabled = true;
                addStudentBtn.disabled = true;
            }
        });

        // Admin term selection
        document.getElementById('adminTermSelect').addEventListener('change', function() {
            // Hide marks table when term changes
            document.getElementById('marksTable').classList.add('hidden');
        });

        // Admin student selection
        document.getElementById('adminStudentSelect').addEventListener('change', function() {
            // Hide marks table when student changes
            document.getElementById('marksTable').classList.add('hidden');
        });

        // Add Student Button
        document.getElementById('addStudentBtn').addEventListener('click', function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            if (!selectedClass) {
                showAlert('Please select a class first! ⚠️', 'warning');
                return;
            }
            
            currentEditingStudent = null;
            document.getElementById('studentFormTitle').textContent = '➕ Add New Student';
            generateStudentForm();
            document.getElementById('studentForm').classList.remove('hidden');
            document.getElementById('studentForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Edit Student Button
        document.getElementById('editStudentBtn').addEventListener('click', function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            const selectedStudent = document.getElementById('adminStudentSelect').value;
            
            if (!selectedClass || !selectedStudent) {
                showAlert('Please select a class and student first! ⚠️', 'warning');
                return;
            }
            
            currentEditingStudent = selectedStudent;
            const student = studentsData[selectedClass][selectedStudent];
            document.getElementById('studentFormTitle').textContent = `✏️ Edit ${student.name}'s Profile`;
            generateStudentForm(student);
            document.getElementById('studentForm').classList.remove('hidden');
            document.getElementById('studentForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Delete Student Button
        document.getElementById('deleteStudentBtn').addEventListener('click', async function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            const selectedStudent = document.getElementById('adminStudentSelect').value;
            
            if (!selectedClass || !selectedStudent) {
                showAlert('Please select a class and student first! ⚠️', 'warning');
                return;
            }
            
            const student = studentsData[selectedClass][selectedStudent];
            if (confirm(`Are you sure you want to delete ${student.name}?\n\nThis will permanently remove all their data including marks!`)) {
                // Delete from local data
                delete studentsData[selectedClass][selectedStudent];
                
                // Save to Firebase
                await saveStudentsToFirebase();
                
                // Refresh admin student dropdown
                refreshAdminStudentDropdown(selectedClass);
                
                // Refresh student portal dropdown if same class is selected
                const studentClassSelect = document.getElementById('classSelect');
                if (studentClassSelect.value === selectedClass) {
                    refreshStudentDropdown(selectedClass);
                }
                
                document.getElementById('marksTable').classList.add('hidden');
                showAlert('Student deleted successfully! 💾✅', 'success');
            }
        });

        // Profile Fields Button
        document.getElementById('profileFieldsBtn').addEventListener('click', function() {
            generateCombinedProfileFieldsList();
            document.getElementById('profileFieldsForm').classList.remove('hidden');
            document.getElementById('profileFieldsForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Term Management Button
        document.getElementById('termManagementBtn').addEventListener('click', function() {
            generateTermsList();
            document.getElementById('termManagementForm').classList.remove('hidden');
            document.getElementById('termManagementForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Combined Terms Button
        document.getElementById('combinedTermsBtn').addEventListener('click', function() {
            generateAllTermsTable();
            document.getElementById('combinedTermsForm').classList.remove('hidden');
            document.getElementById('combinedTermsForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Global Message Button
        document.getElementById('globalMessageBtn').addEventListener('click', function() {
            // Load current global message settings
            document.getElementById('globalMessageContent').value = globalStudentMessage.content;
            document.getElementById('globalMessageStyle').value = globalStudentMessage.style;
            document.getElementById('globalMessageEnabled').checked = globalStudentMessage.enabled;
            updateGlobalMessagePreview();
            
            document.getElementById('globalMessageForm').classList.remove('hidden');
            document.getElementById('globalMessageForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Photo Settings Button
        document.getElementById('photoSettingsBtn').addEventListener('click', function() {
            // Load current photo settings
            document.getElementById('showPhotosOnReportCard').checked = photoSettings.showOnReportCard;
            document.getElementById('photoSizeSelect').value = photoSettings.photoSize;
            document.getElementById('photoPositionSelect').value = photoSettings.photoPosition;
            updatePhotoSettingsPreview();
            
            document.getElementById('photoSettingsForm').classList.remove('hidden');
            document.getElementById('photoSettingsForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Download Tabulation Button
        document.getElementById('downloadTabulationBtn').addEventListener('click', function() {
            document.getElementById('tabulationDownloadForm').classList.remove('hidden');
            document.getElementById('tabulationDownloadForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Manage Marks Button
        document.getElementById('manageMarksBtn').addEventListener('click', function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            const selectedTerm = document.getElementById('adminTermSelect').value;
            const selectedStudent = document.getElementById('adminStudentSelect').value;
            
            if (!selectedClass || !selectedTerm || !selectedStudent) {
                showAlert('Please select class, term, and student first! ⚠️', 'warning');
                return;
            }
            
            showMarksTable(selectedClass, selectedTerm, selectedStudent);
        });

        // Save Student Button
        document.getElementById('saveStudentBtn').addEventListener('click', async function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            
            if (!selectedClass) {
                showAlert('Please select a class! ⚠️', 'warning');
                return;
            }
            
            // Collect all form data
            const studentData = { class: selectedClass, marks: {} };
            let hasRequiredFields = true;
            
            Object.keys(profileFields).forEach(fieldKey => {
                const field = profileFields[fieldKey];
                const input = document.getElementById(`student_${fieldKey}`);
                
                if (input) {
                    const value = input.value.trim();
                    
                    if (field.required && !value) {
                        hasRequiredFields = false;
                        showAlert(`${field.label} is required! ⚠️`, 'warning');
                        return;
                    }
                    
                    studentData[fieldKey] = value;
                }
            });
            
            if (!hasRequiredFields) return;
            
            if (!studentsData[selectedClass]) {
                studentsData[selectedClass] = {};
            }
            
            const studentId = currentEditingStudent || `student_${selectedClass}_${Date.now()}`;
            
            // Preserve existing marks if editing
            if (currentEditingStudent && studentsData[selectedClass][currentEditingStudent]) {
                studentData.marks = studentsData[selectedClass][currentEditingStudent].marks || {};
            }
            
            // Save to local data
            studentsData[selectedClass][studentId] = studentData;
            
            // Save to Firebase
            await saveStudentsToFirebase();
            
            // Refresh dropdowns
            refreshAdminStudentDropdown(selectedClass);
            
            const studentClassSelect = document.getElementById('classSelect');
            if (studentClassSelect.value === selectedClass) {
                refreshStudentDropdown(selectedClass);
            }
            
            document.getElementById('studentForm').classList.add('hidden');
            showAlert(currentEditingStudent ? 'Student updated successfully! 💾✅' : 'Student added successfully! 💾✅', 'success');
            
            currentEditingStudent = null;
        });

        // Cancel Form Button
        document.getElementById('cancelFormBtn').addEventListener('click', function() {
            document.getElementById('studentForm').classList.add('hidden');
            currentEditingStudent = null;
        });

        // Save Marks Button
        document.getElementById('saveMarksBtn').addEventListener('click', async function() {
            await saveStudentsToFirebase();
            showAlert('All marks saved successfully! 💾✅', 'success');
        });

        // Add New Field Button
        document.getElementById('addNewFieldBtn').addEventListener('click', async function() {
            const fieldName = document.getElementById('newFieldName').value.trim();
            const fieldLabel = document.getElementById('newFieldLabel').value.trim();
            const fieldIcon = document.getElementById('newFieldIcon').value.trim();
            
            if (!fieldName || !fieldLabel || !fieldIcon) {
                showAlert('Please fill all field details! ⚠️', 'warning');
                return;
            }
            
            const fieldKey = fieldName.toLowerCase().replace(/\s+/g, '');
            
            if (profileFields[fieldKey]) {
                showAlert('Field already exists! ⚠️', 'warning');
                return;
            }
            
            profileFields[fieldKey] = {
                label: fieldLabel,
                show: true,
                required: false,
                icon: fieldIcon,
                custom: true
            };
            
            // Clear form
            document.getElementById('newFieldName').value = '';
            document.getElementById('newFieldLabel').value = '';
            document.getElementById('newFieldIcon').value = '';
            
            generateCombinedProfileFieldsList();
            await saveProfileFieldsToFirebase();
            showAlert('New field added successfully! 💾✅', 'success');
        });

        // Save Profile Fields Button
        document.getElementById('saveProfileFieldsBtn').addEventListener('click', async function() {
            await saveProfileFieldsToFirebase();
            showAlert('Profile field settings saved! 💾✅', 'success');
            document.getElementById('profileFieldsForm').classList.add('hidden');
        });

        // Cancel Profile Fields Button
        document.getElementById('cancelProfileFieldsBtn').addEventListener('click', function() {
            document.getElementById('profileFieldsForm').classList.add('hidden');
        });

        // Save Term Settings Button
        document.getElementById('saveTermSettingsBtn').addEventListener('click', async function() {
            await saveTermsToFirebase();
            showAlert('Term settings saved! 💾✅', 'success');
            document.getElementById('termManagementForm').classList.add('hidden');
        });

        // Cancel Term Management Button
        document.getElementById('cancelTermManagementBtn').addEventListener('click', function() {
            document.getElementById('termManagementForm').classList.add('hidden');
        });

        // Save Combined Terms Button
        document.getElementById('saveCombinedTermsBtn').addEventListener('click', async function() {
            await saveTermsToFirebase();
            showAlert('All term changes saved! 💾✅', 'success');
            document.getElementById('combinedTermsForm').classList.add('hidden');
        });

        // Cancel Combined Terms Button
        document.getElementById('cancelCombinedTermsBtn').addEventListener('click', function() {
            document.getElementById('combinedTermsForm').classList.add('hidden');
        });

        // Global Message Content Change
        document.getElementById('globalMessageContent').addEventListener('input', updateGlobalMessagePreview);
        document.getElementById('globalMessageStyle').addEventListener('change', updateGlobalMessagePreview);

        // Save Global Message Button
        document.getElementById('saveGlobalMessageBtn').addEventListener('click', async function() {
            globalStudentMessage.content = document.getElementById('globalMessageContent').value.trim();
            globalStudentMessage.style = document.getElementById('globalMessageStyle').value;
            globalStudentMessage.enabled = document.getElementById('globalMessageEnabled').checked;
            
            updateGlobalStudentMessage();
            await saveGlobalMessageToFirebase();
            document.getElementById('globalMessageForm').classList.add('hidden');
            showAlert('Global message updated successfully! 💾✅', 'success');
        });

        // Cancel Global Message Button
        document.getElementById('cancelGlobalMessageBtn').addEventListener('click', function() {
            document.getElementById('globalMessageForm').classList.add('hidden');
        });

        // Photo Settings Change Handlers
        document.getElementById('showPhotosOnReportCard').addEventListener('change', updatePhotoSettingsPreview);
        document.getElementById('photoSizeSelect').addEventListener('change', updatePhotoSettingsPreview);
        document.getElementById('photoPositionSelect').addEventListener('change', updatePhotoSettingsPreview);

        // Save Photo Settings Button
        document.getElementById('savePhotoSettingsBtn').addEventListener('click', async function() {
            photoSettings.showOnReportCard = document.getElementById('showPhotosOnReportCard').checked;
            photoSettings.photoSize = document.getElementById('photoSizeSelect').value;
            photoSettings.photoPosition = document.getElementById('photoPositionSelect').value;
            
            await savePhotoSettingsToFirebase();
            document.getElementById('photoSettingsForm').classList.add('hidden');
            showAlert('Photo settings updated successfully! 💾✅', 'success');
        });

        // Cancel Photo Settings Button
        document.getElementById('cancelPhotoSettingsBtn').addEventListener('click', function() {
            document.getElementById('photoSettingsForm').classList.add('hidden');
        });

        // Tabulation Class Selection
        document.getElementById('tabulationClassSelect').addEventListener('change', function() {
            const selectedClass = this.value;
            const termSelect = document.getElementById('tabulationTermSelect');
            
            // Reset term selection
            termSelect.innerHTML = '<option value="">Choose Term</option>';
            termSelect.disabled = !selectedClass;
            
            if (selectedClass) {
                // Populate terms
                allTerms.forEach(term => {
                    const option = document.createElement('option');
                    option.value = term;
                    option.textContent = term;
                    termSelect.appendChild(option);
                });
            }
            
            updateTabulationButtons();
        });

        // Tabulation Term Selection
        document.getElementById('tabulationTermSelect').addEventListener('change', updateTabulationButtons);

        // Generate Tabulation Button
        document.getElementById('generateTabulationBtn').addEventListener('click', function() {
            const selectedClass = document.getElementById('tabulationClassSelect').value;
            const selectedTerm = document.getElementById('tabulationTermSelect').value;
            
            if (!selectedClass || !selectedTerm) {
                showAlert('Please select both class and term! ⚠️', 'warning');
                return;
            }
            
            generateCSVTabulation(selectedClass, selectedTerm);
        });

        // Cancel Tabulation Button
        document.getElementById('cancelTabulationBtn').addEventListener('click', function() {
            document.getElementById('tabulationDownloadForm').classList.add('hidden');
        });

        // Helper Functions
        function generateStudentForm(student = null) {
            const formFields = document.getElementById('studentFormFields');
            formFields.innerHTML = '';
            
            const fieldColors = [
                'blue', 'green', 'purple', 'orange', 'teal', 'pink', 'indigo', 'red', 'yellow', 'cyan'
            ];
            
            let colorIndex = 0;
            
            // Add other profile fields
            Object.keys(profileFields).forEach(fieldKey => {
                const field = profileFields[fieldKey];
                if (!field.show) return; // Only show enabled fields
                
                const color = fieldColors[colorIndex % fieldColors.length];
                colorIndex++;
                
                const fieldDiv = document.createElement('div');
                fieldDiv.className = `bg-white rounded-2xl p-4 shadow-lg`;
                
                const inputType = fieldKey === 'dateOfBirth' || fieldKey === 'admissionDate' ? 'date' : 
                                 fieldKey === 'phoneNumber' ? 'tel' : 'text';
                
                fieldDiv.innerHTML = `
                    <label class="block text-lg font-bold text-${color}-600 mb-2">
                        ${field.icon} ${field.label}${field.required ? ' *' : ''}
                    </label>
                    <input type="${inputType}" 
                           id="student_${fieldKey}" 
                           class="w-full p-3 border-2 border-${color}-300 rounded-xl focus:border-${color}-500 focus:outline-none" 
                           placeholder="Enter ${field.label.toLowerCase()}"
                           value="${student ? (student[fieldKey] || '') : ''}"
                           ${field.required ? 'required' : ''}>
                `;
                
                formFields.appendChild(fieldDiv);
            });
        }

        function refreshAdminStudentDropdown(classId) {
            const adminStudentSelect = document.getElementById('adminStudentSelect');
            adminStudentSelect.innerHTML = '<option value="">Choose Student</option>';
            
            if (studentsData[classId]) {
                Object.keys(studentsData[classId]).forEach(studentId => {
                    const student = studentsData[classId][studentId];
                    const option = document.createElement('option');
                    option.value = studentId;
                    option.textContent = student.name;
                    adminStudentSelect.appendChild(option);
                });
            }
        }

        function refreshStudentDropdown(classId) {
            const studentSelect = document.getElementById('studentSelect');
            studentSelect.innerHTML = '<option value="">Choose Student</option>';
            
            if (studentsData[classId]) {
                Object.keys(studentsData[classId]).forEach(studentId => {
                    const student = studentsData[classId][studentId];
                    const option = document.createElement('option');
                    option.value = studentId;
                    option.textContent = student.name;
                    studentSelect.appendChild(option);
                });
            }
        }

        function showMarksTable(classId, term, studentId) {
            const student = studentsData[classId][studentId];
            const tableTitle = document.getElementById('marksTableTitle');
            const tableBody = document.getElementById('marksTableBody');
            
            tableTitle.textContent = `📊 ${student.name} - ${term} Marks`;
            
            // Initialize marks if they don't exist
            if (!student.marks) {
                student.marks = {};
            }
            if (!student.marks[term]) {
                student.marks[term] = {};
            }
            
            let tableHTML = '';
            classSubjects[classId].forEach(subject => {
                if (!student.marks[term][subject]) {
                    student.marks[term][subject] = { oral: 0, written: 0 };
                }
                
                const marks = student.marks[term][subject];
                const total = (marks.oral || 0) + (marks.written || 0);
                
                tableHTML += `
                    <tr class="border-b-2 border-gray-100 hover:bg-blue-50 transition-all duration-300">
                        <td class="py-4 px-4 font-bold text-purple-700 text-center">${subject}</td>
                        <td class="py-4 px-4 text-center">
                            <input type="number" min="0" max="5" value="${marks.oral || 0}" 
                                   class="w-20 p-2 border-2 border-blue-300 rounded-lg text-center font-bold focus:border-blue-500 focus:outline-none"
                                   onchange="updateMark('${classId}', '${studentId}', '${term}', '${subject}', 'oral', this.value)">
                        </td>
                        <td class="py-4 px-4 text-center">
                            <input type="number" min="0" max="15" value="${marks.written || 0}" 
                                   class="w-20 p-2 border-2 border-green-300 rounded-lg text-center font-bold focus:border-green-500 focus:outline-none"
                                   onchange="updateMark('${classId}', '${studentId}', '${term}', '${subject}', 'written', this.value)">
                        </td>
                        <td class="py-4 px-4 text-center font-bold text-indigo-700" id="total-${subject}">${total}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            document.getElementById('marksTable').classList.remove('hidden');
            document.getElementById('marksTable').scrollIntoView({ behavior: 'smooth' });
        }

        function generateCombinedProfileFieldsList() {
            const fieldsList = document.getElementById('profileFieldsList');
            fieldsList.innerHTML = '';
            
            Object.keys(profileFields).forEach(fieldKey => {
                const field = profileFields[fieldKey];
                const isDefault = ['name', 'fatherName'].includes(fieldKey);
                
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'bg-gradient-to-r from-violet-100 to-purple-100 p-4 rounded-xl border-2 border-violet-200 shadow-lg';
                
                fieldDiv.innerHTML = `
                    <div class="grid md:grid-cols-4 gap-4 items-center">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${field.icon}</span>
                            <div>
                                <span class="font-bold text-violet-700 text-lg">${field.label}</span>
                                ${isDefault ? '<br><span class="text-xs text-gray-500 font-semibold">Default Field</span>' : '<br><span class="text-xs text-blue-500 font-semibold">Custom Field</span>'}
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <label class="flex items-center justify-center cursor-pointer">
                                <input type="checkbox" 
                                       class="w-5 h-5 text-violet-600 border-2 border-violet-300 rounded focus:ring-violet-500"
                                       ${field.show ? 'checked' : ''}
                                       ${isDefault ? 'disabled' : ''}
                                       onchange="toggleFieldVisibility('${fieldKey}', this.checked)">
                                <span class="ml-2 text-violet-700 font-semibold text-sm">Show</span>
                            </label>
                        </div>
                        
                        <div class="text-center">
                            <label class="flex items-center justify-center cursor-pointer">
                                <input type="checkbox" 
                                       class="w-5 h-5 text-red-600 border-2 border-red-300 rounded focus:ring-red-500"
                                       ${field.required ? 'checked' : ''}
                                       ${isDefault ? 'disabled' : ''}
                                       onchange="toggleFieldRequired('${fieldKey}', this.checked)">
                                <span class="ml-2 text-red-700 font-semibold text-sm">Required</span>
                            </label>
                        </div>
                        
                        <div class="text-center">
                            ${field.custom ? `
                                <button onclick="deleteCustomField('${fieldKey}')" 
                                        class="bg-red-500 text-white px-3 py-2 rounded-lg font-bold hover:bg-red-600 transition-all duration-300 text-sm">
                                    🗑️ Delete
                                </button>
                            ` : `
                                <span class="text-xs text-gray-500 font-semibold bg-gray-200 px-2 py-1 rounded-lg">Protected</span>
                            `}
                        </div>
                    </div>
                `;
                
                fieldsList.appendChild(fieldDiv);
            });
        }

        function generateTermsList() {
            const termsList = document.getElementById('termsList');
            termsList.innerHTML = '';
            
            allTerms.forEach((term, index) => {
                const termDiv = document.createElement('div');
                termDiv.className = 'bg-gradient-to-r from-purple-100 to-pink-100 p-4 rounded-xl border-2 border-purple-200 shadow-lg';
                
                const isVisible = availableTerms.includes(term);
                const isDefault = ['First Term', 'Second Term', 'Final Term'].includes(term);
                
                termDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">📅</span>
                            <div>
                                <span class="font-bold text-purple-700 text-lg">${term}</span>
                                <div class="text-sm ${isVisible ? 'text-green-600' : 'text-red-600'} font-semibold">
                                    ${isVisible ? '👁️ Visible to Students' : '🚫 Hidden from Students'}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" 
                                       class="w-5 h-5 text-purple-600 border-2 border-purple-300 rounded focus:ring-purple-500"
                                       ${isVisible ? 'checked' : ''}
                                       onchange="toggleTermVisibility('${term}', this.checked)">
                                <span class="ml-2 text-purple-700 font-semibold">Show to Students</span>
                            </label>
                            ${!isDefault ? `
                                <button onclick="deleteTerm('${term}')" class="bg-red-500 text-white px-3 py-2 rounded-lg font-bold hover:bg-red-600 transition-all duration-300 text-sm">
                                    🗑️ Delete
                                </button>
                            ` : `
                                <span class="text-xs text-gray-500 font-semibold bg-gray-200 px-2 py-1 rounded-lg">Default</span>
                            `}
                        </div>
                    </div>
                `;
                
                termsList.appendChild(termDiv);
            });
        }

        function generateAllTermsTable() {
            const tableBody = document.getElementById('allTermsTableBody');
            tableBody.innerHTML = '';
            
            allTerms.forEach(term => {
                const isVisible = availableTerms.includes(term);
                const isDefault = ['First Term', 'Second Term', 'Final Term'].includes(term);
                
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-all duration-300';
                
                row.innerHTML = `
                    <td class="py-3 px-4">
                        <div class="flex items-center">
                            <span class="text-xl mr-2">📅</span>
                            <div>
                                <span class="font-bold text-teal-700">${term}</span>
                                ${isDefault ? '<span class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full">Default</span>' : '<span class="ml-2 text-xs bg-blue-200 text-blue-600 px-2 py-1 rounded-full">Custom</span>'}
                            </div>
                        </div>
                    </td>
                    <td class="py-3 px-4 text-center">
                        <label class="flex items-center justify-center cursor-pointer">
                            <input type="checkbox" 
                                   class="w-5 h-5 text-teal-600 border-2 border-teal-300 rounded focus:ring-teal-500"
                                   ${isVisible ? 'checked' : ''}
                                   onchange="toggleTermVisibilityFromTable('${term}', this.checked)">
                            <span class="ml-2 ${isVisible ? 'text-green-600' : 'text-red-600'} font-semibold">
                                ${isVisible ? '👁️ Visible' : '🚫 Hidden'}
                            </span>
                        </label>
                    </td>
                    <td class="py-3 px-4 text-center">
                        <div class="flex justify-center gap-2">
                            ${!isDefault ? `
                                <button onclick="deleteTermFromTable('${term}')" 
                                        class="bg-red-500 text-white px-3 py-1 rounded-lg font-bold hover:bg-red-600 transition-all duration-300 text-sm">
                                    🗑️ Delete
                                </button>
                            ` : `
                                <span class="text-xs text-gray-500 font-semibold bg-gray-200 px-2 py-1 rounded-lg">Protected</span>
                            `}
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function updateGlobalMessagePreview() {
            const content = document.getElementById('globalMessageContent').value.trim();
            const style = document.getElementById('globalMessageStyle').value;
            const preview = document.getElementById('globalMessagePreview');
            
            const styleConfig = {
                info: { bg: 'from-orange-100 via-yellow-100 to-red-100', border: 'border-orange-300', text: 'text-orange-800', title: 'text-orange-700', icon: '📢' },
                success: { bg: 'from-green-100 via-emerald-100 to-teal-100', border: 'border-green-300', text: 'text-green-800', title: 'text-green-700', icon: '✅' },
                warning: { bg: 'from-yellow-100 via-amber-100 to-orange-100', border: 'border-yellow-300', text: 'text-yellow-800', title: 'text-yellow-700', icon: '⚠️' },
                announcement: { bg: 'from-blue-100 via-indigo-100 to-purple-100', border: 'border-blue-300', text: 'text-blue-800', title: 'text-blue-700', icon: '📣' }
            };
            
            const config = styleConfig[style];
            
            preview.className = `bg-gradient-to-br ${config.bg} rounded-xl p-4 border-2 ${config.border}`;
            preview.innerHTML = `
                <div class="text-center">
                    <div class="text-xl mb-2">${config.icon}</div>
                    <h6 class="text-md font-bold ${config.title} mb-2">Important Message</h6>
                    <div class="${config.text} font-bold">${content || 'Enter your message above...'}</div>
                </div>
            `;
        }

        function updateGlobalStudentMessage() {
            const messageDiv = document.getElementById('globalStudentMessage');
            
            if (!globalStudentMessage.enabled) {
                messageDiv.parentElement.style.display = 'none';
                return;
            }
            
            messageDiv.parentElement.style.display = 'block';
            
            const styleConfig = {
                info: { bg: 'from-orange-100 via-yellow-100 to-red-100', border: 'border-orange-300', text: 'text-orange-800', title: 'text-orange-700' },
                success: { bg: 'from-green-100 via-emerald-100 to-teal-100', border: 'border-green-300', text: 'text-green-800', title: 'text-green-700' },
                warning: { bg: 'from-yellow-100 via-amber-100 to-orange-100', border: 'border-yellow-300', text: 'text-yellow-800', title: 'text-yellow-700' },
                announcement: { bg: 'from-blue-100 via-indigo-100 to-purple-100', border: 'border-blue-300', text: 'text-blue-800', title: 'text-blue-700' }
            };
            
            const config = styleConfig[globalStudentMessage.style];
            const container = messageDiv.parentElement;
            
            container.className = `bg-gradient-to-br ${config.bg} rounded-2xl p-6 shadow-lg border-2 ${config.border} mb-6`;
            container.querySelector('h3').className = `text-lg font-bold ${config.title} mb-3`;
            messageDiv.className = `${config.text} font-bold text-lg`;
            messageDiv.textContent = globalStudentMessage.content;
        }

        function updatePhotoSettingsPreview() {
            const showPhotos = document.getElementById('showPhotosOnReportCard').checked;
            const photoSize = document.getElementById('photoSizeSelect').value;
            const photoPosition = document.getElementById('photoPositionSelect').value;
            
            document.getElementById('previewDisplay').textContent = showPhotos ? 'Enabled' : 'Disabled';
            
            const sizeMap = {
                small: 'Small (80x80px)',
                medium: 'Medium (120x120px)',
                large: 'Large (160x160px)'
            };
            document.getElementById('previewSize').textContent = sizeMap[photoSize];
            
            const positionMap = {
                top: 'Top of Profile Section',
                left: 'Left Side of Profile',
                right: 'Right Side of Profile'
            };
            document.getElementById('previewPosition').textContent = positionMap[photoPosition];
        }

        function updateTabulationButtons() {
            const selectedClass = document.getElementById('tabulationClassSelect').value;
            const selectedTerm = document.getElementById('tabulationTermSelect').value;
            
            const canGenerate = selectedClass && selectedTerm;
            
            document.getElementById('generateTabulationBtn').disabled = !canGenerate;
            
            if (canGenerate) {
                document.getElementById('generateTabulationBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                document.getElementById('generateTabulationBtn').classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function generateCSVTabulation(classId, term) {
            const students = studentsData[classId];
            if (!students) {
                showAlert('No students found for this class! ⚠️', 'warning');
                return;
            }
            
            const subjects = classSubjects[classId];
            const schoolName = "Primary School Karanpur";
            
            const fileName = `Class_${classId}_${term}_Tabulation.csv`;
            
            let csvContent = '';
            
            // Add header information
            csvContent += `${schoolName}\n`;
            csvContent += `Block-Behjam, District-Lakhimpur-Kheri\n`;
            csvContent += `Class ${classId} - ${term} Tabulation Sheet\n`;
            csvContent += `Generated on: ${new Date().toLocaleDateString()}\n\n`;
            
            // Add column headers
            csvContent += 'S.No,Student Name,Roll No,Father\'s Name,';
            subjects.forEach(subject => {
                csvContent += `${subject} Oral,${subject} Written,${subject} Total,`;
            });
            csvContent += 'Grand Total,Max Marks,Percentage,Grade\n';
            
            // Generate student data
            let serialNo = 1;
            Object.keys(students).forEach(studentId => {
                const student = students[studentId];
                
                if (!student.marks || !student.marks[term]) return;
                
                const marks = student.marks[term];
                let totalMarks = 0;
                let maxMarks = 0;
                
                let row = `${serialNo},"${student.name}","${student.rollNumber || '-'}","${student.fatherName}",`;
                
                subjects.forEach(subject => {
                    const subjectMarks = marks[subject] || { oral: 0, written: 0 };
                    const oral = subjectMarks.oral || 0;
                    const written = subjectMarks.written || 0;
                    const total = oral + written;
                    
                    totalMarks += total;
                    maxMarks += 20;
                    
                    row += `${oral},${written},${total},`;
                });
                
                const percentage = maxMarks > 0 ? ((totalMarks / maxMarks) * 100).toFixed(1) : 0;
                const grade = getGrade(percentage);
                
                row += `${totalMarks},${maxMarks},${percentage}%,${grade}\n`;
                csvContent += row;
                serialNo++;
            });
            
            // Add summary
            csvContent += '\n\nClass Statistics:\n';
            csvContent += `Total Students: ${serialNo - 1}\n`;
            csvContent += `Subjects: ${subjects.join(', ')}\n`;
            csvContent += `Maximum Possible Marks per Subject: 20 (5 Oral + 15 Written)\n`;
            csvContent += `Total Maximum Marks: ${subjects.length * 20}\n`;
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert(`Tabulation sheet downloaded successfully! 📊✅`, 'success');
            } else {
                showAlert('Download not supported in this browser! ⚠️', 'warning');
            }
        }

        function getGrade(percentage) {
            if (percentage >= 90) return 'A+';
            if (percentage >= 80) return 'A';
            if (percentage >= 70) return 'B+';
            if (percentage >= 60) return 'B';
            if (percentage >= 50) return 'C+';
            if (percentage >= 40) return 'C';
            if (percentage >= 33) return 'D';
            return 'F';
        }

        // Global function for updating marks
        window.updateMark = async function(classId, studentId, term, subject, type, value) {
            const numValue = parseInt(value) || 0;
            studentsData[classId][studentId].marks[term][subject][type] = numValue;
            
            const marks = studentsData[classId][studentId].marks[term][subject];
            const total = (marks.oral || 0) + (marks.written || 0);
            
            const totalCell = document.getElementById(`total-${subject}`);
            if (totalCell) {
                totalCell.textContent = total;
            }
            
            // Auto-save to Firebase when marks are updated
            await saveStudentsToFirebase();
        };

        // Global functions for profile field management
        window.toggleFieldVisibility = async function(fieldKey, isVisible) {
            profileFields[fieldKey].show = isVisible;
            await saveProfileFieldsToFirebase();
            showAlert(`Field visibility updated! 💾✅`, 'success');
        };

        window.toggleFieldRequired = async function(fieldKey, isRequired) {
            profileFields[fieldKey].required = isRequired;
            await saveProfileFieldsToFirebase();
            showAlert(`Field requirement updated! 💾✅`, 'success');
        };

        window.deleteCustomField = async function(fieldKey) {
            if (confirm(`Are you sure you want to delete the "${profileFields[fieldKey].label}" field?`)) {
                delete profileFields[fieldKey];
                generateCombinedProfileFieldsList();
                await saveProfileFieldsToFirebase();
                showAlert('Custom field deleted successfully! 💾✅', 'success');
            }
        };

        // Global functions for term management
        window.toggleTermVisibility = async function(termName, isVisible) {
            if (isVisible && !availableTerms.includes(termName)) {
                availableTerms.push(termName);
            } else if (!isVisible && availableTerms.includes(termName)) {
                availableTerms = availableTerms.filter(term => term !== termName);
            }
            generateTermsList();
            await saveTermsToFirebase();
            showAlert(`${termName} visibility updated! 💾✅`, 'success');
        };

        window.deleteTerm = async function(termName) {
            if (confirm(`Are you sure you want to delete "${termName}"?`)) {
                allTerms = allTerms.filter(term => term !== termName);
                availableTerms = availableTerms.filter(term => term !== termName);
                delete termMessages[termName];
                generateTermsList();
                await saveTermsToFirebase();
                showAlert('Term deleted successfully! 💾✅', 'success');
            }
        };

        window.toggleTermVisibilityFromTable = async function(termName, isVisible) {
            if (isVisible && !availableTerms.includes(termName)) {
                availableTerms.push(termName);
            } else if (!isVisible && availableTerms.includes(termName)) {
                availableTerms = availableTerms.filter(term => term !== termName);
            }
            generateAllTermsTable();
            await saveTermsToFirebase();
            showAlert(`${termName} visibility updated! 💾✅`, 'success');
        };

        window.deleteTermFromTable = async function(termName) {
            if (confirm(`Are you sure you want to delete "${termName}"?`)) {
                allTerms = allTerms.filter(term => term !== termName);
                availableTerms = availableTerms.filter(term => term !== termName);
                delete termMessages[termName];
                generateAllTermsTable();
                await saveTermsToFirebase();
                showAlert('Term deleted successfully! 💾✅', 'success');
            }
        };

        // Initialize the application
        console.log('Report Card System Initializing...');
        console.log('Sample data loaded:', studentsData);
        console.log('Available terms:', availableTerms);
        showAlert('System ready! All admin functions are working. 🎉', 'success');
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97f930ea74472247',t:'MTc1Nzk1MDQ5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
