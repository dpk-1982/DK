<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primary School Karanpur - Report Card System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, child, push, remove, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9nE0-yeC5Ms34OKXbxSSfmfscyzUMn_Q",
            authDomain: "dd1982-54ac7.firebaseapp.com",
            databaseURL: "https://dd1982-54ac7-default-rtdb.firebaseio.com",
            projectId: "dd1982-54ac7",
            storageBucket: "dd1982-54ac7.firebasestorage.app",
            messagingSenderId: "433562739590",
            appId: "1:433562739590:web:dab8cfa164455d75404207"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase functions globally available
        window.firebaseDB = {
            database,
            ref,
            set,
            get,
            child,
            push,
            remove,
            onValue
        };
        
        // Initialize the app after Firebase is loaded
        window.addEventListener('load', () => {
            if (window.initializeApp) {
                window.initializeApp();
            }
        });
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@300;400;700&display=swap');
        
        * {
            font-family: 'Comic Neue', cursive;
        }
        
        .marquee {
            position: fixed;
            width: 100%;
            z-index: 1000;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .marquee-top {
            top: 0;
            background: linear-gradient(45deg, #ff6b6b 0%, #feca57 100%);
        }
        
        .marquee-bottom {
            bottom: 0;
            background: linear-gradient(45deg, #48cae4 0%, #023e8a 100%);
        }
        
        .marquee-content {
            display: inline-block;
            animation: scroll 20s linear infinite;
            padding: 8px 0;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        @media (min-width: 768px) {
            .marquee-content {
                padding: 10px 0;
                font-size: 18px;
            }
        }
        
        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        body {
            padding-top: 50px;
            padding-bottom: 50px;
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 25%, #45b7d1 50%, #96ceb4 75%, #feca57 100%);
            min-height: 100vh;
        }
        
        @media (min-width: 768px) {
            body {
                padding-top: 60px;
                padding-bottom: 60px;
            }
        }
        
        .glass-effect {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10001;
            padding: 12px 20px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            min-width: 200px;
            max-width: 90vw;
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .alert {
                padding: 15px 25px;
                font-size: 16px;
                min-width: 250px;
            }
        }
        
        .alert.error {
            background: #fee2e2;
            color: #dc2626;
            border: 3px solid #ef4444;
        }
        
        .alert.success {
            background: #dcfce7;
            color: #16a34a;
            border: 3px solid #22c55e;
        }
        
        .alert.warning {
            background: #fef3c7;
            color: #d97706;
            border: 3px solid #f59e0b;
        }
        
        /* Mobile optimizations */
        @media (max-width: 767px) {
            .container {
                padding-left: 8px !important;
                padding-right: 8px !important;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem;
            }
            
            .mobile-text-xs {
                font-size: 0.75rem;
            }
            
            .mobile-btn-spacing {
                margin-bottom: 8px;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-input {
                min-height: 44px;
                font-size: 16px;
            }
        }
        
        /* Touch targets */
        button, select, input[type="checkbox"] {
            min-height: 44px;
            min-width: 44px;
        }
        
        .mobile-scroll {
            -webkit-overflow-scrolling: touch;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <!-- Top Marquee -->
    <div class="marquee marquee-top">
        <div class="marquee-content text-lg">
            🌟 Welcome to Primary School Karanpur - A place where students learn with joy! 🌟
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- School Header -->
        <div class="text-center mb-4 md:mb-8">
            <div class="max-w-4xl mx-auto bg-gradient-to-br from-white via-yellow-50 to-pink-50 rounded-2xl md:rounded-3xl p-4 md:p-8 shadow-2xl border-2 border-blue-200">
                <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-6xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent mb-2 md:mb-4 leading-tight">
                    🏫 Primary School Karanpur 🏫
                </h1>
                <p class="text-sm sm:text-base md:text-xl font-semibold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent">
                    📍 Block-Behjam, District-Lakhimpur-Kheri
                </p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-4 md:mb-8">
            <div class="bg-white rounded-full p-1 md:p-2 shadow-lg w-full max-w-md md:max-w-none md:w-auto">
                <button id="studentTab" class="w-1/2 md:w-auto px-3 md:px-6 py-2 md:py-3 rounded-full bg-gradient-to-r from-pink-500 to-orange-500 text-white font-bold transition-all duration-300 text-sm md:text-base">
                    <span class="hidden sm:inline">👨‍🎓 Student Portal</span>
                    <span class="sm:hidden">👨‍🎓 Student</span>
                </button>
                <button id="adminTab" class="w-1/2 md:w-auto px-3 md:px-6 py-2 md:py-3 rounded-full text-gray-600 font-bold transition-all duration-300 hover:bg-gradient-to-r hover:from-blue-400 hover:to-purple-500 hover:text-white text-sm md:text-base">
                    <span class="hidden sm:inline">👨‍💼 Admin Panel</span>
                    <span class="sm:hidden">👨‍💼 Admin</span>
                </button>
            </div>
        </div>

        <!-- Student Portal -->
        <div id="studentPortal">
            <div class="glass-effect rounded-2xl md:rounded-3xl p-4 md:p-8 mb-4 md:mb-8 shadow-2xl">
                <h2 class="text-xl md:text-3xl font-bold text-white text-center mb-4 md:mb-6">
                    📊 Student Report Card 📊
                </h2>
                
                <!-- Global Student Message -->
                <div id="globalMessageContainer" class="bg-gradient-to-br from-orange-100 via-yellow-100 to-red-100 rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg border-2 border-orange-300 mb-4 md:mb-6">
                    <div class="text-center">
                        <div class="text-xl md:text-2xl mb-2">📢</div>
                        <h3 class="text-base md:text-lg font-bold text-orange-700 mb-2 md:mb-3">Important Message</h3>
                        <div id="globalStudentMessage" class="text-orange-800 font-bold text-sm md:text-lg">
                            📢 Welcome to the Student Report Card Portal! Select your class and name to view your report cards. 🌟📚
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-4 md:mb-6">
                    <!-- Class Selection -->
                    <div class="bg-gradient-to-br from-blue-100 to-cyan-100 rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg border-2 border-blue-200">
                        <label class="block text-base md:text-lg font-bold text-blue-700 mb-2 md:mb-3">🎓 Select Class</label>
                        <select id="classSelect" class="w-full p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none bg-white mobile-input text-base">
                            <option value="">Choose Class</option>
                            <option value="1">Class 1</option>
                            <option value="2">Class 2</option>
                            <option value="3">Class 3</option>
                            <option value="4">Class 4</option>
                            <option value="5">Class 5</option>
                        </select>
                    </div>
                    
                    <!-- Student Selection -->
                    <div class="bg-gradient-to-br from-green-100 to-teal-100 rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg border-2 border-green-200">
                        <label class="block text-base md:text-lg font-bold text-green-700 mb-2 md:mb-3">👦 Select Student</label>
                        <select id="studentSelect" class="w-full p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none bg-white mobile-input text-base" disabled>
                            <option value="">Choose Student</option>
                        </select>
                    </div>
                </div>
                
                <!-- Available Terms Display -->
                <div id="availableTermsSection" class="hidden bg-gradient-to-br from-purple-100 to-pink-100 rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg border-2 border-purple-200 mb-4 md:mb-6">
                    <h4 class="text-base md:text-lg font-bold text-purple-700 mb-3 md:mb-4">📅 Available Report Cards</h4>
                    <div id="termButtons" class="flex flex-wrap gap-2 md:gap-3 justify-center">
                        <!-- Term buttons will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Report Card Display -->
            <div id="reportCardDisplay" class="hidden glass-effect rounded-2xl md:rounded-3xl p-4 md:p-8 shadow-2xl">
                <div id="reportCardContent"></div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden">
            <!-- Admin Login -->
            <div id="adminLogin" class="glass-effect rounded-3xl p-8 mb-8 shadow-2xl text-center">
                <h2 class="text-3xl font-bold text-white mb-6">🔐 Admin Login</h2>
                <div class="max-w-md mx-auto">
                    <input type="password" id="adminPassword" placeholder="Enter Admin Password" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none mb-4">
                    <button id="adminLoginBtn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                        🚪 Login
                    </button>
                    <div id="loginMessage" class="mt-4 text-sm"></div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="hidden">
                <div class="glass-effect rounded-2xl md:rounded-3xl p-4 md:p-8 mb-4 md:mb-8 shadow-2xl">
                    <h2 class="text-xl md:text-3xl font-bold text-white text-center mb-4 md:mb-6">👨‍💼 Admin Dashboard</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4 mb-4 md:mb-6">
                        <div class="bg-white rounded-xl md:rounded-2xl p-3 md:p-4 shadow-lg">
                            <label class="block text-sm font-bold text-blue-600 mb-2">🎓 Class</label>
                            <select id="adminClassSelect" class="w-full p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none mobile-input text-base">
                                <option value="">Choose Class</option>
                                <option value="1">Class 1</option>
                                <option value="2">Class 2</option>
                                <option value="3">Class 3</option>
                                <option value="4">Class 4</option>
                                <option value="5">Class 5</option>
                            </select>
                        </div>
                        
                        <div class="bg-white rounded-xl md:rounded-2xl p-3 md:p-4 shadow-lg">
                            <label class="block text-sm font-bold text-purple-600 mb-2">📅 Term</label>
                            <select id="adminTermSelect" class="w-full p-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none mobile-input text-base" disabled>
                                <option value="">Choose Term</option>
                            </select>
                        </div>
                        
                        <div class="bg-white rounded-xl md:rounded-2xl p-3 md:p-4 shadow-lg">
                            <label class="block text-sm font-bold text-green-600 mb-2">👦 Student</label>
                            <div class="flex gap-2">
                                <select id="adminStudentSelect" class="flex-1 p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none mobile-input text-base" disabled>
                                    <option value="">Choose Student</option>
                                </select>
                                <button id="addStudentBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-3 md:px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-xs md:text-sm whitespace-nowrap" disabled>
                                    ➕ Add
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-3 md:gap-4 mb-4 md:mb-6">
                        <button id="editStudentBtn" class="bg-gradient-to-r from-cyan-500 to-teal-500 text-white px-3 md:px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm mobile-btn-spacing">
                            <span class="hidden sm:inline">✏️ Edit Student</span>
                            <span class="sm:hidden">✏️ Edit</span>
                        </button>
                        <button id="deleteStudentBtn" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-3 md:px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm mobile-btn-spacing">
                            <span class="hidden sm:inline">🗑️ Delete Student</span>
                            <span class="sm:hidden">🗑️ Delete</span>
                        </button>
                        <button id="manageMarksBtn" class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-3 md:px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm mobile-btn-spacing">
                            <span class="hidden sm:inline">📊 Manage Marks</span>
                            <span class="sm:hidden">📊 Marks</span>
                        </button>
                        <button id="profileFieldsBtn" class="bg-gradient-to-r from-violet-500 to-purple-500 text-white px-3 md:px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm mobile-btn-spacing">
                            <span class="hidden sm:inline">👤 Profile Fields</span>
                            <span class="sm:hidden">👤 Fields</span>
                        </button>
                        <button id="termManagementBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-3 md:px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm mobile-btn-spacing">
                            <span class="hidden sm:inline">📅 Term Management</span>
                            <span class="sm:hidden">📅 Terms</span>
                        </button>
                        <button id="globalMessageBtn" class="bg-gradient-to-r from-pink-500 to-rose-500 text-white px-3 md:px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm mobile-btn-spacing">
                            <span class="hidden sm:inline">📢 Global Message</span>
                            <span class="sm:hidden">📢 Message</span>
                        </button>
                        <button id="downloadTabulationBtn" class="bg-gradient-to-r from-emerald-500 to-green-500 text-white px-3 md:px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm mobile-btn-spacing">
                            <span class="hidden sm:inline">📊 Download Tabulation</span>
                            <span class="sm:hidden">📊 Download</span>
                        </button>
                        <button id="combinedViewBtn" class="bg-gradient-to-r from-teal-500 to-cyan-500 text-white px-3 md:px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm mobile-btn-spacing">
                            <span class="hidden sm:inline">📊 Combined View Settings</span>
                            <span class="sm:hidden">📊 Combined</span>
                        </button>
                        <button id="schoolSettingsBtn" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-3 md:px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm mobile-btn-spacing">
                            <span class="hidden sm:inline">🏫 School Settings</span>
                            <span class="sm:hidden">🏫 Settings</span>
                        </button>
                        <button id="passwordManagerBtn" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-3 md:px-4 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm mobile-btn-spacing">
                            <span class="hidden sm:inline">🔐 Password Manager</span>
                            <span class="sm:hidden">🔐 Password</span>
                        </button>
                    </div>
                </div>

                <!-- Student Form -->
                <div id="studentForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 id="studentFormTitle" class="text-2xl font-bold text-white text-center mb-6">📝 Student Information</h3>
                    <div id="studentFormFields" class="grid md:grid-cols-2 gap-6 mb-6">
                        <!-- Dynamic fields will be generated here -->
                    </div>
                    <div class="text-center">
                        <button id="saveStudentBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save Student
                        </button>
                        <button id="cancelFormBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Profile Fields Management -->
                <div id="profileFieldsForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">👤 Profile Fields Manager</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-indigo-600 mb-4">➕ Add New Profile Field</h4>
                        <div class="grid md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-indigo-600 mb-2">📝 Field Name</label>
                                <input type="text" id="newFieldName" class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none" placeholder="Enter field name">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-indigo-600 mb-2">🏷️ Display Label</label>
                                <input type="text" id="newFieldLabel" class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none" placeholder="Enter display label">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-indigo-600 mb-2">🎨 Icon</label>
                                <input type="text" id="newFieldIcon" class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none" placeholder="Enter emoji icon">
                            </div>
                        </div>
                        <button id="addNewFieldBtn" class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            ➕ Add Field
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-violet-600 mb-4">📋 Manage Existing Profile Fields</h4>
                        <div id="profileFieldsList" class="space-y-4">
                            <!-- Profile fields will be dynamically generated here -->
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="saveProfileFieldsBtn" class="bg-gradient-to-r from-violet-500 to-purple-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save All Changes
                        </button>
                        <button id="cancelProfileFieldsBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Term Management -->
                <div id="termManagementForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">📅 Term Management</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-orange-600 mb-4">➕ Add New Term</h4>
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-orange-600 mb-2">📝 Term Name</label>
                                <input type="text" id="newTermName" class="w-full p-3 border-2 border-orange-300 rounded-xl focus:border-orange-500 focus:outline-none" placeholder="Enter term name">
                            </div>
                            <div class="flex items-center justify-center">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="newTermVisible" class="w-5 h-5 text-orange-600 border-2 border-orange-300 rounded focus:ring-orange-500">
                                    <span class="ml-3 text-orange-700 font-semibold">Make visible to students</span>
                                </label>
                            </div>
                        </div>
                        <button id="addTermBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            ➕ Add Term
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-purple-600 mb-4">📋 Manage Existing Terms</h4>
                        <div id="termsList" class="space-y-4">
                            <!-- Terms will be dynamically generated here -->
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="saveTermSettingsBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save All Term Settings
                        </button>
                        <button id="cancelTermManagementBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Tabulation Download -->
                <div id="tabulationDownloadForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">📊 Download Tabulation Sheet</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-emerald-600 mb-4">📋 Select Parameters</h4>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-bold text-emerald-600 mb-2">🎓 Class</label>
                                <select id="tabulationClassSelect" class="w-full p-3 border-2 border-emerald-300 rounded-xl focus:border-emerald-500 focus:outline-none">
                                    <option value="">Select Class</option>
                                    <option value="1">Class 1</option>
                                    <option value="2">Class 2</option>
                                    <option value="3">Class 3</option>
                                    <option value="4">Class 4</option>
                                    <option value="5">Class 5</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-emerald-600 mb-2">📅 Term</label>
                                <select id="tabulationTermSelect" class="w-full p-3 border-2 border-emerald-300 rounded-xl focus:border-emerald-500 focus:outline-none" disabled>
                                    <option value="">Select Term</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-bold text-emerald-600 mb-2">📄 Format</label>
                                <select id="tabulationFormat" class="w-full p-3 border-2 border-emerald-300 rounded-xl focus:border-emerald-500 focus:outline-none">
                                    <option value="excel">📊 Excel (.xlsx)</option>
                                    <option value="csv">📋 CSV (.csv)</option>
                                    <option value="pdf">📄 PDF (.pdf)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-emerald-600 mb-2">🎨 Layout</label>
                                <select id="tabulationLayout" class="w-full p-3 border-2 border-emerald-300 rounded-xl focus:border-emerald-500 focus:outline-none">
                                    <option value="detailed">📊 Detailed (All Marks)</option>
                                    <option value="summary">📋 Summary (Totals Only)</option>
                                    <option value="percentage">📈 Percentage View</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-xl p-4 border-2 border-blue-200 mb-4">
                            <h5 class="text-sm font-bold text-blue-700 mb-2">📋 Preview Information</h5>
                            <div id="tabulationPreview" class="text-blue-600 text-sm">
                                Select class and term to see preview information
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-3 justify-center">
                            <button id="generateTabulationBtn" class="bg-gradient-to-r from-emerald-500 to-green-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300" disabled>
                                📊 Generate & Download
                            </button>
                            <button id="previewTabulationBtn" class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300" disabled>
                                👁️ Preview
                            </button>
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="cancelTabulationBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Tabulation Preview -->
                <div id="tabulationPreviewModal" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">👁️ Tabulation Sheet Preview</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6 overflow-x-auto">
                        <div id="tabulationPreviewContent" class="min-w-full">
                            <!-- Preview content will be generated here -->
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="downloadFromPreviewBtn" class="bg-gradient-to-r from-emerald-500 to-green-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 mr-4">
                            📊 Download This Sheet
                        </button>
                        <button id="closePreviewBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            ❌ Close Preview
                        </button>
                    </div>
                </div>

                <!-- Combined View Settings -->
                <div id="combinedViewForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">📊 Combined View Settings</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-teal-600 mb-4">⚙️ Configure Combined View</h4>
                        
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gradient-to-r from-teal-100 to-cyan-100 rounded-xl p-4 border-2 border-teal-200">
                                <h5 class="text-md font-bold text-teal-700 mb-3">🔧 Admin Settings</h5>
                                <label class="flex items-center cursor-pointer mb-3">
                                    <input type="checkbox" id="enableCombinedView" class="w-5 h-5 text-teal-600 border-2 border-teal-300 rounded focus:ring-teal-500">
                                    <span class="ml-3 text-teal-700 font-semibold">Enable Combined View Feature</span>
                                </label>
                                <p class="text-sm text-teal-600">This allows viewing all terms together in one comprehensive report.</p>
                            </div>
                            
                            <div class="bg-gradient-to-r from-blue-100 to-indigo-100 rounded-xl p-4 border-2 border-blue-200">
                                <h5 class="text-md font-bold text-blue-700 mb-3">👥 Student Access</h5>
                                <label class="flex items-center cursor-pointer mb-3">
                                    <input type="checkbox" id="allowStudentCombinedView" class="w-5 h-5 text-blue-600 border-2 border-blue-300 rounded focus:ring-blue-500">
                                    <span class="ml-3 text-blue-700 font-semibold">Allow Students to View Combined Reports</span>
                                </label>
                                <p class="text-sm text-blue-600">Students can see their progress across all terms in one view.</p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl p-4 border-2 border-yellow-200 mb-4">
                            <h5 class="text-md font-bold text-orange-700 mb-2">📋 Combined View Features</h5>
                            <ul class="text-sm text-orange-600 space-y-1">
                                <li>• View all terms' marks in one comprehensive table</li>
                                <li>• Compare performance across different terms</li>
                                <li>• Edit and update marks for any term directly</li>
                                <li>• See overall progress and improvement trends</li>
                                <li>• Professional layout with term-wise comparison</li>
                            </ul>
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="saveCombinedViewBtn" class="bg-gradient-to-r from-teal-500 to-cyan-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save Combined View Settings
                        </button>
                        <button id="cancelCombinedViewBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Password Manager -->
                <div id="passwordManagerForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">🔐 Password Manager</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-red-600 mb-4">🔑 Admin Password Settings</h4>
                        
                        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl p-4 border-2 border-yellow-300 mb-6">
                            <h5 class="text-md font-bold text-orange-700 mb-2">⚠️ Important Security Information</h5>
                            <ul class="text-sm text-orange-600 space-y-1">
                                <li>• <strong>Master Password:</strong> A permanent password that always works (cannot be changed)</li>
                                <li>• <strong>Admin Password:</strong> Your customizable password for daily use</li>
                                <li>• Both passwords provide full admin access to the system</li>
                                <li>• Keep your passwords secure and don't share them with unauthorized users</li>
                            </ul>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gradient-to-r from-blue-100 to-indigo-100 rounded-xl p-4 border-2 border-blue-200">
                                <h5 class="text-md font-bold text-blue-700 mb-3">🔐 Master Password Status</h5>
                                <div class="text-center">
                                    <div class="text-3xl mb-2">🛡️</div>
                                    <p class="text-blue-600 font-semibold">Master Password: <span class="text-green-600">ACTIVE</span></p>
                                    <p class="text-xs text-blue-500 mt-2">This password cannot be changed and always provides access</p>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-green-100 to-teal-100 rounded-xl p-4 border-2 border-green-200">
                                <h5 class="text-md font-bold text-green-700 mb-3">🔑 Current Admin Password</h5>
                                <div class="text-center">
                                    <div class="text-3xl mb-2">🔓</div>
                                    <p class="text-green-600 font-semibold">Status: <span class="text-blue-600">CONFIGURED</span></p>
                                    <p class="text-xs text-green-500 mt-2" id="currentPasswordDisplay">Current: ••••••••</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl p-4 border-2 border-purple-200 mb-4">
                            <h5 class="text-md font-bold text-purple-700 mb-3">🔄 Change Admin Password</h5>
                            
                            <div class="grid md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-bold text-purple-600 mb-2">🔒 Current Password</label>
                                    <input type="password" id="currentPassword" class="w-full p-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none" placeholder="Enter current password">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-purple-600 mb-2">🆕 New Password</label>
                                    <input type="password" id="newPassword" class="w-full p-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none" placeholder="Enter new password">
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-bold text-purple-600 mb-2">✅ Confirm New Password</label>
                                <input type="password" id="confirmPassword" class="w-full p-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none" placeholder="Confirm new password">
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="showPasswords" class="w-4 h-4 text-purple-600 border-2 border-purple-300 rounded focus:ring-purple-500">
                                    <span class="ml-2 text-purple-700 font-semibold text-sm">👁️ Show Passwords</span>
                                </label>
                                
                                <button type="button" onclick="generateRandomPassword()" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-600 transition-all duration-300 text-sm">
                                    🎲 Generate Random
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-4 border-2 border-gray-200">
                            <h5 class="text-sm font-bold text-gray-600 mb-2">💡 Password Security Tips:</h5>
                            <ul class="text-xs text-gray-600 space-y-1">
                                <li>• Use a combination of letters, numbers, and symbols</li>
                                <li>• Make it at least 8 characters long</li>
                                <li>• Avoid using personal information</li>
                                <li>• Don't use the same password for multiple accounts</li>
                                <li>• Change your password regularly</li>
                            </ul>
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="changePasswordBtn" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            🔐 Change Admin Password
                        </button>
                        <button id="cancelPasswordManagerBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- School Settings -->
                <div id="schoolSettingsForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">🏫 School Settings</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-indigo-600 mb-4">🏫 School Information</h4>
                        
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-bold text-indigo-600 mb-2">🏫 School Name</label>
                                <input type="text" id="schoolName" class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none" placeholder="Enter school name">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-indigo-600 mb-2">📍 School Address</label>
                                <input type="text" id="schoolAddress" class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none" placeholder="Enter school address">
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-indigo-600 mb-2">📢 Top Marquee Content</label>
                            <textarea id="topMarqueeContent" rows="2" class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none resize-none" placeholder="Enter top marquee message..."></textarea>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-indigo-600 mb-2">💝 Bottom Marquee Content</label>
                            <textarea id="bottomMarqueeContent" rows="2" class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none resize-none" placeholder="Enter bottom marquee message..."></textarea>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-purple-600 mb-4">🎨 Color Theme Settings</h4>
                        
                        <div class="grid md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-purple-600 mb-2">🌈 Background Theme</label>
                                <select id="backgroundTheme" class="w-full p-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none">
                                    <option value="rainbow">🌈 Rainbow (Default)</option>
                                    <option value="ocean">🌊 Ocean Blue</option>
                                    <option value="sunset">🌅 Sunset Orange</option>
                                    <option value="forest">🌲 Forest Green</option>
                                    <option value="lavender">💜 Lavender Purple</option>
                                    <option value="cherry">🌸 Cherry Blossom</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-purple-600 mb-2">🎯 Accent Color</label>
                                <select id="accentColor" class="w-full p-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none">
                                    <option value="blue">💙 Blue (Default)</option>
                                    <option value="green">💚 Green</option>
                                    <option value="purple">💜 Purple</option>
                                    <option value="orange">🧡 Orange</option>
                                    <option value="pink">💗 Pink</option>
                                    <option value="teal">💎 Teal</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl p-4 border-2 border-yellow-200 mb-4">
                            <h5 class="text-md font-bold text-orange-700 mb-2">🎨 Theme Preview</h5>
                            <div id="themePreview" class="p-4 rounded-lg border-2 min-h-[100px] flex items-center justify-center">
                                <div class="text-center">
                                    <div class="text-2xl mb-2">🏫</div>
                                    <div class="font-bold text-lg" id="previewSchoolName">School Name</div>
                                    <div class="text-sm" id="previewSchoolAddress">School Address</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-3 gap-3">
                            <button type="button" onclick="previewTheme()" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-600 transition-all duration-300 text-sm">
                                👁️ Preview Theme
                            </button>
                            <button type="button" onclick="resetToDefault()" class="bg-gray-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-600 transition-all duration-300 text-sm">
                                🔄 Reset to Default
                            </button>
                            <button type="button" onclick="applyTheme()" class="bg-green-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-600 transition-all duration-300 text-sm">
                                ✨ Apply Theme
                            </button>
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="saveSchoolSettingsBtn" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save School Settings
                        </button>
                        <button id="cancelSchoolSettingsBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Global Message Management -->
                <div id="globalMessageForm" class="hidden glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">📢 Global Student Message & Term Visibility</h3>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <h4 class="text-lg font-bold text-pink-600 mb-4">✏️ Edit Global Message</h4>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-pink-600 mb-2">📝 Message Content</label>
                            <textarea id="globalMessageContent" rows="4" class="w-full p-4 border-2 border-pink-300 rounded-xl focus:border-pink-500 focus:outline-none resize-none text-lg" placeholder="Enter the global message for all students...">📢 Welcome to the Student Report Card Portal! Select your class and name to view your report cards. 🌟📚</textarea>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-pink-600 mb-2">🎨 Message Style</label>
                                <select id="globalMessageStyle" class="w-full p-3 border-2 border-pink-300 rounded-xl focus:border-pink-500 focus:outline-none">
                                    <option value="info">📢 Information (Orange)</option>
                                    <option value="success">✅ Success (Green)</option>
                                    <option value="warning">⚠️ Warning (Yellow)</option>
                                    <option value="announcement">📣 Announcement (Blue)</option>
                                </select>
                            </div>
                            <div class="flex items-center justify-center">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="globalMessageEnabled" class="w-5 h-5 text-pink-600 border-2 border-pink-300 rounded focus:ring-pink-500" checked>
                                    <span class="ml-3 text-pink-700 font-semibold">Show message to students</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-100 to-indigo-100 rounded-xl p-4 border-2 border-blue-200 mb-4">
                            <h5 class="text-md font-bold text-blue-700 mb-3">📅 Term Visibility Control</h5>
                            <p class="text-sm text-blue-600 mb-3">Select which terms should be visible to students. Only selected terms will appear in the student portal.</p>
                            
                            <div class="grid md:grid-cols-2 gap-3" id="termVisibilityControls">
                                <!-- Term checkboxes will be generated here -->
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl p-4 border-2 border-purple-200 mb-4">
                            <h5 class="text-md font-bold text-purple-700 mb-3">🎯 Quick Message Templates</h5>
                            <div class="grid md:grid-cols-2 gap-2">
                                <button type="button" onclick="setQuickMessage('upcoming')" class="bg-yellow-500 text-white px-3 py-2 rounded-lg font-bold hover:bg-yellow-600 transition-all duration-300 text-sm">
                                    ⏳ Results Coming Soon
                                </button>
                                <button type="button" onclick="setQuickMessage('declared')" class="bg-green-500 text-white px-3 py-2 rounded-lg font-bold hover:bg-green-600 transition-all duration-300 text-sm">
                                    ✅ Results Declared
                                </button>
                                <button type="button" onclick="setQuickMessage('maintenance')" class="bg-orange-500 text-white px-3 py-2 rounded-lg font-bold hover:bg-orange-600 transition-all duration-300 text-sm">
                                    🔧 Under Maintenance
                                </button>
                                <button type="button" onclick="setQuickMessage('welcome')" class="bg-blue-500 text-white px-3 py-2 rounded-lg font-bold hover:bg-blue-600 transition-all duration-300 text-sm">
                                    🌟 Welcome Message
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-4 border-2 border-gray-200">
                            <h5 class="text-sm font-bold text-gray-600 mb-2">📋 Preview:</h5>
                            <div id="globalMessagePreview" class="bg-gradient-to-br from-orange-100 via-yellow-100 to-red-100 rounded-xl p-4 border-2 border-orange-300">
                                <div class="text-center">
                                    <div class="text-xl mb-2">📢</div>
                                    <h6 class="text-md font-bold text-orange-700 mb-2">Important Message</h6>
                                    <div class="text-orange-800 font-bold">📢 Welcome to the Student Report Card Portal! Select your class and name to view your report cards. 🌟📚</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="saveGlobalMessageBtn" class="bg-gradient-to-r from-pink-500 to-rose-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save Global Message
                        </button>
                        <button id="cancelGlobalMessageBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ml-4">
                            ❌ Cancel
                        </button>
                    </div>
                </div>

                <!-- Marks Management -->
                <div id="marksTable" class="hidden glass-effect rounded-2xl md:rounded-3xl p-4 md:p-8 mb-4 md:mb-8 shadow-2xl">
                    <h3 id="marksTableTitle" class="text-lg md:text-2xl font-bold text-white text-center mb-4 md:mb-6">📊 Manage Marks</h3>
                    
                    <div class="overflow-x-auto mobile-scroll table-container">
                        <table class="w-full bg-white rounded-xl md:rounded-2xl shadow-lg overflow-hidden min-w-[600px]">
                            <thead class="bg-gradient-to-r from-purple-500 to-pink-600 text-white">
                                <tr>
                                    <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg">📚 Subject</th>
                                    <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg">🗣️ Oral<br><span class="text-xs">(Max 5)</span></th>
                                    <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg">✍️ Written<br><span class="text-xs">(Max 15)</span></th>
                                    <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg">📝 Total</th>
                                </tr>
                            </thead>
                            <tbody id="marksTableBody">
                                <!-- Dynamic rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-center mt-4 md:mt-6">
                        <button id="saveMarksBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 md:px-8 py-3 md:py-4 rounded-xl font-bold text-base md:text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save All Marks
                        </button>
                    </div>
                </div>

                <!-- Combined Marks Management -->
                <div id="combinedMarksTable" class="hidden glass-effect rounded-2xl md:rounded-3xl p-4 md:p-8 mb-4 md:mb-8 shadow-2xl">
                    <h3 id="combinedMarksTableTitle" class="text-lg md:text-2xl font-bold text-white text-center mb-4 md:mb-6">📊 Combined View - All Terms</h3>
                    
                    <div class="overflow-x-auto mobile-scroll table-container">
                        <div id="combinedMarksTableContent" class="min-w-full">
                            <!-- Combined marks table will be generated here -->
                        </div>
                    </div>
                    
                    <div class="text-center mt-4 md:mt-6">
                        <button id="saveCombinedMarksBtn" class="bg-gradient-to-r from-teal-500 to-cyan-500 text-white px-6 md:px-8 py-3 md:py-4 rounded-xl font-bold text-base md:text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                            💾 Save All Combined Marks
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Marquee -->
    <div class="marquee marquee-bottom">
        <div class="marquee-content text-lg">
            💝 This site is developed by Mr. Deepak Kumar Vaishya, Assistant Teacher at Primary School Karanpur 💝
        </div>
    </div>

    <script>
        // Global Data
        let isAdminLoggedIn = false;
        let currentEditingStudent = null;
        let isFirebaseLoaded = false;
        
        // Available terms for students
        let availableTerms = ["First Term"];
        
        // All terms in system
        let allTerms = ["First Term", "Second Term", "Final Term"];
        
        // Combined view settings
        let combinedViewSettings = {
            enabled: false,
            availableToStudents: false
        };
        
        // Global student message
        let globalStudentMessage = {
            content: "📢 Welcome to the Student Report Card Portal! Select your class and name to view your report cards. 🌟📚",
            style: "info",
            enabled: true,
            visibleTerms: ["First Term"] // Terms visible to students
        };
        
        // School settings
        let schoolSettings = {
            name: "Primary School Karanpur",
            address: "Block-Behjam, District-Lakhimpur-Kheri",
            topMarquee: "🌟 Welcome to Primary School Karanpur - A place where students learn with joy! 🌟",
            bottomMarquee: "💝 This site is developed by Mr. Deepak Kumar Vaishya, Assistant Teacher at Primary School Karanpur 💝",
            theme: {
                background: "rainbow",
                accent: "blue"
            },
            adminPassword: "admin123" // Customizable admin password
        };
        
        // Master password that always works (cannot be changed)
        const MASTER_PASSWORD = "9369580476";

        // Profile field configuration
        let profileFields = {
            name: { label: "Student Name", show: true, required: true, icon: "👦" },
            fatherName: { label: "Father's Name", show: true, required: true, icon: "👨" },
            motherName: { label: "Mother's Name", show: true, required: false, icon: "👩" },
            rollNumber: { label: "Roll Number", show: true, required: false, icon: "🔢" },
            dateOfBirth: { label: "Date of Birth", show: false, required: false, icon: "📅" },
            address: { label: "Address", show: false, required: false, icon: "🏠" },
            phoneNumber: { label: "Phone Number", show: false, required: false, icon: "📞" },
            bloodGroup: { label: "Blood Group", show: false, required: false, icon: "🩸" }
        };
        
        // Subjects for each class
        let classSubjects = {
            "1": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"],
            "2": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"],
            "3": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"],
            "4": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"],
            "5": ["HINDI", "ENGLISH", "MATHS", "EVS", "SANSKRIT"]
        };

        // Sample student data
        let studentsData = {
            "1": {
                "student_1_001": {
                    name: "Aarav Sharma",
                    fatherName: "Rajesh Sharma",
                    motherName: "Sunita Sharma",
                    rollNumber: "001",
                    class: "1",
                    marks: {
                        "First Term": {
                            "HINDI": { oral: 4, written: 12 },
                            "ENGLISH": { oral: 3, written: 10 },
                            "MATHS": { oral: 5, written: 14 },
                            "EVS": { oral: 4, written: 11 },
                            "SANSKRIT": { oral: 3, written: 9 }
                        }
                    }
                },
                "student_1_002": {
                    name: "Priya Singh",
                    fatherName: "Suresh Singh",
                    motherName: "Kavita Singh",
                    rollNumber: "002",
                    class: "1",
                    marks: {
                        "First Term": {
                            "HINDI": { oral: 5, written: 14 },
                            "ENGLISH": { oral: 4, written: 12 },
                            "MATHS": { oral: 5, written: 15 },
                            "EVS": { oral: 5, written: 13 },
                            "SANSKRIT": { oral: 4, written: 11 }
                        }
                    }
                }
            },
            "2": {
                "student_2_001": {
                    name: "Rohit Kumar",
                    fatherName: "Mohan Kumar",
                    motherName: "Geeta Kumar",
                    rollNumber: "003",
                    class: "2",
                    marks: {
                        "First Term": {
                            "HINDI": { oral: 4, written: 13 },
                            "ENGLISH": { oral: 3, written: 11 },
                            "MATHS": { oral: 5, written: 15 },
                            "EVS": { oral: 4, written: 12 },
                            "SANSKRIT": { oral: 3, written: 10 }
                        }
                    }
                }
            }
        };

        // Firebase Database Functions
        async function initializeFirebase() {
            try {
                const testRef = window.firebaseDB.ref(window.firebaseDB.database, 'test');
                await window.firebaseDB.set(testRef, { connected: true, timestamp: Date.now() });
                
                isFirebaseLoaded = true;
                await loadAllDataFromFirebase();
                showAlert('🔥 Firebase connected! Data synced. ✅', 'success');
            } catch (error) {
                showAlert('⚠️ Using offline mode. Changes will not be saved permanently.', 'warning');
                isFirebaseLoaded = false;
            }
        }

        async function loadAllDataFromFirebase() {
            try {
                // Load students data
                const studentsRef = window.firebaseDB.ref(window.firebaseDB.database, 'students');
                const studentsSnapshot = await window.firebaseDB.get(studentsRef);
                if (studentsSnapshot.exists()) {
                    studentsData = studentsSnapshot.val();
                }

                // Load profile fields
                const profileFieldsRef = window.firebaseDB.ref(window.firebaseDB.database, 'profileFields');
                const profileFieldsSnapshot = await window.firebaseDB.get(profileFieldsRef);
                if (profileFieldsSnapshot.exists()) {
                    profileFields = profileFieldsSnapshot.val();
                }

                // Load terms data
                const termsRef = window.firebaseDB.ref(window.firebaseDB.database, 'terms');
                const termsSnapshot = await window.firebaseDB.get(termsRef);
                if (termsSnapshot.exists()) {
                    const termsData = termsSnapshot.val();
                    availableTerms = termsData.availableTerms || availableTerms;
                    allTerms = termsData.allTerms || allTerms;
                }

                // Load global message
                const messageRef = window.firebaseDB.ref(window.firebaseDB.database, 'globalMessage');
                const messageSnapshot = await window.firebaseDB.get(messageRef);
                if (messageSnapshot.exists()) {
                    globalStudentMessage = messageSnapshot.val();
                    // Ensure visibleTerms exists for backward compatibility
                    if (!globalStudentMessage.visibleTerms) {
                        globalStudentMessage.visibleTerms = ["First Term"];
                    }
                    updateGlobalStudentMessage();
                }

                // Load combined view settings
                const combinedViewRef = window.firebaseDB.ref(window.firebaseDB.database, 'combinedViewSettings');
                const combinedViewSnapshot = await window.firebaseDB.get(combinedViewRef);
                if (combinedViewSnapshot.exists()) {
                    combinedViewSettings = combinedViewSnapshot.val();
                }
                
                // Load school settings
                const schoolSettingsRef = window.firebaseDB.ref(window.firebaseDB.database, 'schoolSettings');
                const schoolSettingsSnapshot = await window.firebaseDB.get(schoolSettingsRef);
                if (schoolSettingsSnapshot.exists()) {
                    schoolSettings = schoolSettingsSnapshot.val();
                    updateSchoolDisplay();
                }
                
            } catch (error) {
                console.log('Error loading data:', error);
            }
        }

        async function saveStudentsToFirebase() {
            if (!isFirebaseLoaded) return;
            
            try {
                const studentsRef = window.firebaseDB.ref(window.firebaseDB.database, 'students');
                await window.firebaseDB.set(studentsRef, studentsData);
            } catch (error) {
                console.log('Error saving students:', error);
            }
        }

        async function saveProfileFieldsToFirebase() {
            if (!isFirebaseLoaded) return;
            
            try {
                const profileFieldsRef = window.firebaseDB.ref(window.firebaseDB.database, 'profileFields');
                await window.firebaseDB.set(profileFieldsRef, profileFields);
            } catch (error) {
                console.log('Error saving profile fields:', error);
            }
        }

        async function saveTermsToFirebase() {
            if (!isFirebaseLoaded) return;
            
            try {
                const termsData = { availableTerms, allTerms };
                const termsRef = window.firebaseDB.ref(window.firebaseDB.database, 'terms');
                await window.firebaseDB.set(termsRef, termsData);
            } catch (error) {
                console.log('Error saving terms:', error);
            }
        }

        async function saveGlobalMessageToFirebase() {
            if (!isFirebaseLoaded) return;
            
            try {
                const messageRef = window.firebaseDB.ref(window.firebaseDB.database, 'globalMessage');
                await window.firebaseDB.set(messageRef, globalStudentMessage);
            } catch (error) {
                console.log('Error saving global message:', error);
            }
        }

        async function saveCombinedViewSettingsToFirebase() {
            if (!isFirebaseLoaded) return;
            
            try {
                const combinedViewRef = window.firebaseDB.ref(window.firebaseDB.database, 'combinedViewSettings');
                await window.firebaseDB.set(combinedViewRef, combinedViewSettings);
            } catch (error) {
                console.log('Error saving combined view settings:', error);
            }
        }

        async function saveSchoolSettingsToFirebase() {
            if (!isFirebaseLoaded) return;
            
            try {
                const schoolSettingsRef = window.firebaseDB.ref(window.firebaseDB.database, 'schoolSettings');
                await window.firebaseDB.set(schoolSettingsRef, schoolSettings);
            } catch (error) {
                console.log('Error saving school settings:', error);
            }
        }

        // Initialize Firebase when the app loads
        window.initializeApp = async function() {
            await initializeFirebase();
        };

        // Utility Functions
        function showAlert(message, type = 'error') {
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        function showMessage(element, message, type) {
            if (!element) return;
            
            element.innerHTML = message;
            element.className = `text-center mt-2 font-bold ${
                type === 'success' ? 'text-green-600' : 
                type === 'warning' ? 'text-yellow-600' : 
                'text-red-600'
            }`;
            
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }

        // Tab Switching
        document.getElementById('studentTab').addEventListener('click', function() {
            this.className = "w-1/2 md:w-auto px-3 md:px-6 py-2 md:py-3 rounded-full bg-gradient-to-r from-pink-500 to-orange-500 text-white font-bold transition-all duration-300 text-sm md:text-base";
            document.getElementById('adminTab').className = "w-1/2 md:w-auto px-3 md:px-6 py-2 md:py-3 rounded-full text-gray-600 font-bold transition-all duration-300 hover:bg-gradient-to-r hover:from-blue-400 hover:to-purple-500 hover:text-white text-sm md:text-base";
            document.getElementById('studentPortal').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
        });

        document.getElementById('adminTab').addEventListener('click', function() {
            this.className = "w-1/2 md:w-auto px-3 md:px-6 py-2 md:py-3 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 text-white font-bold transition-all duration-300 text-sm md:text-base";
            document.getElementById('studentTab').className = "w-1/2 md:w-auto px-3 md:px-6 py-2 md:py-3 rounded-full text-gray-600 font-bold transition-all duration-300 hover:bg-gradient-to-r hover:from-pink-400 hover:to-orange-400 hover:text-white text-sm md:text-base";
            document.getElementById('studentPortal').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
        });

        // Student Portal Functions
        document.getElementById('classSelect').addEventListener('change', function() {
            const selectedClass = this.value;
            const studentSelect = document.getElementById('studentSelect');
            const availableTermsSection = document.getElementById('availableTermsSection');
            
            studentSelect.innerHTML = '<option value="">Choose Student</option>';
            document.getElementById('reportCardDisplay').classList.add('hidden');
            availableTermsSection.classList.add('hidden');
            
            if (selectedClass) {
                if (studentsData[selectedClass]) {
                    studentSelect.disabled = false;
                    Object.keys(studentsData[selectedClass]).forEach(studentId => {
                        const student = studentsData[selectedClass][studentId];
                        const option = document.createElement('option');
                        option.value = studentId;
                        option.textContent = student.name;
                        studentSelect.appendChild(option);
                    });
                }
            } else {
                studentSelect.disabled = true;
            }
        });

        document.getElementById('studentSelect').addEventListener('change', function() {
            const selectedClass = document.getElementById('classSelect').value;
            const selectedStudent = this.value;
            const availableTermsSection = document.getElementById('availableTermsSection');
            
            document.getElementById('reportCardDisplay').classList.add('hidden');
            
            if (selectedClass && selectedStudent) {
                showAvailableTerms(selectedClass, selectedStudent);
                availableTermsSection.classList.remove('hidden');
            } else {
                availableTermsSection.classList.add('hidden');
            }
        });

        function showAvailableTerms(classId, studentId) {
            const student = studentsData[classId][studentId];
            const termButtons = document.getElementById('termButtons');
            termButtons.innerHTML = '';
            
            // Use visibleTerms from globalStudentMessage instead of availableTerms
            const visibleTerms = globalStudentMessage.visibleTerms || [];
            
            // Add combined view button if enabled and available to students
            if (combinedViewSettings.enabled && combinedViewSettings.availableToStudents && student.marks) {
                const hasMultipleVisibleTerms = visibleTerms.filter(term => student.marks[term]).length > 1;
                if (hasMultipleVisibleTerms) {
                    const combinedButton = document.createElement('button');
                    combinedButton.className = 'bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm md:text-base';
                    combinedButton.innerHTML = `<span class="hidden sm:inline">📊 View Combined Report</span><span class="sm:hidden">📊 Combined</span>`;
                    combinedButton.onclick = () => displayCombinedReportCard(classId, studentId);
                    termButtons.appendChild(combinedButton);
                }
            }
            
            visibleTerms.forEach(term => {
                if (student.marks && student.marks[term]) {
                    const button = document.createElement('button');
                    button.className = 'bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm md:text-base';
                    button.innerHTML = `<span class="hidden sm:inline">📊 View ${term} Report</span><span class="sm:hidden">📊 ${term}</span>`;
                    button.onclick = () => displayReportCard(classId, studentId, term);
                    termButtons.appendChild(button);
                }
            });
            
            if (termButtons.children.length === 0) {
                const messageText = visibleTerms.length === 0 ? 
                    '📝 No terms are currently available. Please check back later!' :
                    '📝 No report cards available for the visible terms yet. Please check back later!';
                termButtons.innerHTML = `<p class="text-purple-700 font-bold text-lg">${messageText}</p>`;
            }
        }

        function displayReportCard(classId, studentId, term) {
            if (!studentsData[classId] || !studentsData[classId][studentId]) {
                showAlert('Student data not found!', 'error');
                return;
            }
            
            const student = studentsData[classId][studentId];
            
            if (!student.marks || !student.marks[term]) {
                showAlert(`No marks found for ${term}!`, 'warning');
                return;
            }
            
            const marks = student.marks[term];
            
            let totalMarks = 0;
            let totalOralMarks = 0;
            let totalWrittenMarks = 0;
            let maxTotalMarks = 0;
            let maxOralMarks = 0;
            let maxWrittenMarks = 0;
            let subjectsHTML = '';
            let subjectsWithMarks = 0;
            
            Object.keys(marks).forEach(subject => {
                const subjectMarks = marks[subject];
                const oral = subjectMarks.oral || 0;
                const written = subjectMarks.written || 0;
                const total = oral + written;
                
                if (total > 0) {
                    const maxMarks = 20;
                    const percentage = ((total / maxMarks) * 100).toFixed(1);
                    
                    totalMarks += total;
                    totalOralMarks += oral;
                    totalWrittenMarks += written;
                    maxTotalMarks += maxMarks;
                    maxOralMarks += 5;
                    maxWrittenMarks += 15;
                    subjectsWithMarks++;
                    
                    subjectsHTML += `
                        <tr class="border-b-2 border-gray-100 hover:bg-blue-50 transition-all duration-300">
                            <td class="py-3 md:py-4 px-2 md:px-4 font-bold text-purple-700 text-center text-sm md:text-base">${subject}</td>
                            <td class="py-3 md:py-4 px-2 md:px-4 text-center font-semibold text-blue-600 text-sm md:text-base">${oral}</td>
                            <td class="py-3 md:py-4 px-2 md:px-4 text-center font-semibold text-green-600 text-sm md:text-base">${written}</td>
                            <td class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-indigo-700 text-sm md:text-base">${total}</td>
                            <td class="py-3 md:py-4 px-2 md:px-4 text-center font-semibold text-gray-600 text-sm md:text-base">20</td>
                            <td class="py-3 md:py-4 px-2 md:px-4 text-center font-semibold text-purple-600 text-sm md:text-base">${percentage}%</td>
                        </tr>
                    `;
                }
            });
            
            if (subjectsWithMarks === 0) {
                showAlert(`No marks have been entered for ${term} yet!`, 'warning');
                return;
            }
            
            const overallPercentage = ((totalMarks / maxTotalMarks) * 100).toFixed(1);
            
            let profileHTML = '';
            let fieldsShown = 0;
            
            profileHTML += `
                <div class="bg-gradient-to-br from-purple-100 to-pink-100 rounded-2xl p-4 shadow-lg border-2 border-purple-200">
                    <div class="text-2xl mb-2">🎓</div>
                    <h4 class="text-lg font-bold text-purple-800 mb-1">Class & Term</h4>
                    <p class="text-xl font-bold text-purple-900">Class ${student.class} - ${term}</p>
                </div>
            `;
            fieldsShown++;
            
            Object.keys(profileFields).forEach(fieldKey => {
                const field = profileFields[fieldKey];
                
                if (field.show && student[fieldKey] && fieldsShown < 6) {
                    let displayValue = student[fieldKey];
                    if (fieldKey === 'dateOfBirth') {
                        displayValue = new Date(student[fieldKey]).toLocaleDateString();
                    }
                    
                    const colorClass = fieldsShown === 1 ? 'from-blue-100 to-blue-100 border-blue-200 text-blue-800 text-blue-900' :
                                      fieldsShown === 2 ? 'from-green-100 to-green-100 border-green-200 text-green-800 text-green-900' :
                                      fieldsShown === 3 ? 'from-orange-100 to-orange-100 border-orange-200 text-orange-800 text-orange-900' :
                                      fieldsShown === 4 ? 'from-teal-100 to-teal-100 border-teal-200 text-teal-800 text-teal-900' :
                                      'from-pink-100 to-pink-100 border-pink-200 text-pink-800 text-pink-900';
                    
                    const colors = colorClass.split(' ');
                    
                    profileHTML += `
                        <div class="bg-gradient-to-br ${colors[0]} ${colors[1]} rounded-2xl p-4 shadow-lg border-2 ${colors[2]}">
                            <div class="text-2xl mb-2">${field.icon}</div>
                            <h4 class="text-lg font-bold ${colors[3]} mb-1">${field.label}</h4>
                            <p class="text-xl font-bold ${colors[4]}">${displayValue}</p>
                        </div>
                    `;
                    fieldsShown++;
                }
            });
            
            const reportCardHTML = `
                <div class="bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-2xl md:rounded-3xl p-4 md:p-8 shadow-2xl border-2 md:border-4 border-blue-300">
                    <div class="text-center mb-4 md:mb-8">
                        <h3 class="text-2xl md:text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-4 md:mb-6">📋 REPORT CARD 📋</h3>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4 mb-4 md:mb-6">
                            ${profileHTML}
                        </div>
                    </div>

                    <div class="overflow-x-auto mb-4 md:mb-6 mobile-scroll table-container">
                        <table class="w-full bg-white rounded-xl md:rounded-2xl shadow-lg overflow-hidden min-w-[600px]">
                            <thead class="bg-gradient-to-r from-purple-500 to-pink-600 text-white">
                                <tr>
                                    <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg">📚 Subject</th>
                                    <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg">🗣️ Oral</th>
                                    <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg">✍️ Written</th>
                                    <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg">📝 Total</th>
                                    <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg">💯 Max</th>
                                    <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg">📊 %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${subjectsHTML}
                                <tr class="bg-gradient-to-r from-yellow-100 to-orange-100 border-t-4 border-orange-300">
                                    <td class="py-3 md:py-4 px-2 md:px-4 font-bold text-orange-700 text-center text-sm md:text-lg">🏆 TOTAL</td>
                                    <td class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-blue-700 text-lg md:text-xl">${totalOralMarks}</td>
                                    <td class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-green-700 text-lg md:text-xl">${totalWrittenMarks}</td>
                                    <td class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-orange-700 text-lg md:text-xl">${totalMarks}</td>
                                    <td class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg">${maxTotalMarks}</td>
                                    <td class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-orange-700 text-lg md:text-xl">${overallPercentage}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                        <div class="bg-gradient-to-r from-green-100 to-blue-100 rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg border-2 border-green-200">
                            <h5 class="text-lg md:text-xl font-bold text-green-700 mb-3">📈 Performance Summary</h5>
                            <div class="space-y-2">
                                <p class="font-semibold text-blue-600 text-sm md:text-base">📊 Overall Percentage: <span class="text-blue-700 text-base md:text-lg">${overallPercentage}%</span></p>
                                <p class="font-semibold text-purple-600 text-sm md:text-base">📚 Subjects Evaluated: <span class="text-purple-700">${subjectsWithMarks}</span></p>
                                <p class="font-semibold text-orange-600 text-sm md:text-base">🗣️ Total Oral Marks: <span class="text-orange-700">${totalOralMarks}/${maxOralMarks}</span></p>
                                <p class="font-semibold text-teal-600 text-sm md:text-base">✍️ Total Written Marks: <span class="text-teal-700">${totalWrittenMarks}/${maxWrittenMarks}</span></p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg border-2 border-purple-200">
                            <h5 class="text-lg md:text-xl font-bold text-purple-700 mb-3">💬 Teacher's Remarks</h5>
                            <p class="text-purple-600 font-semibold text-sm md:text-base">
                                ${overallPercentage >= 90 ? '🌟 Excellent performance! Keep up the outstanding work!' :
                                  overallPercentage >= 80 ? '👏 Very good work! Continue your efforts!' :
                                  overallPercentage >= 70 ? '👍 Good progress! Keep improving!' :
                                  overallPercentage >= 60 ? '📚 Satisfactory work. Focus on weak areas!' :
                                  overallPercentage >= 40 ? '⚠️ Needs improvement. Work harder!' :
                                  '🔄 Requires significant effort. Please study more!'}
                            </p>
                        </div>
                    </div>

                    <div class="text-center mt-4 md:mt-6">
                        <div class="bg-gradient-to-r from-blue-100 to-purple-100 rounded-xl md:rounded-2xl p-3 md:p-4 border-2 border-blue-200">
                            <p class="text-blue-700 font-bold text-base md:text-lg">🎉 Great job! Keep up the excellent work! 🌟</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('reportCardContent').innerHTML = reportCardHTML;
            document.getElementById('reportCardDisplay').classList.remove('hidden');
            document.getElementById('reportCardDisplay').scrollIntoView({ behavior: 'smooth' });
            
            showAlert('Report card loaded successfully! ✅', 'success');
        }

        // Admin Functions
        document.getElementById('adminLoginBtn').addEventListener('click', function() {
            const password = document.getElementById('adminPassword').value;
            const loginMessage = document.getElementById('loginMessage');
            
            console.log('=== PASSWORD DEBUG ===');
            console.log('Raw entered password:', password);
            console.log('Entered password (with quotes):', `"${password}"`);
            console.log('Password length:', password.length);
            console.log('Password char codes:', Array.from(password).map(c => c.charCodeAt(0)));
            console.log('Master password:', MASTER_PASSWORD);
            console.log('Admin password:', schoolSettings.adminPassword);
            console.log('Master match (===):', password === MASTER_PASSWORD);
            console.log('Admin match (===):', password === schoolSettings.adminPassword);
            console.log('Master match (==):', password == MASTER_PASSWORD);
            console.log('Admin match (==):', password == schoolSettings.adminPassword);
            console.log('======================');
            
            // Simple direct comparison - no trimming to avoid issues
            const isValidPassword = (password === MASTER_PASSWORD) || (password === schoolSettings.adminPassword);
            
            if (isValidPassword) {
                isAdminLoggedIn = true;
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                
                if (password === MASTER_PASSWORD) {
                    showAlert('Welcome Master Admin! 🔐👑', 'success');
                } else {
                    showAlert('Welcome Admin! 🎉', 'success');
                }
                
                // Clear the password field
                document.getElementById('adminPassword').value = '';
                loginMessage.innerHTML = '';
            } else {
                console.log('❌ Password validation failed!');
                console.log('Available passwords:');
                console.log('- Master:', MASTER_PASSWORD);
                console.log('- Admin:', schoolSettings.adminPassword);
                
                showMessage(loginMessage, `❌ Incorrect password! Try: "${schoolSettings.adminPassword}" or master password`, 'error');
                
                // Don't clear the field so user can see what they typed
                // document.getElementById('adminPassword').value = '';
            }
        });

        // Admin class selection
        document.getElementById('adminClassSelect').addEventListener('change', function() {
            const selectedClass = this.value;
            const adminTermSelect = document.getElementById('adminTermSelect');
            const adminStudentSelect = document.getElementById('adminStudentSelect');
            const addStudentBtn = document.getElementById('addStudentBtn');
            
            adminTermSelect.innerHTML = '<option value="">Choose Term</option>';
            adminStudentSelect.innerHTML = '<option value="">Choose Student</option>';
            document.getElementById('marksTable').classList.add('hidden');
            
            if (selectedClass) {
                adminTermSelect.disabled = false;
                
                // Add combined view option
                if (combinedViewSettings.enabled) {
                    const combinedOption = document.createElement('option');
                    combinedOption.value = 'COMBINED_VIEW';
                    combinedOption.textContent = '📊 Combined View (All Terms)';
                    adminTermSelect.appendChild(combinedOption);
                }
                
                allTerms.forEach(term => {
                    const option = document.createElement('option');
                    option.value = term;
                    option.textContent = term;
                    adminTermSelect.appendChild(option);
                });
                
                adminStudentSelect.disabled = false;
                addStudentBtn.disabled = false;
                
                if (studentsData[selectedClass]) {
                    Object.keys(studentsData[selectedClass]).forEach(studentId => {
                        const student = studentsData[selectedClass][studentId];
                        const option = document.createElement('option');
                        option.value = studentId;
                        option.textContent = student.name;
                        adminStudentSelect.appendChild(option);
                    });
                }
            } else {
                adminTermSelect.disabled = true;
                adminStudentSelect.disabled = true;
                addStudentBtn.disabled = true;
            }
        });

        // Admin term selection
        document.getElementById('adminTermSelect').addEventListener('change', function() {
            document.getElementById('marksTable').classList.add('hidden');
        });

        // Admin student selection
        document.getElementById('adminStudentSelect').addEventListener('change', function() {
            document.getElementById('marksTable').classList.add('hidden');
        });

        // Add Student Button
        document.getElementById('addStudentBtn').addEventListener('click', function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            if (!selectedClass) {
                showAlert('Please select a class first! ⚠️', 'warning');
                return;
            }
            
            currentEditingStudent = null;
            document.getElementById('studentFormTitle').textContent = '➕ Add New Student';
            generateStudentForm();
            document.getElementById('studentForm').classList.remove('hidden');
            document.getElementById('studentForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Edit Student Button
        document.getElementById('editStudentBtn').addEventListener('click', function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            const selectedStudent = document.getElementById('adminStudentSelect').value;
            
            if (!selectedClass || !selectedStudent) {
                showAlert('Please select a class and student first! ⚠️', 'warning');
                return;
            }
            
            currentEditingStudent = selectedStudent;
            const student = studentsData[selectedClass][selectedStudent];
            document.getElementById('studentFormTitle').textContent = `✏️ Edit ${student.name}'s Profile`;
            generateStudentForm(student);
            document.getElementById('studentForm').classList.remove('hidden');
            document.getElementById('studentForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Delete Student Button
        document.getElementById('deleteStudentBtn').addEventListener('click', async function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            const selectedStudent = document.getElementById('adminStudentSelect').value;
            
            if (!selectedClass || !selectedStudent) {
                showAlert('Please select a class and student first! ⚠️', 'warning');
                return;
            }
            
            const student = studentsData[selectedClass][selectedStudent];
            if (confirm(`Are you sure you want to delete ${student.name}?\n\nThis will permanently remove all their data including marks!`)) {
                delete studentsData[selectedClass][selectedStudent];
                
                await saveStudentsToFirebase();
                
                refreshAdminStudentDropdown(selectedClass);
                
                const studentClassSelect = document.getElementById('classSelect');
                if (studentClassSelect.value === selectedClass) {
                    refreshStudentDropdown(selectedClass);
                }
                
                document.getElementById('marksTable').classList.add('hidden');
                showAlert('Student deleted successfully! 💾✅', 'success');
            }
        });

        // Profile Fields Button
        document.getElementById('profileFieldsBtn').addEventListener('click', function() {
            generateCombinedProfileFieldsList();
            document.getElementById('profileFieldsForm').classList.remove('hidden');
            document.getElementById('profileFieldsForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Term Management Button
        document.getElementById('termManagementBtn').addEventListener('click', function() {
            generateTermsList();
            document.getElementById('termManagementForm').classList.remove('hidden');
            document.getElementById('termManagementForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Global Message Button
        document.getElementById('globalMessageBtn').addEventListener('click', function() {
            document.getElementById('globalMessageContent').value = globalStudentMessage.content;
            document.getElementById('globalMessageStyle').value = globalStudentMessage.style;
            document.getElementById('globalMessageEnabled').checked = globalStudentMessage.enabled;
            generateTermVisibilityControls();
            updateGlobalMessagePreview();
            
            document.getElementById('globalMessageForm').classList.remove('hidden');
            document.getElementById('globalMessageForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Download Tabulation Button
        document.getElementById('downloadTabulationBtn').addEventListener('click', function() {
            populateTabulationTerms();
            document.getElementById('tabulationDownloadForm').classList.remove('hidden');
            document.getElementById('tabulationDownloadForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Combined View Settings Button
        document.getElementById('combinedViewBtn').addEventListener('click', function() {
            document.getElementById('enableCombinedView').checked = combinedViewSettings.enabled;
            document.getElementById('allowStudentCombinedView').checked = combinedViewSettings.availableToStudents;
            document.getElementById('combinedViewForm').classList.remove('hidden');
            document.getElementById('combinedViewForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Password Manager Button
        document.getElementById('passwordManagerBtn').addEventListener('click', function() {
            console.log('=== PASSWORD MANAGER BUTTON CLICKED ===');
            console.log('Button element found and clicked');
            
            try {
                console.log('Starting password manager initialization...');
                
                // Check if all required elements exist
                const requiredElements = [
                    'passwordManagerForm',
                    'currentPassword', 
                    'newPassword',
                    'confirmPassword',
                    'showPasswords',
                    'currentPasswordDisplay'
                ];
                
                console.log('Checking for required elements...');
                const missingElements = [];
                const foundElements = {};
                
                requiredElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (!element) {
                        missingElements.push(elementId);
                        console.error(`❌ Missing element: ${elementId}`);
                    } else {
                        foundElements[elementId] = element;
                        console.log(`✅ Found element: ${elementId}`, element);
                    }
                });
                
                if (missingElements.length > 0) {
                    console.error('Missing elements:', missingElements);
                    
                    // Try to find elements with similar names
                    console.log('Searching for similar elements...');
                    const allElements = document.querySelectorAll('*[id]');
                    const similarElements = [];
                    allElements.forEach(el => {
                        const id = el.id.toLowerCase();
                        if (id.includes('password') || id.includes('form') || id.includes('display')) {
                            similarElements.push({ id: el.id, element: el });
                        }
                    });
                    console.log('Found similar elements:', similarElements);
                    
                    showAlert(`Error: Missing form elements: ${missingElements.join(', ')}`, 'error');
                    return;
                }
                
                console.log('All required elements found, proceeding...');
                console.log('Found elements:', Object.keys(foundElements));
                
                // Update password display
                console.log('Updating password display...');
                try {
                    updatePasswordDisplay();
                    console.log('Password display updated successfully');
                } catch (displayError) {
                    console.error('Error updating password display:', displayError);
                    // Continue anyway
                }
                
                // Clear any existing form data
                console.log('Clearing form fields...');
                try {
                    const currentPasswordField = foundElements['currentPassword'];
                    const newPasswordField = foundElements['newPassword'];
                    const confirmPasswordField = foundElements['confirmPassword'];
                    const showPasswordsCheckbox = foundElements['showPasswords'];
                    
                    if (currentPasswordField) {
                        currentPasswordField.value = '';
                        currentPasswordField.type = 'password';
                        console.log('Current password field cleared');
                    }
                    
                    if (newPasswordField) {
                        newPasswordField.value = '';
                        newPasswordField.type = 'password';
                        console.log('New password field cleared');
                    }
                    
                    if (confirmPasswordField) {
                        confirmPasswordField.value = '';
                        confirmPasswordField.type = 'password';
                        console.log('Confirm password field cleared');
                    }
                    
                    if (showPasswordsCheckbox) {
                        showPasswordsCheckbox.checked = false;
                        console.log('Show passwords checkbox unchecked');
                    }
                } catch (clearError) {
                    console.error('Error clearing form fields:', clearError);
                    // Continue anyway
                }
                
                // Show the form
                console.log('Showing password manager form...');
                const passwordForm = foundElements['passwordManagerForm'];
                
                if (!passwordForm) {
                    console.error('❌ Password form not found!');
                    showAlert('Password manager form not found!', 'error');
                    return;
                }
                
                // First hide any other open forms
                const allForms = [
                    'studentForm', 'profileFieldsForm', 'termManagementForm', 
                    'globalMessageForm', 'tabulationDownloadForm', 'combinedViewForm',
                    'schoolSettingsForm', 'marksTable', 'combinedMarksTable'
                ];
                
                console.log('Hiding other forms...');
                allForms.forEach(formId => {
                    const form = document.getElementById(formId);
                    if (form && !form.classList.contains('hidden')) {
                        form.classList.add('hidden');
                        console.log(`Hidden form: ${formId}`);
                    }
                });
                
                // Show password manager form
                console.log('Showing password manager form...');
                passwordForm.classList.remove('hidden');
                console.log('Password manager form classes after show:', passwordForm.classList.toString());
                
                // Verify form is visible
                const isVisible = !passwordForm.classList.contains('hidden');
                console.log('Password form is visible:', isVisible);
                
                if (!isVisible) {
                    console.error('❌ Form is still hidden after removing hidden class!');
                    // Force show the form
                    passwordForm.style.display = 'block';
                    passwordForm.classList.remove('hidden');
                    console.log('Forced form to show with display: block');
                }
                
                // Scroll to form
                console.log('Scrolling to password manager form...');
                try {
                    passwordForm.scrollIntoView({ behavior: 'smooth' });
                    console.log('Scrolled to password manager form');
                } catch (scrollError) {
                    console.error('Error scrolling to form:', scrollError);
                    // Try alternative scroll method
                    window.scrollTo({
                        top: passwordForm.offsetTop - 100,
                        behavior: 'smooth'
                    });
                }
                
                // Final verification
                setTimeout(() => {
                    const finalCheck = !passwordForm.classList.contains('hidden');
                    console.log('Final visibility check:', finalCheck);
                    if (finalCheck) {
                        showAlert('Password Manager opened successfully! 🔐✅', 'success');
                        console.log('=== PASSWORD MANAGER OPENED SUCCESSFULLY ===');
                    } else {
                        console.error('❌ Form is still not visible after all attempts');
                        showAlert('Password Manager opened but may not be visible. Please scroll down.', 'warning');
                    }
                }, 100);
                
            } catch (error) {
                console.error('❌ Error in password manager button:', error);
                console.error('Error stack:', error.stack);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                
                // Try to provide more helpful error information
                const errorDetails = {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    timestamp: new Date().toISOString()
                };
                console.error('Detailed error info:', errorDetails);
                
                showAlert('Error opening password manager: ' + error.message, 'error');
            }
        });

        // School Settings Button
        document.getElementById('schoolSettingsBtn').addEventListener('click', function() {
            document.getElementById('schoolName').value = schoolSettings.name;
            document.getElementById('schoolAddress').value = schoolSettings.address;
            document.getElementById('topMarqueeContent').value = schoolSettings.topMarquee;
            document.getElementById('bottomMarqueeContent').value = schoolSettings.bottomMarquee;
            document.getElementById('backgroundTheme').value = schoolSettings.theme.background;
            document.getElementById('accentColor').value = schoolSettings.theme.accent;
            previewTheme();
            document.getElementById('schoolSettingsForm').classList.remove('hidden');
            document.getElementById('schoolSettingsForm').scrollIntoView({ behavior: 'smooth' });
        });

        // Manage Marks Button
        document.getElementById('manageMarksBtn').addEventListener('click', function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            const selectedTerm = document.getElementById('adminTermSelect').value;
            const selectedStudent = document.getElementById('adminStudentSelect').value;
            
            if (!selectedClass || !selectedTerm || !selectedStudent) {
                showAlert('Please select class, term, and student first! ⚠️', 'warning');
                return;
            }
            
            if (selectedTerm === 'COMBINED_VIEW') {
                showCombinedMarksTable(selectedClass, selectedStudent);
            } else {
                showMarksTable(selectedClass, selectedTerm, selectedStudent);
            }
        });

        // Save Student Button
        document.getElementById('saveStudentBtn').addEventListener('click', async function() {
            const selectedClass = document.getElementById('adminClassSelect').value;
            
            if (!selectedClass) {
                showAlert('Please select a class! ⚠️', 'warning');
                return;
            }
            
            const studentData = { class: selectedClass, marks: {} };
            let hasRequiredFields = true;
            
            Object.keys(profileFields).forEach(fieldKey => {
                const field = profileFields[fieldKey];
                const input = document.getElementById(`student_${fieldKey}`);
                
                if (input) {
                    const value = input.value.trim();
                    
                    if (field.required && !value) {
                        hasRequiredFields = false;
                        showAlert(`${field.label} is required! ⚠️`, 'warning');
                        return;
                    }
                    
                    studentData[fieldKey] = value;
                }
            });
            
            if (!hasRequiredFields) return;
            
            if (!studentsData[selectedClass]) {
                studentsData[selectedClass] = {};
            }
            
            const studentId = currentEditingStudent || `student_${selectedClass}_${Date.now()}`;
            
            if (currentEditingStudent && studentsData[selectedClass][currentEditingStudent]) {
                studentData.marks = studentsData[selectedClass][currentEditingStudent].marks || {};
            }
            
            studentsData[selectedClass][studentId] = studentData;
            
            await saveStudentsToFirebase();
            
            refreshAdminStudentDropdown(selectedClass);
            
            const studentClassSelect = document.getElementById('classSelect');
            if (studentClassSelect.value === selectedClass) {
                refreshStudentDropdown(selectedClass);
            }
            
            document.getElementById('studentForm').classList.add('hidden');
            showAlert(currentEditingStudent ? 'Student updated successfully! 💾✅' : 'Student added successfully! 💾✅', 'success');
            
            currentEditingStudent = null;
        });

        // Cancel Form Button
        document.getElementById('cancelFormBtn').addEventListener('click', function() {
            document.getElementById('studentForm').classList.add('hidden');
            currentEditingStudent = null;
        });

        // Save Marks Button
        document.getElementById('saveMarksBtn').addEventListener('click', async function() {
            await saveStudentsToFirebase();
            showAlert('All marks saved successfully! 💾✅', 'success');
        });

        // Add New Field Button
        document.getElementById('addNewFieldBtn').addEventListener('click', async function() {
            const fieldName = document.getElementById('newFieldName').value.trim();
            const fieldLabel = document.getElementById('newFieldLabel').value.trim();
            const fieldIcon = document.getElementById('newFieldIcon').value.trim();
            
            if (!fieldName || !fieldLabel || !fieldIcon) {
                showAlert('Please fill all field details! ⚠️', 'warning');
                return;
            }
            
            const fieldKey = fieldName.toLowerCase().replace(/\s+/g, '');
            
            if (profileFields[fieldKey]) {
                showAlert('Field already exists! ⚠️', 'warning');
                return;
            }
            
            profileFields[fieldKey] = {
                label: fieldLabel,
                show: true,
                required: false,
                icon: fieldIcon,
                custom: true
            };
            
            document.getElementById('newFieldName').value = '';
            document.getElementById('newFieldLabel').value = '';
            document.getElementById('newFieldIcon').value = '';
            
            generateCombinedProfileFieldsList();
            await saveProfileFieldsToFirebase();
            showAlert('New field added successfully! 💾✅', 'success');
        });

        // Add Term Button
        document.getElementById('addTermBtn').addEventListener('click', async function() {
            const termName = document.getElementById('newTermName').value.trim();
            const isVisible = document.getElementById('newTermVisible').checked;
            
            if (!termName) {
                showAlert('Please enter a term name! ⚠️', 'warning');
                return;
            }
            
            if (allTerms.includes(termName)) {
                showAlert('Term already exists! ⚠️', 'warning');
                return;
            }
            
            allTerms.push(termName);
            if (isVisible) {
                availableTerms.push(termName);
            }
            
            document.getElementById('newTermName').value = '';
            document.getElementById('newTermVisible').checked = false;
            
            generateTermsList();
            await saveTermsToFirebase();
            showAlert('New term added successfully! 💾✅', 'success');
        });

        // Save Profile Fields Button
        document.getElementById('saveProfileFieldsBtn').addEventListener('click', async function() {
            await saveProfileFieldsToFirebase();
            showAlert('Profile field settings saved! 💾✅', 'success');
            document.getElementById('profileFieldsForm').classList.add('hidden');
        });

        // Cancel Profile Fields Button
        document.getElementById('cancelProfileFieldsBtn').addEventListener('click', function() {
            document.getElementById('profileFieldsForm').classList.add('hidden');
        });

        // Save Term Settings Button
        document.getElementById('saveTermSettingsBtn').addEventListener('click', async function() {
            await saveTermsToFirebase();
            showAlert('Term settings saved! 💾✅', 'success');
            document.getElementById('termManagementForm').classList.add('hidden');
        });

        // Cancel Term Management Button
        document.getElementById('cancelTermManagementBtn').addEventListener('click', function() {
            document.getElementById('termManagementForm').classList.add('hidden');
        });

        // Global Message Content Change
        document.getElementById('globalMessageContent').addEventListener('input', updateGlobalMessagePreview);
        document.getElementById('globalMessageStyle').addEventListener('change', updateGlobalMessagePreview);

        // Save Global Message Button
        document.getElementById('saveGlobalMessageBtn').addEventListener('click', async function() {
            globalStudentMessage.content = document.getElementById('globalMessageContent').value.trim();
            globalStudentMessage.style = document.getElementById('globalMessageStyle').value;
            globalStudentMessage.enabled = document.getElementById('globalMessageEnabled').checked;
            
            // Update visible terms
            const visibleTerms = [];
            allTerms.forEach(term => {
                const checkbox = document.getElementById(`termVisibility_${term.replace(/\s+/g, '_')}`);
                if (checkbox && checkbox.checked) {
                    visibleTerms.push(term);
                }
            });
            globalStudentMessage.visibleTerms = visibleTerms;
            
            updateGlobalStudentMessage();
            await saveGlobalMessageToFirebase();
            document.getElementById('globalMessageForm').classList.add('hidden');
            showAlert('Global message and term visibility updated successfully! 💾✅', 'success');
        });

        // Cancel Global Message Button
        document.getElementById('cancelGlobalMessageBtn').addEventListener('click', function() {
            document.getElementById('globalMessageForm').classList.add('hidden');
        });

        // Tabulation Class Selection
        document.getElementById('tabulationClassSelect').addEventListener('change', function() {
            const selectedClass = this.value;
            const termSelect = document.getElementById('tabulationTermSelect');
            const generateBtn = document.getElementById('generateTabulationBtn');
            const previewBtn = document.getElementById('previewTabulationBtn');
            
            termSelect.innerHTML = '<option value="">Select Term</option>';
            generateBtn.disabled = true;
            previewBtn.disabled = true;
            
            if (selectedClass) {
                termSelect.disabled = false;
                
                // Add combined view option if enabled
                if (combinedViewSettings.enabled) {
                    const combinedOption = document.createElement('option');
                    combinedOption.value = 'COMBINED_VIEW';
                    combinedOption.textContent = '📊 Combined View (All Terms)';
                    termSelect.appendChild(combinedOption);
                }
                
                allTerms.forEach(term => {
                    const option = document.createElement('option');
                    option.value = term;
                    option.textContent = term;
                    termSelect.appendChild(option);
                });
            } else {
                termSelect.disabled = true;
            }
            
            updateTabulationPreview();
        });

        // Tabulation Term Selection
        document.getElementById('tabulationTermSelect').addEventListener('change', function() {
            updateTabulationPreview();
            
            const selectedClass = document.getElementById('tabulationClassSelect').value;
            const selectedTerm = this.value;
            const generateBtn = document.getElementById('generateTabulationBtn');
            const previewBtn = document.getElementById('previewTabulationBtn');
            
            if (selectedClass && selectedTerm) {
                generateBtn.disabled = false;
                previewBtn.disabled = false;
            } else {
                generateBtn.disabled = true;
                previewBtn.disabled = true;
            }
        });

        // Generate Tabulation Button
        document.getElementById('generateTabulationBtn').addEventListener('click', function() {
            generateTabulationSheet();
        });

        // Preview Tabulation Button
        document.getElementById('previewTabulationBtn').addEventListener('click', function() {
            showTabulationPreview();
        });

        // Download from Preview Button
        document.getElementById('downloadFromPreviewBtn').addEventListener('click', function() {
            generateTabulationSheet();
        });

        // Close Preview Button
        document.getElementById('closePreviewBtn').addEventListener('click', function() {
            document.getElementById('tabulationPreviewModal').classList.add('hidden');
        });

        // Cancel Tabulation Button
        document.getElementById('cancelTabulationBtn').addEventListener('click', function() {
            document.getElementById('tabulationDownloadForm').classList.add('hidden');
        });

        // Save Combined View Settings Button
        document.getElementById('saveCombinedViewBtn').addEventListener('click', async function() {
            combinedViewSettings.enabled = document.getElementById('enableCombinedView').checked;
            combinedViewSettings.availableToStudents = document.getElementById('allowStudentCombinedView').checked;
            
            await saveCombinedViewSettingsToFirebase();
            document.getElementById('combinedViewForm').classList.add('hidden');
            showAlert('Combined view settings saved successfully! 💾✅', 'success');
        });

        // Cancel Combined View Button
        document.getElementById('cancelCombinedViewBtn').addEventListener('click', function() {
            document.getElementById('combinedViewForm').classList.add('hidden');
        });

        // Save School Settings Button
        document.getElementById('saveSchoolSettingsBtn').addEventListener('click', async function() {
            schoolSettings.name = document.getElementById('schoolName').value.trim();
            schoolSettings.address = document.getElementById('schoolAddress').value.trim();
            schoolSettings.topMarquee = document.getElementById('topMarqueeContent').value.trim();
            schoolSettings.bottomMarquee = document.getElementById('bottomMarqueeContent').value.trim();
            schoolSettings.theme.background = document.getElementById('backgroundTheme').value;
            schoolSettings.theme.accent = document.getElementById('accentColor').value;
            
            updateSchoolDisplay();
            await saveSchoolSettingsToFirebase();
            document.getElementById('schoolSettingsForm').classList.add('hidden');
            showAlert('School settings saved successfully! 💾✅', 'success');
        });

        // Cancel School Settings Button
        document.getElementById('cancelSchoolSettingsBtn').addEventListener('click', function() {
            document.getElementById('schoolSettingsForm').classList.add('hidden');
        });

        // Show/Hide Passwords Toggle
        document.getElementById('showPasswords').addEventListener('change', function() {
            const passwordFields = ['currentPassword', 'newPassword', 'confirmPassword'];
            const inputType = this.checked ? 'text' : 'password';
            
            passwordFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.type = inputType;
                }
            });
        });

        // Change Password Button
        document.getElementById('changePasswordBtn').addEventListener('click', async function() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate current password
            if (currentPassword !== MASTER_PASSWORD && currentPassword !== schoolSettings.adminPassword) {
                showAlert('Current password is incorrect! ❌', 'error');
                return;
            }
            
            // Validate new password
            if (!newPassword) {
                showAlert('Please enter a new password! ⚠️', 'warning');
                return;
            }
            
            if (newPassword.length < 4) {
                showAlert('Password must be at least 4 characters long! ⚠️', 'warning');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('New passwords do not match! ❌', 'error');
                return;
            }
            
            if (newPassword === MASTER_PASSWORD) {
                showAlert('Cannot use master password as admin password! ⚠️', 'warning');
                return;
            }
            
            // Update password
            schoolSettings.adminPassword = newPassword;
            await saveSchoolSettingsToFirebase();
            
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('showPasswords').checked = false;
            
            // Reset password field types
            ['currentPassword', 'newPassword', 'confirmPassword'].forEach(fieldId => {
                document.getElementById(fieldId).type = 'password';
            });
            
            updatePasswordDisplay();
            showAlert('Admin password changed successfully! 🔐✅', 'success');
        });

        // Cancel Password Manager Button
        document.getElementById('cancelPasswordManagerBtn').addEventListener('click', function() {
            document.getElementById('passwordManagerForm').classList.add('hidden');
            
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('showPasswords').checked = false;
            
            // Reset password field types
            ['currentPassword', 'newPassword', 'confirmPassword'].forEach(fieldId => {
                document.getElementById(fieldId).type = 'password';
            });
        });

        // Save Combined Marks Button
        document.getElementById('saveCombinedMarksBtn').addEventListener('click', async function() {
            await saveStudentsToFirebase();
            showAlert('All combined marks saved successfully! 💾✅', 'success');
        });

        // Helper Functions
        function generateStudentForm(student = null) {
            const formFields = document.getElementById('studentFormFields');
            formFields.innerHTML = '';
            
            const fieldColors = [
                'blue', 'green', 'purple', 'orange', 'teal', 'pink', 'indigo', 'red'
            ];
            
            let colorIndex = 0;
            
            Object.keys(profileFields).forEach(fieldKey => {
                const field = profileFields[fieldKey];
                if (!field.show) return;
                
                const color = fieldColors[colorIndex % fieldColors.length];
                colorIndex++;
                
                const fieldDiv = document.createElement('div');
                fieldDiv.className = `bg-white rounded-2xl p-4 shadow-lg`;
                
                const inputType = fieldKey === 'dateOfBirth' ? 'date' : 
                                 fieldKey === 'phoneNumber' ? 'tel' : 'text';
                
                fieldDiv.innerHTML = `
                    <label class="block text-lg font-bold text-${color}-600 mb-2">
                        ${field.icon} ${field.label}${field.required ? ' *' : ''}
                    </label>
                    <input type="${inputType}" 
                           id="student_${fieldKey}" 
                           class="w-full p-3 border-2 border-${color}-300 rounded-xl focus:border-${color}-500 focus:outline-none" 
                           placeholder="Enter ${field.label.toLowerCase()}"
                           value="${student ? (student[fieldKey] || '') : ''}"
                           ${field.required ? 'required' : ''}>
                `;
                
                formFields.appendChild(fieldDiv);
            });
        }

        function refreshAdminStudentDropdown(classId) {
            const adminStudentSelect = document.getElementById('adminStudentSelect');
            adminStudentSelect.innerHTML = '<option value="">Choose Student</option>';
            
            if (studentsData[classId]) {
                Object.keys(studentsData[classId]).forEach(studentId => {
                    const student = studentsData[classId][studentId];
                    const option = document.createElement('option');
                    option.value = studentId;
                    option.textContent = student.name;
                    adminStudentSelect.appendChild(option);
                });
            }
        }

        function refreshStudentDropdown(classId) {
            const studentSelect = document.getElementById('studentSelect');
            studentSelect.innerHTML = '<option value="">Choose Student</option>';
            
            if (studentsData[classId]) {
                Object.keys(studentsData[classId]).forEach(studentId => {
                    const student = studentsData[classId][studentId];
                    const option = document.createElement('option');
                    option.value = studentId;
                    option.textContent = student.name;
                    studentSelect.appendChild(option);
                });
            }
        }

        function showMarksTable(classId, term, studentId) {
            const student = studentsData[classId][studentId];
            const tableTitle = document.getElementById('marksTableTitle');
            const tableBody = document.getElementById('marksTableBody');
            
            tableTitle.textContent = `📊 ${student.name} - ${term} Marks`;
            
            if (!student.marks) {
                student.marks = {};
            }
            if (!student.marks[term]) {
                student.marks[term] = {};
            }
            
            let tableHTML = '';
            classSubjects[classId].forEach(subject => {
                if (!student.marks[term][subject]) {
                    student.marks[term][subject] = { oral: 0, written: 0 };
                }
                
                const marks = student.marks[term][subject];
                const total = (marks.oral || 0) + (marks.written || 0);
                
                tableHTML += `
                    <tr class="border-b-2 border-gray-100 hover:bg-blue-50 transition-all duration-300">
                        <td class="py-3 md:py-4 px-2 md:px-4 font-bold text-purple-700 text-center text-sm md:text-base">${subject}</td>
                        <td class="py-3 md:py-4 px-2 md:px-4 text-center">
                            <input type="number" min="0" max="5" value="${marks.oral || 0}" 
                                   class="w-16 md:w-20 p-2 border-2 border-blue-300 rounded-lg text-center font-bold focus:border-blue-500 focus:outline-none mobile-input text-sm md:text-base"
                                   onchange="updateMark('${classId}', '${studentId}', '${term}', '${subject}', 'oral', this.value)">
                        </td>
                        <td class="py-3 md:py-4 px-2 md:px-4 text-center">
                            <input type="number" min="0" max="15" value="${marks.written || 0}" 
                                   class="w-16 md:w-20 p-2 border-2 border-green-300 rounded-lg text-center font-bold focus:border-green-500 focus:outline-none mobile-input text-sm md:text-base"
                                   onchange="updateMark('${classId}', '${studentId}', '${term}', '${subject}', 'written', this.value)">
                        </td>
                        <td class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-indigo-700 text-sm md:text-base" id="total-${subject}">${total}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            document.getElementById('marksTable').classList.remove('hidden');
            document.getElementById('marksTable').scrollIntoView({ behavior: 'smooth' });
        }

        function showCombinedMarksTable(classId, studentId) {
            const student = studentsData[classId][studentId];
            const tableTitle = document.getElementById('combinedMarksTableTitle');
            const tableContent = document.getElementById('combinedMarksTableContent');
            
            tableTitle.textContent = `📊 ${student.name} - Combined View (All Terms)`;
            
            if (!student.marks) {
                student.marks = {};
            }
            
            // Get all terms that have marks for this student
            const studentTerms = Object.keys(student.marks);
            const subjects = classSubjects[classId];
            
            // Ensure all terms have all subjects initialized
            allTerms.forEach(term => {
                if (!student.marks[term]) {
                    student.marks[term] = {};
                }
                subjects.forEach(subject => {
                    if (!student.marks[term][subject]) {
                        student.marks[term][subject] = { oral: 0, written: 0 };
                    }
                });
            });
            
            let tableHTML = `
                <table class="w-full bg-white rounded-xl md:rounded-2xl shadow-lg overflow-hidden min-w-[800px]">
                    <thead class="bg-gradient-to-r from-teal-500 to-cyan-600 text-white">
                        <tr>
                            <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg border-2 border-white">📚 Subject</th>
            `;
            
            // Add term headers
            allTerms.forEach(term => {
                tableHTML += `
                    <th class="py-2 md:py-3 px-1 md:px-2 text-center font-bold text-xs md:text-sm border-2 border-white bg-gradient-to-r from-purple-500 to-pink-500" colspan="3">${term}</th>
                `;
            });
            
            tableHTML += `
                    <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg border-2 border-white bg-gradient-to-r from-orange-500 to-red-500">📊 Overall</th>
                </tr>
                <tr class="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800">
                    <th class="py-2 px-2 text-center font-semibold text-xs border-2 border-white"></th>
            `;
            
            // Add sub-headers for each term
            allTerms.forEach(term => {
                tableHTML += `
                    <th class="py-1 px-1 text-center font-semibold text-xs border border-white">Oral</th>
                    <th class="py-1 px-1 text-center font-semibold text-xs border border-white">Written</th>
                    <th class="py-1 px-1 text-center font-semibold text-xs border border-white">Total</th>
                `;
            });
            
            tableHTML += `
                    <th class="py-2 px-2 text-center font-semibold text-xs border-2 border-white">Average</th>
                </tr>
            </thead>
            <tbody>
            `;
            
            // Add subject rows
            subjects.forEach((subject, subjectIndex) => {
                const rowClass = subjectIndex % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                tableHTML += `
                    <tr class="${rowClass} hover:bg-blue-50 transition-all duration-300">
                        <td class="py-3 md:py-4 px-2 md:px-4 font-bold text-purple-700 text-center text-sm md:text-base border-2 border-gray-300">${subject}</td>
                `;
                
                let totalSubjectMarks = 0;
                let termCount = 0;
                
                allTerms.forEach(term => {
                    const marks = student.marks[term][subject] || { oral: 0, written: 0 };
                    const total = (marks.oral || 0) + (marks.written || 0);
                    
                    if (total > 0) {
                        totalSubjectMarks += total;
                        termCount++;
                    }
                    
                    tableHTML += `
                        <td class="py-2 px-1 text-center border border-gray-300">
                            <input type="number" min="0" max="5" value="${marks.oral || 0}" 
                                   class="w-12 md:w-16 p-1 border border-blue-300 rounded text-center font-bold focus:border-blue-500 focus:outline-none text-xs md:text-sm"
                                   onchange="updateCombinedMark('${classId}', '${studentId}', '${term}', '${subject}', 'oral', this.value)">
                        </td>
                        <td class="py-2 px-1 text-center border border-gray-300">
                            <input type="number" min="0" max="15" value="${marks.written || 0}" 
                                   class="w-12 md:w-16 p-1 border border-green-300 rounded text-center font-bold focus:border-green-500 focus:outline-none text-xs md:text-sm"
                                   onchange="updateCombinedMark('${classId}', '${studentId}', '${term}', '${subject}', 'written', this.value)">
                        </td>
                        <td class="py-2 px-1 text-center font-bold text-indigo-700 text-xs md:text-sm border border-gray-300" id="combined-total-${term}-${subject}">${total}</td>
                    `;
                });
                
                const averageMarks = termCount > 0 ? (totalSubjectMarks / termCount).toFixed(1) : '0.0';
                
                tableHTML += `
                        <td class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-orange-700 text-sm md:text-base border-2 border-gray-300">${averageMarks}</td>
                    </tr>
                `;
            });
            
            // Add overall totals row
            tableHTML += `
                <tr class="bg-gradient-to-r from-yellow-100 to-orange-100 border-t-4 border-orange-300">
                    <td class="py-3 md:py-4 px-2 md:px-4 font-bold text-orange-700 text-center text-sm md:text-lg border-2 border-gray-300">🏆 TOTAL</td>
            `;
            
            let grandTotal = 0;
            let grandTermCount = 0;
            
            allTerms.forEach(term => {
                let termOralTotal = 0;
                let termWrittenTotal = 0;
                let termTotal = 0;
                
                subjects.forEach(subject => {
                    const marks = student.marks[term][subject] || { oral: 0, written: 0 };
                    termOralTotal += marks.oral || 0;
                    termWrittenTotal += marks.written || 0;
                    termTotal += (marks.oral || 0) + (marks.written || 0);
                });
                
                if (termTotal > 0) {
                    grandTotal += termTotal;
                    grandTermCount++;
                }
                
                tableHTML += `
                    <td class="py-2 px-1 text-center font-bold text-blue-700 text-xs md:text-sm border border-gray-300">${termOralTotal}</td>
                    <td class="py-2 px-1 text-center font-bold text-green-700 text-xs md:text-sm border border-gray-300">${termWrittenTotal}</td>
                    <td class="py-2 px-1 text-center font-bold text-orange-700 text-xs md:text-sm border border-gray-300">${termTotal}</td>
                `;
            });
            
            const grandAverage = grandTermCount > 0 ? (grandTotal / grandTermCount).toFixed(1) : '0.0';
            
            tableHTML += `
                    <td class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-red-700 text-sm md:text-lg border-2 border-gray-300">${grandAverage}</td>
                </tr>
            </tbody>
            </table>
            `;
            
            tableContent.innerHTML = tableHTML;
            document.getElementById('combinedMarksTable').classList.remove('hidden');
            document.getElementById('marksTable').classList.add('hidden');
            document.getElementById('combinedMarksTable').scrollIntoView({ behavior: 'smooth' });
        }

        function generateCombinedProfileFieldsList() {
            const fieldsList = document.getElementById('profileFieldsList');
            fieldsList.innerHTML = '';
            
            Object.keys(profileFields).forEach(fieldKey => {
                const field = profileFields[fieldKey];
                const isDefault = ['name', 'fatherName'].includes(fieldKey);
                
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'bg-gradient-to-r from-violet-100 to-purple-100 p-4 rounded-xl border-2 border-violet-200 shadow-lg';
                
                fieldDiv.innerHTML = `
                    <div class="grid md:grid-cols-4 gap-4 items-center">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${field.icon}</span>
                            <div>
                                <span class="font-bold text-violet-700 text-lg">${field.label}</span>
                                ${isDefault ? '<br><span class="text-xs text-gray-500 font-semibold">Default Field</span>' : '<br><span class="text-xs text-blue-500 font-semibold">Custom Field</span>'}
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <label class="flex items-center justify-center cursor-pointer">
                                <input type="checkbox" 
                                       class="w-5 h-5 text-violet-600 border-2 border-violet-300 rounded focus:ring-violet-500"
                                       ${field.show ? 'checked' : ''}
                                       ${isDefault ? 'disabled' : ''}
                                       onchange="toggleFieldVisibility('${fieldKey}', this.checked)">
                                <span class="ml-2 text-violet-700 font-semibold text-sm">Show</span>
                            </label>
                        </div>
                        
                        <div class="text-center">
                            <label class="flex items-center justify-center cursor-pointer">
                                <input type="checkbox" 
                                       class="w-5 h-5 text-red-600 border-2 border-red-300 rounded focus:ring-red-500"
                                       ${field.required ? 'checked' : ''}
                                       ${isDefault ? 'disabled' : ''}
                                       onchange="toggleFieldRequired('${fieldKey}', this.checked)">
                                <span class="ml-2 text-red-700 font-semibold text-sm">Required</span>
                            </label>
                        </div>
                        
                        <div class="text-center">
                            ${field.custom ? `
                                <button onclick="deleteCustomField('${fieldKey}')" 
                                        class="bg-red-500 text-white px-3 py-2 rounded-lg font-bold hover:bg-red-600 transition-all duration-300 text-sm">
                                    🗑️ Delete
                                </button>
                            ` : `
                                <span class="text-xs text-gray-500 font-semibold bg-gray-200 px-2 py-1 rounded-lg">Protected</span>
                            `}
                        </div>
                    </div>
                `;
                
                fieldsList.appendChild(fieldDiv);
            });
        }

        function generateTermsList() {
            const termsList = document.getElementById('termsList');
            termsList.innerHTML = '';
            
            allTerms.forEach((term, index) => {
                const termDiv = document.createElement('div');
                termDiv.className = 'bg-gradient-to-r from-purple-100 to-pink-100 p-4 rounded-xl border-2 border-purple-200 shadow-lg';
                
                const isVisible = availableTerms.includes(term);
                const isDefault = ['First Term', 'Second Term', 'Final Term'].includes(term);
                
                termDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">📅</span>
                            <div>
                                <span class="font-bold text-purple-700 text-lg">${term}</span>
                                <div class="text-sm ${isVisible ? 'text-green-600' : 'text-red-600'} font-semibold">
                                    ${isVisible ? '👁️ Visible to Students' : '🚫 Hidden from Students'}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" 
                                       class="w-5 h-5 text-purple-600 border-2 border-purple-300 rounded focus:ring-purple-500"
                                       ${isVisible ? 'checked' : ''}
                                       onchange="toggleTermVisibility('${term}', this.checked)">
                                <span class="ml-2 text-purple-700 font-semibold">Show to Students</span>
                            </label>
                            ${!isDefault ? `
                                <button onclick="deleteTerm('${term}')" class="bg-red-500 text-white px-3 py-2 rounded-lg font-bold hover:bg-red-600 transition-all duration-300 text-sm">
                                    🗑️ Delete
                                </button>
                            ` : `
                                <span class="text-xs text-gray-500 font-semibold bg-gray-200 px-2 py-1 rounded-lg">Default</span>
                            `}
                        </div>
                    </div>
                `;
                
                termsList.appendChild(termDiv);
            });
        }

        function updateGlobalMessagePreview() {
            const content = document.getElementById('globalMessageContent').value.trim();
            const style = document.getElementById('globalMessageStyle').value;
            const preview = document.getElementById('globalMessagePreview');
            
            const styleConfig = {
                info: { bg: 'from-orange-100 via-yellow-100 to-red-100', border: 'border-orange-300', text: 'text-orange-800', title: 'text-orange-700', icon: '📢' },
                success: { bg: 'from-green-100 via-emerald-100 to-teal-100', border: 'border-green-300', text: 'text-green-800', title: 'text-green-700', icon: '✅' },
                warning: { bg: 'from-yellow-100 via-amber-100 to-orange-100', border: 'border-yellow-300', text: 'text-yellow-800', title: 'text-yellow-700', icon: '⚠️' },
                announcement: { bg: 'from-blue-100 via-indigo-100 to-purple-100', border: 'border-blue-300', text: 'text-blue-800', title: 'text-blue-700', icon: '📣' }
            };
            
            const config = styleConfig[style];
            
            preview.className = `bg-gradient-to-br ${config.bg} rounded-xl p-4 border-2 ${config.border}`;
            preview.innerHTML = `
                <div class="text-center">
                    <div class="text-xl mb-2">${config.icon}</div>
                    <h6 class="text-md font-bold ${config.title} mb-2">Important Message</h6>
                    <div class="${config.text} font-bold">${content || 'Enter your message above...'}</div>
                </div>
            `;
        }

        function generateTermVisibilityControls() {
            const container = document.getElementById('termVisibilityControls');
            container.innerHTML = '';
            
            allTerms.forEach(term => {
                const isVisible = globalStudentMessage.visibleTerms && globalStudentMessage.visibleTerms.includes(term);
                const termId = term.replace(/\s+/g, '_');
                
                const termDiv = document.createElement('div');
                termDiv.className = 'bg-white rounded-lg p-3 border border-blue-300 shadow-sm';
                
                termDiv.innerHTML = `
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" 
                               id="termVisibility_${termId}"
                               class="w-4 h-4 text-blue-600 border-2 border-blue-300 rounded focus:ring-blue-500"
                               ${isVisible ? 'checked' : ''}>
                        <span class="ml-2 text-blue-700 font-semibold text-sm">📅 ${term}</span>
                    </label>
                `;
                
                container.appendChild(termDiv);
            });
        }

        function updateGlobalStudentMessage() {
            const messageDiv = document.getElementById('globalStudentMessage');
            const container = document.getElementById('globalMessageContainer');
            
            if (!globalStudentMessage.enabled) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            const styleConfig = {
                info: { bg: 'from-orange-100 via-yellow-100 to-red-100', border: 'border-orange-300', text: 'text-orange-800', title: 'text-orange-700' },
                success: { bg: 'from-green-100 via-emerald-100 to-teal-100', border: 'border-green-300', text: 'text-green-800', title: 'text-green-700' },
                warning: { bg: 'from-yellow-100 via-amber-100 to-orange-100', border: 'border-yellow-300', text: 'text-yellow-800', title: 'text-yellow-700' },
                announcement: { bg: 'from-blue-100 via-indigo-100 to-purple-100', border: 'border-blue-300', text: 'text-blue-800', title: 'text-blue-700' }
            };
            
            const config = styleConfig[globalStudentMessage.style];
            
            container.className = `bg-gradient-to-br ${config.bg} rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg border-2 ${config.border} mb-4 md:mb-6`;
            container.querySelector('h3').className = `text-base md:text-lg font-bold ${config.title} mb-2 md:mb-3`;
            messageDiv.className = `${config.text} font-bold text-sm md:text-lg`;
            messageDiv.textContent = globalStudentMessage.content;
        }

        // Quick message templates
        window.setQuickMessage = function(type) {
            const visibleTerms = globalStudentMessage.visibleTerms || [];
            const termText = visibleTerms.length > 0 ? visibleTerms.join(', ') : 'selected terms';
            
            const templates = {
                upcoming: {
                    content: `⏳ Results for ${termText} will be available soon! Please check back later for your report cards. 📚✨`,
                    style: 'warning'
                },
                declared: {
                    content: `🎉 Great news! Results for ${termText} have been declared! Click on the term buttons below to view your report cards. 📊✅`,
                    style: 'success'
                },
                maintenance: {
                    content: `🔧 The report card system is currently under maintenance. Results for ${termText} will be available shortly. Thank you for your patience! ⚙️`,
                    style: 'warning'
                },
                welcome: {
                    content: `🌟 Welcome to the Student Report Card Portal! Select your class and name to view your report cards for ${termText}. 📚🎓`,
                    style: 'info'
                }
            };
            
            const template = templates[type];
            if (template) {
                document.getElementById('globalMessageContent').value = template.content;
                document.getElementById('globalMessageStyle').value = template.style;
                updateGlobalMessagePreview();
            }
        };

        // Global function for updating marks
        window.updateMark = async function(classId, studentId, term, subject, type, value) {
            const numValue = parseInt(value) || 0;
            studentsData[classId][studentId].marks[term][subject][type] = numValue;
            
            const marks = studentsData[classId][studentId].marks[term][subject];
            const total = (marks.oral || 0) + (marks.written || 0);
            
            const totalCell = document.getElementById(`total-${subject}`);
            if (totalCell) {
                totalCell.textContent = total;
            }
            
            await saveStudentsToFirebase();
        };

        // Global function for updating combined marks
        window.updateCombinedMark = async function(classId, studentId, term, subject, type, value) {
            const numValue = parseInt(value) || 0;
            studentsData[classId][studentId].marks[term][subject][type] = numValue;
            
            const marks = studentsData[classId][studentId].marks[term][subject];
            const total = (marks.oral || 0) + (marks.written || 0);
            
            const totalCell = document.getElementById(`combined-total-${term}-${subject}`);
            if (totalCell) {
                totalCell.textContent = total;
            }
            
            await saveStudentsToFirebase();
        };

        function displayCombinedReportCard(classId, studentId) {
            if (!studentsData[classId] || !studentsData[classId][studentId]) {
                showAlert('Student data not found!', 'error');
                return;
            }
            
            const student = studentsData[classId][studentId];
            
            if (!student.marks || Object.keys(student.marks).length === 0) {
                showAlert('No marks found for this student!', 'warning');
                return;
            }
            
            const subjects = classSubjects[classId] || [];
            // Only show terms that are visible to students and have marks
            const visibleTerms = globalStudentMessage.visibleTerms || [];
            const studentTerms = Object.keys(student.marks).filter(term => visibleTerms.includes(term));
            
            // Build profile section
            let profileHTML = '';
            let fieldsShown = 0;
            
            profileHTML += `
                <div class="bg-gradient-to-br from-purple-100 to-pink-100 rounded-2xl p-4 shadow-lg border-2 border-purple-200">
                    <div class="text-2xl mb-2">🎓</div>
                    <h4 class="text-lg font-bold text-purple-800 mb-1">Class & View</h4>
                    <p class="text-xl font-bold text-purple-900">Class ${student.class} - Combined View</p>
                </div>
            `;
            fieldsShown++;
            
            Object.keys(profileFields).forEach(fieldKey => {
                const field = profileFields[fieldKey];
                
                if (field.show && student[fieldKey] && fieldsShown < 6) {
                    let displayValue = student[fieldKey];
                    if (fieldKey === 'dateOfBirth') {
                        displayValue = new Date(student[fieldKey]).toLocaleDateString();
                    }
                    
                    const colorClass = fieldsShown === 1 ? 'from-blue-100 to-blue-100 border-blue-200 text-blue-800 text-blue-900' :
                                      fieldsShown === 2 ? 'from-green-100 to-green-100 border-green-200 text-green-800 text-green-900' :
                                      fieldsShown === 3 ? 'from-orange-100 to-orange-100 border-orange-200 text-orange-800 text-orange-900' :
                                      fieldsShown === 4 ? 'from-teal-100 to-teal-100 border-teal-200 text-teal-800 text-teal-900' :
                                      'from-pink-100 to-pink-100 border-pink-200 text-pink-800 text-pink-900';
                    
                    const colors = colorClass.split(' ');
                    
                    profileHTML += `
                        <div class="bg-gradient-to-br ${colors[0]} ${colors[1]} rounded-2xl p-4 shadow-lg border-2 ${colors[2]}">
                            <div class="text-2xl mb-2">${field.icon}</div>
                            <h4 class="text-lg font-bold ${colors[3]} mb-1">${field.label}</h4>
                            <p class="text-xl font-bold ${colors[4]}">${displayValue}</p>
                        </div>
                    `;
                    fieldsShown++;
                }
            });
            
            // Build combined marks table
            let combinedTableHTML = `
                <table class="w-full bg-white rounded-xl md:rounded-2xl shadow-lg overflow-hidden min-w-[700px]">
                    <thead class="bg-gradient-to-r from-teal-500 to-cyan-600 text-white">
                        <tr>
                            <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg">📚 Subject</th>
            `;
            
            // Add term headers
            studentTerms.forEach(term => {
                combinedTableHTML += `<th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg bg-gradient-to-r from-purple-500 to-pink-500" colspan="4">${term}</th>`;
            });
            
            combinedTableHTML += `
                    <th class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-sm md:text-lg bg-gradient-to-r from-orange-500 to-red-500">📊 Average</th>
                </tr>
                <tr class="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800">
                    <th class="py-2 px-2 text-center font-semibold text-xs"></th>
            `;
            
            // Add sub-headers
            studentTerms.forEach(term => {
                combinedTableHTML += `
                    <th class="py-1 px-1 text-center font-semibold text-xs">Oral</th>
                    <th class="py-1 px-1 text-center font-semibold text-xs">Written</th>
                    <th class="py-1 px-1 text-center font-semibold text-xs">Total</th>
                    <th class="py-1 px-1 text-center font-semibold text-xs">%</th>
                `;
            });
            
            combinedTableHTML += `
                    <th class="py-2 px-2 text-center font-semibold text-xs">Avg %</th>
                </tr>
            </thead>
            <tbody>
            `;
            
            // Add subject rows
            subjects.forEach((subject, index) => {
                const rowClass = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                combinedTableHTML += `
                    <tr class="${rowClass} hover:bg-blue-50 transition-all duration-300">
                        <td class="py-3 md:py-4 px-2 md:px-4 font-bold text-purple-700 text-center text-sm md:text-base">${subject}</td>
                `;
                
                let totalSubjectMarks = 0;
                let termCount = 0;
                
                studentTerms.forEach(term => {
                    const marks = student.marks[term][subject] || { oral: 0, written: 0 };
                    const oral = marks.oral || 0;
                    const written = marks.written || 0;
                    const total = oral + written;
                    const percentage = ((total / 20) * 100).toFixed(1);
                    
                    if (total > 0) {
                        totalSubjectMarks += parseFloat(percentage);
                        termCount++;
                    }
                    
                    combinedTableHTML += `
                        <td class="py-2 px-1 text-center text-blue-600 font-semibold text-xs md:text-sm">${oral}</td>
                        <td class="py-2 px-1 text-center text-green-600 font-semibold text-xs md:text-sm">${written}</td>
                        <td class="py-2 px-1 text-center text-indigo-700 font-bold text-xs md:text-sm">${total}</td>
                        <td class="py-2 px-1 text-center text-purple-600 font-semibold text-xs md:text-sm">${percentage}%</td>
                    `;
                });
                
                const averagePercentage = termCount > 0 ? (totalSubjectMarks / termCount).toFixed(1) : '0.0';
                
                combinedTableHTML += `
                        <td class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-orange-700 text-sm md:text-base">${averagePercentage}%</td>
                    </tr>
                `;
            });
            
            // Add totals row
            combinedTableHTML += `
                <tr class="bg-gradient-to-r from-yellow-100 to-orange-100 border-t-4 border-orange-300">
                    <td class="py-3 md:py-4 px-2 md:px-4 font-bold text-orange-700 text-center text-sm md:text-lg">🏆 TOTAL</td>
            `;
            
            let grandTotalPercentage = 0;
            let grandTermCount = 0;
            
            studentTerms.forEach(term => {
                let termOralTotal = 0;
                let termWrittenTotal = 0;
                let termTotal = 0;
                
                subjects.forEach(subject => {
                    const marks = student.marks[term][subject] || { oral: 0, written: 0 };
                    termOralTotal += marks.oral || 0;
                    termWrittenTotal += marks.written || 0;
                    termTotal += (marks.oral || 0) + (marks.written || 0);
                });
                
                const termMaxMarks = subjects.length * 20;
                const termPercentage = ((termTotal / termMaxMarks) * 100).toFixed(1);
                
                if (termTotal > 0) {
                    grandTotalPercentage += parseFloat(termPercentage);
                    grandTermCount++;
                }
                
                combinedTableHTML += `
                    <td class="py-2 px-1 text-center font-bold text-blue-700 text-xs md:text-sm">${termOralTotal}</td>
                    <td class="py-2 px-1 text-center font-bold text-green-700 text-xs md:text-sm">${termWrittenTotal}</td>
                    <td class="py-2 px-1 text-center font-bold text-orange-700 text-xs md:text-sm">${termTotal}</td>
                    <td class="py-2 px-1 text-center font-bold text-red-700 text-xs md:text-sm">${termPercentage}%</td>
                `;
            });
            
            const overallAverage = grandTermCount > 0 ? (grandTotalPercentage / grandTermCount).toFixed(1) : '0.0';
            
            combinedTableHTML += `
                    <td class="py-3 md:py-4 px-2 md:px-4 text-center font-bold text-red-700 text-sm md:text-lg">${overallAverage}%</td>
                </tr>
            </tbody>
            </table>
            `;
            
            const reportCardHTML = `
                <div class="bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-2xl md:rounded-3xl p-4 md:p-8 shadow-2xl border-2 md:border-4 border-blue-300">
                    <div class="text-center mb-4 md:mb-8">
                        <h3 class="text-2xl md:text-4xl font-bold bg-gradient-to-r from-teal-600 to-cyan-600 bg-clip-text text-transparent mb-4 md:mb-6">📊 COMBINED REPORT CARD 📊</h3>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4 mb-4 md:mb-6">
                            ${profileHTML}
                        </div>
                    </div>

                    <div class="overflow-x-auto mb-4 md:mb-6 mobile-scroll table-container">
                        ${combinedTableHTML}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                        <div class="bg-gradient-to-r from-green-100 to-blue-100 rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg border-2 border-green-200">
                            <h5 class="text-lg md:text-xl font-bold text-green-700 mb-3">📈 Combined Performance Summary</h5>
                            <div class="space-y-2">
                                <p class="font-semibold text-blue-600 text-sm md:text-base">📊 Overall Average: <span class="text-blue-700 text-base md:text-lg">${overallAverage}%</span></p>
                                <p class="font-semibold text-purple-600 text-sm md:text-base">📚 Terms Evaluated: <span class="text-purple-700">${studentTerms.length}</span></p>
                                <p class="font-semibold text-orange-600 text-sm md:text-base">📖 Subjects: <span class="text-orange-700">${subjects.length}</span></p>
                                <p class="font-semibold text-teal-600 text-sm md:text-base">📅 Terms: <span class="text-teal-700">${studentTerms.join(', ')}</span></p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg border-2 border-purple-200">
                            <h5 class="text-lg md:text-xl font-bold text-purple-700 mb-3">💬 Progress Analysis</h5>
                            <p class="text-purple-600 font-semibold text-sm md:text-base">
                                ${overallAverage >= 90 ? '🌟 Outstanding consistent performance across all terms!' :
                                  overallAverage >= 80 ? '👏 Excellent progress! Maintaining high standards!' :
                                  overallAverage >= 70 ? '👍 Good overall performance with room for improvement!' :
                                  overallAverage >= 60 ? '📚 Satisfactory progress. Focus on weaker subjects!' :
                                  overallAverage >= 40 ? '⚠️ Needs consistent effort across all terms!' :
                                  '🔄 Requires significant improvement in all areas!'}
                            </p>
                        </div>
                    </div>

                    <div class="text-center mt-4 md:mt-6">
                        <div class="bg-gradient-to-r from-teal-100 to-cyan-100 rounded-xl md:rounded-2xl p-3 md:p-4 border-2 border-teal-200">
                            <p class="text-teal-700 font-bold text-base md:text-lg">🎉 Combined view shows your complete academic journey! 🌟</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('reportCardContent').innerHTML = reportCardHTML;
            document.getElementById('reportCardDisplay').classList.remove('hidden');
            document.getElementById('reportCardDisplay').scrollIntoView({ behavior: 'smooth' });
            
            showAlert('Combined report card loaded successfully! ✅', 'success');
        }

        // Global functions for profile field management
        window.toggleFieldVisibility = async function(fieldKey, isVisible) {
            profileFields[fieldKey].show = isVisible;
            await saveProfileFieldsToFirebase();
            showAlert(`Field visibility updated! 💾✅`, 'success');
        };

        window.toggleFieldRequired = async function(fieldKey, isRequired) {
            profileFields[fieldKey].required = isRequired;
            await saveProfileFieldsToFirebase();
            showAlert(`Field requirement updated! 💾✅`, 'success');
        };

        window.deleteCustomField = async function(fieldKey) {
            if (confirm(`Are you sure you want to delete the "${profileFields[fieldKey].label}" field?`)) {
                delete profileFields[fieldKey];
                generateCombinedProfileFieldsList();
                await saveProfileFieldsToFirebase();
                showAlert('Custom field deleted successfully! 💾✅', 'success');
            }
        };

        // Global functions for term management
        window.toggleTermVisibility = async function(termName, isVisible) {
            if (isVisible && !availableTerms.includes(termName)) {
                availableTerms.push(termName);
            } else if (!isVisible && availableTerms.includes(termName)) {
                availableTerms = availableTerms.filter(term => term !== termName);
            }
            generateTermsList();
            await saveTermsToFirebase();
            showAlert(`${termName} visibility updated! 💾✅`, 'success');
        };

        window.deleteTerm = async function(termName) {
            if (confirm(`Are you sure you want to delete "${termName}"?`)) {
                allTerms = allTerms.filter(term => term !== termName);
                availableTerms = availableTerms.filter(term => term !== termName);
                generateTermsList();
                await saveTermsToFirebase();
                showAlert('Term deleted successfully! 💾✅', 'success');
            }
        };

        // Password Manager Functions
        function updatePasswordDisplay() {
            console.log('=== UPDATING PASSWORD DISPLAY ===');
            console.log('Current admin password:', schoolSettings.adminPassword);
            console.log('Password length:', schoolSettings.adminPassword.length);
            
            const display = document.getElementById('currentPasswordDisplay');
            if (display) {
                const maskedPassword = '•'.repeat(schoolSettings.adminPassword.length);
                display.textContent = `Current: ${maskedPassword}`;
                console.log('Password display updated successfully:', display.textContent);
                console.log('Display element found and updated');
            } else {
                console.error('❌ Password display element not found! Looking for: currentPasswordDisplay');
                // Try to find all elements with similar IDs
                const allElements = document.querySelectorAll('[id*="password"], [id*="Password"]');
                console.log('Found elements with password in ID:', allElements);
            }
            console.log('=== PASSWORD DISPLAY UPDATE COMPLETE ===');
        }

        // Generate random password function
        window.generateRandomPassword = function() {
            const length = 8;
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
            let password = "";
            
            // Ensure at least one of each type
            password += "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random() * 26)]; // Uppercase
            password += "abcdefghijklmnopqrstuvwxyz"[Math.floor(Math.random() * 26)]; // Lowercase
            password += "0123456789"[Math.floor(Math.random() * 10)]; // Number
            password += "!@#$%^&*"[Math.floor(Math.random() * 8)]; // Special char
            
            // Fill the rest randomly
            for (let i = 4; i < length; i++) {
                password += charset[Math.floor(Math.random() * charset.length)];
            }
            
            // Shuffle the password
            password = password.split('').sort(() => Math.random() - 0.5).join('');
            
            document.getElementById('newPassword').value = password;
            document.getElementById('confirmPassword').value = password;
            
            showAlert('Random password generated! 🎲✅', 'success');
        };

        // School settings and theme functions
        function updateSchoolDisplay() {
            // Update school header
            const schoolHeader = document.querySelector('.max-w-4xl h1');
            if (schoolHeader) {
                schoolHeader.innerHTML = `🏫 ${schoolSettings.name} 🏫`;
            }
            
            const schoolAddress = document.querySelector('.max-w-4xl p');
            if (schoolAddress) {
                schoolAddress.innerHTML = `📍 ${schoolSettings.address}`;
            }
            
            // Update marquees
            const topMarquee = document.querySelector('.marquee-top .marquee-content');
            if (topMarquee) {
                topMarquee.textContent = schoolSettings.topMarquee;
            }
            
            const bottomMarquee = document.querySelector('.marquee-bottom .marquee-content');
            if (bottomMarquee) {
                bottomMarquee.textContent = schoolSettings.bottomMarquee;
            }
            
            // Apply theme
            applyThemeToBody();
        }

        function getThemeColors(background, accent) {
            const themes = {
                rainbow: 'linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 25%, #45b7d1 50%, #96ceb4 75%, #feca57 100%)',
                ocean: 'linear-gradient(135deg, #667eea 0%, #764ba2 25%, #667eea 50%, #f093fb 75%, #f5576c 100%)',
                sunset: 'linear-gradient(135deg, #fa709a 0%, #fee140 25%, #fa709a 50%, #fee140 75%, #fa709a 100%)',
                forest: 'linear-gradient(135deg, #134e5e 0%, #71b280 25%, #134e5e 50%, #71b280 75%, #134e5e 100%)',
                lavender: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 25%, #a8edea 50%, #fed6e3 75%, #a8edea 100%)',
                cherry: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 25%, #ffecd2 50%, #fcb69f 75%, #ffecd2 100%)'
            };
            
            const accents = {
                blue: { primary: '#3b82f6', secondary: '#1d4ed8' },
                green: { primary: '#10b981', secondary: '#047857' },
                purple: { primary: '#8b5cf6', secondary: '#5b21b6' },
                orange: { primary: '#f97316', secondary: '#c2410c' },
                pink: { primary: '#ec4899', secondary: '#be185d' },
                teal: { primary: '#14b8a6', secondary: '#0f766e' }
            };
            
            return {
                background: themes[background] || themes.rainbow,
                accent: accents[accent] || accents.blue
            };
        }

        function applyThemeToBody() {
            const colors = getThemeColors(schoolSettings.theme.background, schoolSettings.theme.accent);
            document.body.style.background = colors.background;
        }

        window.previewTheme = function() {
            const background = document.getElementById('backgroundTheme').value;
            const accent = document.getElementById('accentColor').value;
            const schoolName = document.getElementById('schoolName').value || 'School Name';
            const schoolAddress = document.getElementById('schoolAddress').value || 'School Address';
            
            const colors = getThemeColors(background, accent);
            const preview = document.getElementById('themePreview');
            const previewName = document.getElementById('previewSchoolName');
            const previewAddress = document.getElementById('previewSchoolAddress');
            
            preview.style.background = colors.background;
            preview.style.borderColor = colors.accent.primary;
            preview.style.color = 'white';
            
            previewName.textContent = schoolName;
            previewName.style.color = 'white';
            previewAddress.textContent = schoolAddress;
            previewAddress.style.color = 'rgba(255, 255, 255, 0.8)';
        };

        window.resetToDefault = function() {
            document.getElementById('schoolName').value = 'Primary School Karanpur';
            document.getElementById('schoolAddress').value = 'Block-Behjam, District-Lakhimpur-Kheri';
            document.getElementById('topMarqueeContent').value = '🌟 Welcome to Primary School Karanpur - A place where students learn with joy! 🌟';
            document.getElementById('bottomMarqueeContent').value = '💝 This site is developed by Mr. Deepak Kumar Vaishya, Assistant Teacher at Primary School Karanpur 💝';
            document.getElementById('backgroundTheme').value = 'rainbow';
            document.getElementById('accentColor').value = 'blue';
            previewTheme();
        };

        window.applyTheme = function() {
            const tempSettings = {
                name: document.getElementById('schoolName').value.trim(),
                address: document.getElementById('schoolAddress').value.trim(),
                topMarquee: document.getElementById('topMarqueeContent').value.trim(),
                bottomMarquee: document.getElementById('bottomMarqueeContent').value.trim(),
                theme: {
                    background: document.getElementById('backgroundTheme').value,
                    accent: document.getElementById('accentColor').value
                }
            };
            
            // Temporarily apply settings for preview
            const originalSettings = { ...schoolSettings };
            schoolSettings = tempSettings;
            updateSchoolDisplay();
            
            // Show confirmation
            if (confirm('Do you like this theme? Click OK to keep it, or Cancel to revert.')) {
                showAlert('Theme applied! Remember to save your settings. ✨', 'success');
            } else {
                schoolSettings = originalSettings;
                updateSchoolDisplay();
                showAlert('Theme reverted to previous settings. 🔄', 'warning');
            }
        };

        // Tabulation Functions
        function populateTabulationTerms() {
            const termSelect = document.getElementById('tabulationTermSelect');
            termSelect.innerHTML = '<option value="">Select Term</option>';
            
            allTerms.forEach(term => {
                const option = document.createElement('option');
                option.value = term;
                option.textContent = term;
                termSelect.appendChild(option);
            });
        }

        function updateTabulationPreview() {
            const selectedClass = document.getElementById('tabulationClassSelect').value;
            const selectedTerm = document.getElementById('tabulationTermSelect').value;
            const previewDiv = document.getElementById('tabulationPreview');
            
            if (!selectedClass || !selectedTerm) {
                previewDiv.innerHTML = 'Select class and term to see preview information';
                return;
            }
            
            const classData = studentsData[selectedClass] || {};
            const studentCount = Object.keys(classData).length;
            const subjects = classSubjects[selectedClass] || [];
            
            if (selectedTerm === 'COMBINED_VIEW') {
                // Combined view preview
                let studentsWithAnyMarks = 0;
                let totalTermsWithData = 0;
                const termsWithData = new Set();
                
                Object.values(classData).forEach(student => {
                    if (student.marks) {
                        let hasAnyMarks = false;
                        Object.keys(student.marks).forEach(term => {
                            if (Object.keys(student.marks[term]).length > 0) {
                                termsWithData.add(term);
                                hasAnyMarks = true;
                            }
                        });
                        if (hasAnyMarks) studentsWithAnyMarks++;
                    }
                });
                
                previewDiv.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                        <div class="bg-blue-100 rounded-lg p-2">
                            <div class="font-bold text-blue-700">📚 Class</div>
                            <div class="text-blue-600">${selectedClass}</div>
                        </div>
                        <div class="bg-teal-100 rounded-lg p-2">
                            <div class="font-bold text-teal-700">📊 View Type</div>
                            <div class="text-teal-600">Combined</div>
                        </div>
                        <div class="bg-purple-100 rounded-lg p-2">
                            <div class="font-bold text-purple-700">👥 Students</div>
                            <div class="text-purple-600">${studentsWithAnyMarks}/${studentCount}</div>
                        </div>
                        <div class="bg-orange-100 rounded-lg p-2">
                            <div class="font-bold text-orange-700">📅 Terms</div>
                            <div class="text-orange-600">${termsWithData.size}</div>
                        </div>
                    </div>
                    <div class="mt-3 p-2 bg-gradient-to-r from-teal-100 to-cyan-100 rounded-lg border border-teal-300">
                        <div class="text-sm font-semibold text-teal-700">📋 Combined View includes: ${Array.from(termsWithData).join(', ')}</div>
                    </div>
                `;
            } else {
                // Single term preview
                let studentsWithMarks = 0;
                Object.values(classData).forEach(student => {
                    if (student.marks && student.marks[selectedTerm]) {
                        studentsWithMarks++;
                    }
                });
                
                previewDiv.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                        <div class="bg-blue-100 rounded-lg p-2">
                            <div class="font-bold text-blue-700">📚 Class</div>
                            <div class="text-blue-600">${selectedClass}</div>
                        </div>
                        <div class="bg-green-100 rounded-lg p-2">
                            <div class="font-bold text-green-700">📅 Term</div>
                            <div class="text-green-600">${selectedTerm}</div>
                        </div>
                        <div class="bg-purple-100 rounded-lg p-2">
                            <div class="font-bold text-purple-700">👥 Students</div>
                            <div class="text-purple-600">${studentsWithMarks}/${studentCount}</div>
                        </div>
                        <div class="bg-orange-100 rounded-lg p-2">
                            <div class="font-bold text-orange-700">📖 Subjects</div>
                            <div class="text-orange-600">${subjects.length}</div>
                        </div>
                    </div>
                `;
            }
        }

        function generateTabulationData(classId, term, layout) {
            const classData = studentsData[classId] || {};
            const subjects = classSubjects[classId] || [];
            const students = [];
            
            if (term === 'COMBINED_VIEW') {
                // Generate combined view data
                Object.entries(classData).forEach(([studentId, student]) => {
                    if (student.marks && Object.keys(student.marks).length > 0) {
                        const studentData = {
                            name: student.name || 'N/A',
                            rollNumber: student.rollNumber || 'N/A',
                            fatherName: student.fatherName || 'N/A',
                            marks: {},
                            termMarks: {}
                        };
                        
                        let grandTotalMarks = 0;
                        let grandMaxMarks = 0;
                        let termCount = 0;
                        
                        // Process each term
                        allTerms.forEach(termName => {
                            if (student.marks[termName]) {
                                let termTotalMarks = 0;
                                let termMaxMarks = 0;
                                
                                subjects.forEach(subject => {
                                    const subjectMarks = student.marks[termName][subject] || { oral: 0, written: 0 };
                                    const oral = subjectMarks.oral || 0;
                                    const written = subjectMarks.written || 0;
                                    const total = oral + written;
                                    
                                    if (!studentData.marks[subject]) {
                                        studentData.marks[subject] = {};
                                    }
                                    
                                    studentData.marks[subject][termName] = {
                                        oral,
                                        written,
                                        total,
                                        percentage: ((total / 20) * 100).toFixed(1)
                                    };
                                    
                                    termTotalMarks += total;
                                    termMaxMarks += 20;
                                });
                                
                                studentData.termMarks[termName] = {
                                    total: termTotalMarks,
                                    max: termMaxMarks,
                                    percentage: ((termTotalMarks / termMaxMarks) * 100).toFixed(1)
                                };
                                
                                grandTotalMarks += termTotalMarks;
                                grandMaxMarks += termMaxMarks;
                                termCount++;
                            }
                        });
                        
                        // Calculate subject averages
                        subjects.forEach(subject => {
                            if (studentData.marks[subject]) {
                                let subjectTotal = 0;
                                let subjectTermCount = 0;
                                
                                Object.values(studentData.marks[subject]).forEach(termData => {
                                    if (termData.total > 0) {
                                        subjectTotal += parseFloat(termData.percentage);
                                        subjectTermCount++;
                                    }
                                });
                                
                                studentData.marks[subject].average = subjectTermCount > 0 ? 
                                    (subjectTotal / subjectTermCount).toFixed(1) : '0.0';
                            }
                        });
                        
                        studentData.totalMarks = grandTotalMarks;
                        studentData.maxMarks = grandMaxMarks;
                        studentData.overallPercentage = termCount > 0 ? 
                            (grandTotalMarks / grandMaxMarks * 100).toFixed(1) : '0.0';
                        studentData.termCount = termCount;
                        
                        students.push(studentData);
                    }
                });
                
                return { students, subjects, isCombined: true, availableTerms: allTerms };
            } else {
                // Generate single term data
                Object.entries(classData).forEach(([studentId, student]) => {
                    if (student.marks && student.marks[term]) {
                        const studentData = {
                            name: student.name || 'N/A',
                            rollNumber: student.rollNumber || 'N/A',
                            fatherName: student.fatherName || 'N/A',
                            marks: {}
                        };
                        
                        let totalMarks = 0;
                        let maxMarks = 0;
                        
                        subjects.forEach(subject => {
                            const subjectMarks = student.marks[term][subject] || { oral: 0, written: 0 };
                            const oral = subjectMarks.oral || 0;
                            const written = subjectMarks.written || 0;
                            const total = oral + written;
                            const percentage = ((total / 20) * 100).toFixed(1);
                            
                            studentData.marks[subject] = {
                                oral,
                                written,
                                total,
                                percentage
                            };
                            
                            totalMarks += total;
                            maxMarks += 20;
                        });
                        
                        studentData.totalMarks = totalMarks;
                        studentData.maxMarks = maxMarks;
                        studentData.overallPercentage = ((totalMarks / maxMarks) * 100).toFixed(1);
                        
                        students.push(studentData);
                    }
                });
                
                // Sort students by roll number or name
                students.sort((a, b) => {
                    const rollA = parseInt(a.rollNumber) || 999;
                    const rollB = parseInt(b.rollNumber) || 999;
                    return rollA - rollB;
                });
                
                return { students, subjects, isCombined: false };
            }
        }

        function createTabulationTable(data, layout) {
            const { students, subjects, isCombined, availableTerms } = data;
            
            if (isCombined) {
                // Combined view table
                return createCombinedTabulationTable(data, layout);
            }
            
            let tableHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border-2 border-gray-800 bg-white text-sm">
                        <thead>
                            <tr class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                                <th class="border-2 border-gray-800 p-2 text-center font-bold">S.No.</th>
                                <th class="border-2 border-gray-800 p-2 text-center font-bold">Roll No.</th>
                                <th class="border-2 border-gray-800 p-2 text-center font-bold">Student Name</th>
                                <th class="border-2 border-gray-800 p-2 text-center font-bold">Father's Name</th>
            `;
            
            if (layout === 'detailed') {
                subjects.forEach(subject => {
                    tableHTML += `
                        <th class="border-2 border-gray-800 p-1 text-center font-bold bg-green-500" colspan="3">${subject}</th>
                    `;
                });
                tableHTML += `
                    <th class="border-2 border-gray-800 p-2 text-center font-bold bg-orange-500">Total</th>
                    <th class="border-2 border-gray-800 p-2 text-center font-bold bg-red-500">%</th>
                </tr>
                <tr class="bg-gray-200 text-black font-semibold">
                    <th class="border-2 border-gray-800 p-1"></th>
                    <th class="border-2 border-gray-800 p-1"></th>
                    <th class="border-2 border-gray-800 p-1"></th>
                    <th class="border-2 border-gray-800 p-1"></th>
                `;
                subjects.forEach(subject => {
                    tableHTML += `
                        <th class="border-2 border-gray-800 p-1 text-center text-xs">Oral</th>
                        <th class="border-2 border-gray-800 p-1 text-center text-xs">Written</th>
                        <th class="border-2 border-gray-800 p-1 text-center text-xs">Total</th>
                    `;
                });
                tableHTML += `
                    <th class="border-2 border-gray-800 p-1 text-center text-xs">Marks</th>
                    <th class="border-2 border-gray-800 p-1 text-center text-xs">Percent</th>
                </tr>
                `;
            } else if (layout === 'summary') {
                subjects.forEach(subject => {
                    tableHTML += `<th class="border-2 border-gray-800 p-2 text-center font-bold bg-green-500">${subject}</th>`;
                });
                tableHTML += `
                    <th class="border-2 border-gray-800 p-2 text-center font-bold bg-orange-500">Total</th>
                    <th class="border-2 border-gray-800 p-2 text-center font-bold bg-red-500">%</th>
                </tr>
                `;
            } else if (layout === 'percentage') {
                subjects.forEach(subject => {
                    tableHTML += `<th class="border-2 border-gray-800 p-2 text-center font-bold bg-green-500">${subject} %</th>`;
                });
                tableHTML += `
                    <th class="border-2 border-gray-800 p-2 text-center font-bold bg-red-500">Overall %</th>
                </tr>
                `;
            }
            
            tableHTML += '</thead><tbody>';
            
            // Add student rows
            students.forEach((student, index) => {
                tableHTML += `
                    <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-blue-50">
                        <td class="border-2 border-gray-800 p-2 text-center font-semibold">${index + 1}</td>
                        <td class="border-2 border-gray-800 p-2 text-center font-semibold">${student.rollNumber}</td>
                        <td class="border-2 border-gray-800 p-2 font-semibold">${student.name}</td>
                        <td class="border-2 border-gray-800 p-2">${student.fatherName}</td>
                `;
                
                if (layout === 'detailed') {
                    subjects.forEach(subject => {
                        const marks = student.marks[subject] || { oral: 0, written: 0, total: 0 };
                        tableHTML += `
                            <td class="border-2 border-gray-800 p-1 text-center">${marks.oral}</td>
                            <td class="border-2 border-gray-800 p-1 text-center">${marks.written}</td>
                            <td class="border-2 border-gray-800 p-1 text-center font-semibold">${marks.total}</td>
                        `;
                    });
                    tableHTML += `
                        <td class="border-2 border-gray-800 p-2 text-center font-bold text-orange-700">${student.totalMarks}</td>
                        <td class="border-2 border-gray-800 p-2 text-center font-bold text-red-700">${student.overallPercentage}%</td>
                    `;
                } else if (layout === 'summary') {
                    subjects.forEach(subject => {
                        const marks = student.marks[subject] || { total: 0 };
                        tableHTML += `<td class="border-2 border-gray-800 p-2 text-center font-semibold">${marks.total}</td>`;
                    });
                    tableHTML += `
                        <td class="border-2 border-gray-800 p-2 text-center font-bold text-orange-700">${student.totalMarks}</td>
                        <td class="border-2 border-gray-800 p-2 text-center font-bold text-red-700">${student.overallPercentage}%</td>
                    `;
                } else if (layout === 'percentage') {
                    subjects.forEach(subject => {
                        const marks = student.marks[subject] || { percentage: '0.0' };
                        tableHTML += `<td class="border-2 border-gray-800 p-2 text-center font-semibold">${marks.percentage}%</td>`;
                    });
                    tableHTML += `<td class="border-2 border-gray-800 p-2 text-center font-bold text-red-700">${student.overallPercentage}%</td>`;
                }
                
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table></div>';
            
            return tableHTML;
        }

        function createCombinedTabulationTable(data, layout) {
            const { students, subjects, availableTerms } = data;
            
            // Get terms that actually have data
            const termsWithData = [];
            students.forEach(student => {
                Object.keys(student.termMarks || {}).forEach(term => {
                    if (!termsWithData.includes(term)) {
                        termsWithData.push(term);
                    }
                });
            });
            
            let tableHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border-2 border-gray-800 bg-white text-xs">
                        <thead>
                            <tr class="bg-gradient-to-r from-teal-600 to-cyan-600 text-white">
                                <th class="border-2 border-gray-800 p-2 text-center font-bold">S.No.</th>
                                <th class="border-2 border-gray-800 p-2 text-center font-bold">Roll No.</th>
                                <th class="border-2 border-gray-800 p-2 text-center font-bold">Student Name</th>
                                <th class="border-2 border-gray-800 p-2 text-center font-bold">Father's Name</th>
                                <th class="border-2 border-gray-800 p-2 text-center font-bold">Term</th>
            `;
            
            if (layout === 'detailed') {
                // Detailed view - subjects as columns, terms as rows
                subjects.forEach(subject => {
                    tableHTML += `<th class="border-2 border-gray-800 p-1 text-center font-bold bg-green-500" colspan="3">${subject}</th>`;
                });
                tableHTML += `<th class="border-2 border-gray-800 p-2 text-center font-bold bg-orange-500">Term Total</th>`;
                tableHTML += `<th class="border-2 border-gray-800 p-2 text-center font-bold bg-red-500">Term %</th>`;
                
                // Sub-headers for O, W, T
                tableHTML += `</tr><tr class="bg-gray-200 text-black font-semibold">
                    <th class="border-2 border-gray-800 p-1"></th>
                    <th class="border-2 border-gray-800 p-1"></th>
                    <th class="border-2 border-gray-800 p-1"></th>
                    <th class="border-2 border-gray-800 p-1"></th>
                    <th class="border-2 border-gray-800 p-1"></th>`;
                
                subjects.forEach(subject => {
                    tableHTML += `
                        <th class="border-2 border-gray-800 p-1 text-center text-xs">O</th>
                        <th class="border-2 border-gray-800 p-1 text-center text-xs">W</th>
                        <th class="border-2 border-gray-800 p-1 text-center text-xs">T</th>
                    `;
                });
                tableHTML += `<th class="border-2 border-gray-800 p-1 text-center text-xs">Total</th>`;
                tableHTML += `<th class="border-2 border-gray-800 p-1 text-center text-xs">%</th>`;
                
            } else if (layout === 'summary') {
                // Summary view - subjects as columns, terms as rows
                subjects.forEach(subject => {
                    tableHTML += `<th class="border-2 border-gray-800 p-2 text-center font-bold bg-green-500">${subject}</th>`;
                });
                tableHTML += `<th class="border-2 border-gray-800 p-2 text-center font-bold bg-orange-500">Term Total</th>`;
                tableHTML += `<th class="border-2 border-gray-800 p-2 text-center font-bold bg-red-500">Term %</th>`;
                
            } else if (layout === 'percentage') {
                // Percentage view - subjects as columns, terms as rows
                subjects.forEach(subject => {
                    tableHTML += `<th class="border-2 border-gray-800 p-2 text-center font-bold bg-green-500">${subject} %</th>`;
                });
                tableHTML += `<th class="border-2 border-gray-800 p-2 text-center font-bold bg-red-500">Term Average %</th>`;
            }
            
            tableHTML += '</tr></thead><tbody>';
            
            // Add student rows - each student gets multiple rows (one per term)
            students.forEach((student, studentIndex) => {
                termsWithData.forEach((term, termIndex) => {
                    const isFirstTermForStudent = termIndex === 0;
                    const rowspan = termsWithData.length;
                    const rowClass = studentIndex % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                    
                    tableHTML += `<tr class="${rowClass} hover:bg-blue-50">`;
                    
                    // Student info columns (only show on first term row)
                    if (isFirstTermForStudent) {
                        tableHTML += `
                            <td class="border-2 border-gray-800 p-2 text-center font-semibold" rowspan="${rowspan}">${studentIndex + 1}</td>
                            <td class="border-2 border-gray-800 p-2 text-center font-semibold" rowspan="${rowspan}">${student.rollNumber}</td>
                            <td class="border-2 border-gray-800 p-2 font-semibold" rowspan="${rowspan}">${student.name}</td>
                            <td class="border-2 border-gray-800 p-2" rowspan="${rowspan}">${student.fatherName}</td>
                        `;
                    }
                    
                    // Term name
                    tableHTML += `<td class="border-2 border-gray-800 p-2 text-center font-semibold bg-blue-100">${term}</td>`;
                    
                    // Subject marks for this term
                    let termTotal = 0;
                    let termMaxMarks = 0;
                    
                    if (layout === 'detailed') {
                        subjects.forEach(subject => {
                            const termData = student.marks[subject] && student.marks[subject][term] ? 
                                student.marks[subject][term] : { oral: 0, written: 0, total: 0 };
                            
                            termTotal += termData.total;
                            termMaxMarks += 20;
                            
                            tableHTML += `
                                <td class="border-2 border-gray-800 p-1 text-center">${termData.oral}</td>
                                <td class="border-2 border-gray-800 p-1 text-center">${termData.written}</td>
                                <td class="border-2 border-gray-800 p-1 text-center font-semibold">${termData.total}</td>
                            `;
                        });
                        
                    } else if (layout === 'summary') {
                        subjects.forEach(subject => {
                            const termData = student.marks[subject] && student.marks[subject][term] ? 
                                student.marks[subject][term] : { total: 0 };
                            termTotal += termData.total;
                            termMaxMarks += 20;
                            tableHTML += `<td class="border-2 border-gray-800 p-1 text-center font-semibold">${termData.total}</td>`;
                        });
                        
                    } else if (layout === 'percentage') {
                        let termPercentageTotal = 0;
                        let subjectCount = 0;
                        
                        subjects.forEach(subject => {
                            const termData = student.marks[subject] && student.marks[subject][term] ? 
                                student.marks[subject][term] : { percentage: '0.0' };
                            termPercentageTotal += parseFloat(termData.percentage);
                            subjectCount++;
                            tableHTML += `<td class="border-2 border-gray-800 p-1 text-center font-semibold">${termData.percentage}%</td>`;
                        });
                        
                        const termAveragePercentage = subjectCount > 0 ? (termPercentageTotal / subjectCount).toFixed(1) : '0.0';
                        tableHTML += `<td class="border-2 border-gray-800 p-2 text-center font-bold text-red-700">${termAveragePercentage}%</td>`;
                    }
                    
                    // Term totals (for detailed and summary views)
                    if (layout !== 'percentage') {
                        const termPercentage = termMaxMarks > 0 ? ((termTotal / termMaxMarks) * 100).toFixed(1) : '0.0';
                        tableHTML += `<td class="border-2 border-gray-800 p-2 text-center font-bold text-orange-700">${termTotal}</td>`;
                        tableHTML += `<td class="border-2 border-gray-800 p-2 text-center font-bold text-red-700">${termPercentage}%</td>`;
                    }
                    
                    tableHTML += '</tr>';
                });
                
                // Add overall average row for each student
                tableHTML += `<tr class="bg-gradient-to-r from-yellow-100 to-orange-100 border-t-2 border-orange-400">
                    <td class="border-2 border-gray-800 p-2 text-center font-bold text-orange-700" colspan="5">🏆 ${student.name} - OVERALL AVERAGE</td>`;
                
                if (layout === 'detailed' || layout === 'summary') {
                    // Calculate subject averages
                    subjects.forEach(subject => {
                        let subjectTotal = 0;
                        let termCount = 0;
                        
                        termsWithData.forEach(term => {
                            const termData = student.marks[subject] && student.marks[subject][term] ? 
                                student.marks[subject][term] : { total: 0 };
                            if (termData.total > 0) {
                                subjectTotal += termData.total;
                                termCount++;
                            }
                        });
                        
                        const subjectAverage = termCount > 0 ? (subjectTotal / termCount).toFixed(1) : '0.0';
                        
                        if (layout === 'detailed') {
                            const avgOral = termCount > 0 ? (subjectTotal / termCount / 4).toFixed(1) : '0.0'; // Approximate oral average
                            const avgWritten = termCount > 0 ? (subjectTotal / termCount * 3 / 4).toFixed(1) : '0.0'; // Approximate written average
                            tableHTML += `
                                <td class="border-2 border-gray-800 p-1 text-center font-bold text-blue-600">${avgOral}</td>
                                <td class="border-2 border-gray-800 p-1 text-center font-bold text-green-600">${avgWritten}</td>
                                <td class="border-2 border-gray-800 p-1 text-center font-bold text-purple-600">${subjectAverage}</td>
                            `;
                        } else {
                            tableHTML += `<td class="border-2 border-gray-800 p-1 text-center font-bold text-purple-600">${subjectAverage}</td>`;
                        }
                    });
                    
                    tableHTML += `<td class="border-2 border-gray-800 p-2 text-center font-bold text-red-700">${student.totalMarks}</td>`;
                    tableHTML += `<td class="border-2 border-gray-800 p-2 text-center font-bold text-red-700">${student.overallPercentage}%</td>`;
                    
                } else if (layout === 'percentage') {
                    // Calculate subject percentage averages
                    subjects.forEach(subject => {
                        let subjectPercentageTotal = 0;
                        let termCount = 0;
                        
                        termsWithData.forEach(term => {
                            const termData = student.marks[subject] && student.marks[subject][term] ? 
                                student.marks[subject][term] : { percentage: '0.0' };
                            if (parseFloat(termData.percentage) > 0) {
                                subjectPercentageTotal += parseFloat(termData.percentage);
                                termCount++;
                            }
                        });
                        
                        const subjectAveragePercentage = termCount > 0 ? (subjectPercentageTotal / termCount).toFixed(1) : '0.0';
                        tableHTML += `<td class="border-2 border-gray-800 p-1 text-center font-bold text-purple-600">${subjectAveragePercentage}%</td>`;
                    });
                    
                    tableHTML += `<td class="border-2 border-gray-800 p-2 text-center font-bold text-red-700">${student.overallPercentage}%</td>`;
                }
                
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table></div>';
            
            return tableHTML;
        }

        function showTabulationPreview() {
            const selectedClass = document.getElementById('tabulationClassSelect').value;
            const selectedTerm = document.getElementById('tabulationTermSelect').value;
            const selectedLayout = document.getElementById('tabulationLayout').value;
            
            if (!selectedClass || !selectedTerm) {
                showAlert('Please select class and term first! ⚠️', 'warning');
                return;
            }
            
            const data = generateTabulationData(selectedClass, selectedTerm, selectedLayout);
            
            if (data.students.length === 0) {
                showAlert('No student data found for the selected class and term! ⚠️', 'warning');
                return;
            }
            
            const tableHTML = createTabulationTable(data, selectedLayout);
            
            const termDisplay = selectedTerm === 'COMBINED_VIEW' ? 'Combined View (All Terms)' : selectedTerm;
            const viewType = selectedTerm === 'COMBINED_VIEW' ? 'Combined Report' : 'Single Term Report';
            
            const headerHTML = `
                <div class="text-center mb-6 p-4 bg-gradient-to-r ${selectedTerm === 'COMBINED_VIEW' ? 'from-teal-100 to-cyan-100 border-teal-300' : 'from-blue-100 to-purple-100 border-blue-300'} rounded-xl border-2">
                    <h1 class="text-2xl font-bold ${selectedTerm === 'COMBINED_VIEW' ? 'text-teal-800' : 'text-blue-800'} mb-2">🏫 PRIMARY SCHOOL KARANPUR</h1>
                    <p class="text-lg font-semibold ${selectedTerm === 'COMBINED_VIEW' ? 'text-cyan-700' : 'text-purple-700'}">📍 Block-Behjam, District-Lakhimpur-Kheri</p>
                    <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                        <div class="bg-white rounded-lg p-2 border border-blue-200">
                            <span class="font-bold text-blue-600">Class:</span> ${selectedClass}
                        </div>
                        <div class="bg-white rounded-lg p-2 border border-blue-200">
                            <span class="font-bold ${selectedTerm === 'COMBINED_VIEW' ? 'text-teal-600' : 'text-green-600'}">Term:</span> ${termDisplay}
                        </div>
                        <div class="bg-white rounded-lg p-2 border border-blue-200">
                            <span class="font-bold text-purple-600">Students:</span> ${data.students.length}
                        </div>
                        <div class="bg-white rounded-lg p-2 border border-blue-200">
                            <span class="font-bold text-orange-600">Type:</span> ${viewType}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('tabulationPreviewContent').innerHTML = headerHTML + tableHTML;
            document.getElementById('tabulationPreviewModal').classList.remove('hidden');
            document.getElementById('tabulationPreviewModal').scrollIntoView({ behavior: 'smooth' });
        }

        function generateTabulationSheet() {
            const selectedClass = document.getElementById('tabulationClassSelect').value;
            const selectedTerm = document.getElementById('tabulationTermSelect').value;
            const selectedFormat = document.getElementById('tabulationFormat').value;
            const selectedLayout = document.getElementById('tabulationLayout').value;
            
            if (!selectedClass || !selectedTerm) {
                showAlert('Please select class and term first! ⚠️', 'warning');
                return;
            }
            
            const data = generateTabulationData(selectedClass, selectedTerm, selectedLayout);
            
            if (data.students.length === 0) {
                showAlert('No student data found for the selected class and term! ⚠️', 'warning');
                return;
            }
            
            const termForFile = selectedTerm === 'COMBINED_VIEW' ? 'CombinedView' : selectedTerm.replace(/\s+/g, '');
            const fileName = `Tabulation_Class${selectedClass}_${termForFile}_${new Date().toISOString().split('T')[0]}`;
            
            if (selectedFormat === 'csv') {
                downloadCSV(data, selectedLayout, fileName);
            } else if (selectedFormat === 'excel') {
                downloadExcel(data, selectedLayout, fileName);
            } else if (selectedFormat === 'pdf') {
                downloadPDF(data, selectedLayout, fileName, selectedClass, selectedTerm);
            }
            
            showAlert('Tabulation sheet generated successfully! 📊✅', 'success');
        }

        function downloadCSV(data, layout, fileName) {
            const { students, subjects, isCombined } = data;
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Header row
            let headers = ["S.No.", "Roll No.", "Student Name", "Father's Name"];
            
            if (isCombined) {
                // Combined view headers - subjects as columns, terms as rows
                headers.push("Term");
                
                if (layout === 'detailed') {
                    subjects.forEach(subject => {
                        headers.push(`${subject} Oral`, `${subject} Written`, `${subject} Total`);
                    });
                    headers.push("Term Total", "Term %");
                } else if (layout === 'summary') {
                    subjects.forEach(subject => {
                        headers.push(subject);
                    });
                    headers.push("Term Total", "Term %");
                } else if (layout === 'percentage') {
                    subjects.forEach(subject => {
                        headers.push(`${subject} %`);
                    });
                    headers.push("Term Average %");
                }
            } else {
                // Single term headers
                if (layout === 'detailed') {
                    subjects.forEach(subject => {
                        headers.push(`${subject} Oral`, `${subject} Written`, `${subject} Total`);
                    });
                    headers.push("Total Marks", "Percentage");
                } else if (layout === 'summary') {
                    subjects.forEach(subject => {
                        headers.push(subject);
                    });
                    headers.push("Total Marks", "Percentage");
                } else if (layout === 'percentage') {
                    subjects.forEach(subject => {
                        headers.push(`${subject} %`);
                    });
                    headers.push("Overall %");
                }
            }
            
            csvContent += headers.join(",") + "\n";
            
            // Data rows
            students.forEach((student, index) => {
                let row = [
                    index + 1,
                    `"${student.rollNumber}"`,
                    `"${student.name}"`,
                    `"${student.fatherName}"`
                ];
                
                if (isCombined) {
                    // Combined view data - each student gets multiple rows (one per term)
                    const termsWithData = [];
                    students.forEach(s => {
                        Object.keys(s.termMarks || {}).forEach(term => {
                            if (!termsWithData.includes(term)) {
                                termsWithData.push(term);
                            }
                        });
                    });
                    
                    // For combined view, we need to create multiple rows per student
                    // This will be handled differently - we'll create separate CSV rows for each term
                    csvContent += row.join(",") + "\n";
                    
                    // Add term rows for this student
                    termsWithData.forEach(term => {
                        let termRow = ["", "", "", "", `"${term}"`]; // Empty student info, just term name
                        
                        let termTotal = 0;
                        let termMaxMarks = 0;
                        
                        if (layout === 'detailed') {
                            subjects.forEach(subject => {
                                const termData = student.marks[subject] && student.marks[subject][term] ? 
                                    student.marks[subject][term] : { oral: 0, written: 0, total: 0 };
                                termTotal += termData.total;
                                termMaxMarks += 20;
                                termRow.push(termData.oral, termData.written, termData.total);
                            });
                            const termPercentage = termMaxMarks > 0 ? ((termTotal / termMaxMarks) * 100).toFixed(1) : '0.0';
                            termRow.push(termTotal, termPercentage);
                        } else if (layout === 'summary') {
                            subjects.forEach(subject => {
                                const termData = student.marks[subject] && student.marks[subject][term] ? 
                                    student.marks[subject][term] : { total: 0 };
                                termTotal += termData.total;
                                termMaxMarks += 20;
                                termRow.push(termData.total);
                            });
                            const termPercentage = termMaxMarks > 0 ? ((termTotal / termMaxMarks) * 100).toFixed(1) : '0.0';
                            termRow.push(termTotal, termPercentage);
                        } else if (layout === 'percentage') {
                            let termPercentageTotal = 0;
                            let subjectCount = 0;
                            subjects.forEach(subject => {
                                const termData = student.marks[subject] && student.marks[subject][term] ? 
                                    student.marks[subject][term] : { percentage: '0.0' };
                                termPercentageTotal += parseFloat(termData.percentage);
                                subjectCount++;
                                termRow.push(termData.percentage);
                            });
                            const termAveragePercentage = subjectCount > 0 ? (termPercentageTotal / subjectCount).toFixed(1) : '0.0';
                            termRow.push(termAveragePercentage);
                        }
                        
                        csvContent += termRow.join(",") + "\n";
                    });
                    
                    // Add overall average row
                    let avgRow = ["", "", "", "", `"OVERALL AVERAGE"`];
                    if (layout === 'detailed' || layout === 'summary') {
                        subjects.forEach(subject => {
                            let subjectTotal = 0;
                            let termCount = 0;
                            termsWithData.forEach(term => {
                                const termData = student.marks[subject] && student.marks[subject][term] ? 
                                    student.marks[subject][term] : { total: 0 };
                                if (termData.total > 0) {
                                    subjectTotal += termData.total;
                                    termCount++;
                                }
                            });
                            const subjectAverage = termCount > 0 ? (subjectTotal / termCount).toFixed(1) : '0.0';
                            
                            if (layout === 'detailed') {
                                const avgOral = termCount > 0 ? (subjectTotal / termCount / 4).toFixed(1) : '0.0';
                                const avgWritten = termCount > 0 ? (subjectTotal / termCount * 3 / 4).toFixed(1) : '0.0';
                                avgRow.push(avgOral, avgWritten, subjectAverage);
                            } else {
                                avgRow.push(subjectAverage);
                            }
                        });
                        avgRow.push(student.totalMarks, student.overallPercentage);
                    } else if (layout === 'percentage') {
                        subjects.forEach(subject => {
                            let subjectPercentageTotal = 0;
                            let termCount = 0;
                            termsWithData.forEach(term => {
                                const termData = student.marks[subject] && student.marks[subject][term] ? 
                                    student.marks[subject][term] : { percentage: '0.0' };
                                if (parseFloat(termData.percentage) > 0) {
                                    subjectPercentageTotal += parseFloat(termData.percentage);
                                    termCount++;
                                }
                            });
                            const subjectAveragePercentage = termCount > 0 ? (subjectPercentageTotal / termCount).toFixed(1) : '0.0';
                            avgRow.push(subjectAveragePercentage);
                        });
                        avgRow.push(student.overallPercentage);
                    }
                    csvContent += avgRow.join(",") + "\n";
                    
                    // Skip the normal row processing for combined view
                    return;
                } else {
                    // Single term data
                    if (layout === 'detailed') {
                        subjects.forEach(subject => {
                            const marks = student.marks[subject] || { oral: 0, written: 0, total: 0 };
                            row.push(marks.oral, marks.written, marks.total);
                        });
                        row.push(student.totalMarks, student.overallPercentage);
                    } else if (layout === 'summary') {
                        subjects.forEach(subject => {
                            const marks = student.marks[subject] || { total: 0 };
                            row.push(marks.total);
                        });
                        row.push(student.totalMarks, student.overallPercentage);
                    } else if (layout === 'percentage') {
                        subjects.forEach(subject => {
                            const marks = student.marks[subject] || { percentage: '0.0' };
                            row.push(marks.percentage);
                        });
                        row.push(student.overallPercentage);
                    }
                }
                
                csvContent += row.join(",") + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", fileName + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadExcel(data, layout, fileName) {
            // For Excel, we'll create an HTML table and download as .xls
            const { students, subjects, isCombined } = data;
            let excelContent = `
                <html>
                <head>
                    <meta charset="utf-8">
                    <style>
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid black; padding: 5px; text-align: center; }
                        th { background-color: #4CAF50; color: white; font-weight: bold; }
                        .header { background-color: #2196F3; color: white; }
                        .total { background-color: #FF9800; color: white; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h2 style="text-align: center;">PRIMARY SCHOOL KARANPUR</h2>
                    <h3 style="text-align: center;">Block-Behjam, District-Lakhimpur-Kheri</h3>
                    <p style="text-align: center;"><strong>Class ${document.getElementById('tabulationClassSelect').value} - ${document.getElementById('tabulationTermSelect').value === 'COMBINED_VIEW' ? 'Combined View (All Terms)' : document.getElementById('tabulationTermSelect').value}</strong></p>
                    <table>
                        <thead>
                            <tr class="header">
                                <th>S.No.</th>
                                <th>Roll No.</th>
                                <th>Student Name</th>
                                <th>Father's Name</th>
            `;
            
            if (isCombined) {
                // Combined view Excel headers - subjects as columns, terms as rows
                excelContent += `<th>Term</th>`;
                
                if (layout === 'detailed') {
                    subjects.forEach(subject => {
                        excelContent += `<th colspan="3">${subject}</th>`;
                    });
                    excelContent += `<th>Term Total</th><th>Term %</th></tr><tr class="header">
                        <th></th><th></th><th></th><th></th><th></th>`;
                    subjects.forEach(subject => {
                        excelContent += `<th>Oral</th><th>Written</th><th>Total</th>`;
                    });
                    excelContent += `<th>Total</th><th>Percent</th>`;
                } else if (layout === 'summary') {
                    subjects.forEach(subject => {
                        excelContent += `<th>${subject}</th>`;
                    });
                    excelContent += `<th>Term Total</th><th>Term %</th>`;
                } else if (layout === 'percentage') {
                    subjects.forEach(subject => {
                        excelContent += `<th>${subject} %</th>`;
                    });
                    excelContent += `<th>Term Average %</th>`;
                }
            } else {
                // Single term Excel headers
                if (layout === 'detailed') {
                    subjects.forEach(subject => {
                        excelContent += `<th colspan="3">${subject}</th>`;
                    });
                    excelContent += `<th>Total</th><th>%</th></tr><tr class="header">
                        <th></th><th></th><th></th><th></th>`;
                    subjects.forEach(subject => {
                        excelContent += `<th>Oral</th><th>Written</th><th>Total</th>`;
                    });
                    excelContent += `<th>Marks</th><th>Percent</th>`;
                } else if (layout === 'summary') {
                    subjects.forEach(subject => {
                        excelContent += `<th>${subject}</th>`;
                    });
                    excelContent += `<th>Total</th><th>%</th>`;
                } else if (layout === 'percentage') {
                    subjects.forEach(subject => {
                        excelContent += `<th>${subject} %</th>`;
                    });
                    excelContent += `<th>Overall %</th>`;
                }
            }
            
            excelContent += `</tr></thead><tbody>`;
            
            students.forEach((student, index) => {
                excelContent += `<tr>
                    <td>${index + 1}</td>
                    <td>${student.rollNumber}</td>
                    <td>${student.name}</td>
                    <td>${student.fatherName}</td>`;
                
                if (isCombined) {
                    // Combined view Excel data - each student gets multiple rows (one per term)
                    const termsWithData = [];
                    students.forEach(s => {
                        Object.keys(s.termMarks || {}).forEach(term => {
                            if (!termsWithData.includes(term)) {
                                termsWithData.push(term);
                            }
                        });
                    });
                    
                    // Add term rows for this student
                    termsWithData.forEach((term, termIndex) => {
                        if (termIndex === 0) {
                            // First term row includes student info
                            excelContent += `</td>`;
                        } else {
                            // Subsequent term rows start fresh
                            excelContent += `<tr>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>`;
                        }
                        
                        excelContent += `<td>${term}</td>`;
                        
                        let termTotal = 0;
                        let termMaxMarks = 0;
                        
                        if (layout === 'detailed') {
                            subjects.forEach(subject => {
                                const termData = student.marks[subject] && student.marks[subject][term] ? 
                                    student.marks[subject][term] : { oral: 0, written: 0, total: 0 };
                                termTotal += termData.total;
                                termMaxMarks += 20;
                                excelContent += `<td>${termData.oral}</td><td>${termData.written}</td><td>${termData.total}</td>`;
                            });
                            const termPercentage = termMaxMarks > 0 ? ((termTotal / termMaxMarks) * 100).toFixed(1) : '0.0';
                            excelContent += `<td class="total">${termTotal}</td><td class="total">${termPercentage}%</td>`;
                        } else if (layout === 'summary') {
                            subjects.forEach(subject => {
                                const termData = student.marks[subject] && student.marks[subject][term] ? 
                                    student.marks[subject][term] : { total: 0 };
                                termTotal += termData.total;
                                termMaxMarks += 20;
                                excelContent += `<td>${termData.total}</td>`;
                            });
                            const termPercentage = termMaxMarks > 0 ? ((termTotal / termMaxMarks) * 100).toFixed(1) : '0.0';
                            excelContent += `<td class="total">${termTotal}</td><td class="total">${termPercentage}%</td>`;
                        } else if (layout === 'percentage') {
                            let termPercentageTotal = 0;
                            let subjectCount = 0;
                            subjects.forEach(subject => {
                                const termData = student.marks[subject] && student.marks[subject][term] ? 
                                    student.marks[subject][term] : { percentage: '0.0' };
                                termPercentageTotal += parseFloat(termData.percentage);
                                subjectCount++;
                                excelContent += `<td>${termData.percentage}%</td>`;
                            });
                            const termAveragePercentage = subjectCount > 0 ? (termPercentageTotal / subjectCount).toFixed(1) : '0.0';
                            excelContent += `<td class="total">${termAveragePercentage}%</td>`;
                        }
                        
                        excelContent += `</tr>`;
                    });
                    
                    // Add overall average row
                    excelContent += `<tr class="total">
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td><strong>OVERALL AVERAGE</strong></td>`;
                    
                    if (layout === 'detailed' || layout === 'summary') {
                        subjects.forEach(subject => {
                            let subjectTotal = 0;
                            let termCount = 0;
                            termsWithData.forEach(term => {
                                const termData = student.marks[subject] && student.marks[subject][term] ? 
                                    student.marks[subject][term] : { total: 0 };
                                if (termData.total > 0) {
                                    subjectTotal += termData.total;
                                    termCount++;
                                }
                            });
                            const subjectAverage = termCount > 0 ? (subjectTotal / termCount).toFixed(1) : '0.0';
                            
                            if (layout === 'detailed') {
                                const avgOral = termCount > 0 ? (subjectTotal / termCount / 4).toFixed(1) : '0.0';
                                const avgWritten = termCount > 0 ? (subjectTotal / termCount * 3 / 4).toFixed(1) : '0.0';
                                excelContent += `<td>${avgOral}</td><td>${avgWritten}</td><td>${subjectAverage}</td>`;
                            } else {
                                excelContent += `<td>${subjectAverage}</td>`;
                            }
                        });
                        excelContent += `<td class="total">${student.totalMarks}</td><td class="total">${student.overallPercentage}%</td>`;
                    } else if (layout === 'percentage') {
                        subjects.forEach(subject => {
                            let subjectPercentageTotal = 0;
                            let termCount = 0;
                            termsWithData.forEach(term => {
                                const termData = student.marks[subject] && student.marks[subject][term] ? 
                                    student.marks[subject][term] : { percentage: '0.0' };
                                if (parseFloat(termData.percentage) > 0) {
                                    subjectPercentageTotal += parseFloat(termData.percentage);
                                    termCount++;
                                }
                            });
                            const subjectAveragePercentage = termCount > 0 ? (subjectPercentageTotal / termCount).toFixed(1) : '0.0';
                            excelContent += `<td>${subjectAveragePercentage}%</td>`;
                        });
                        excelContent += `<td class="total">${student.overallPercentage}%</td>`;
                    }
                    
                    excelContent += `</tr>`;
                    
                    // Skip normal processing for combined view
                    return;
                } else {
                    // Single term Excel data
                    if (layout === 'detailed') {
                        subjects.forEach(subject => {
                            const marks = student.marks[subject] || { oral: 0, written: 0, total: 0 };
                            excelContent += `<td>${marks.oral}</td><td>${marks.written}</td><td>${marks.total}</td>`;
                        });
                        excelContent += `<td class="total">${student.totalMarks}</td><td class="total">${student.overallPercentage}%</td>`;
                    } else if (layout === 'summary') {
                        subjects.forEach(subject => {
                            const marks = student.marks[subject] || { total: 0 };
                            excelContent += `<td>${marks.total}</td>`;
                        });
                        excelContent += `<td class="total">${student.totalMarks}</td><td class="total">${student.overallPercentage}%</td>`;
                    } else if (layout === 'percentage') {
                        subjects.forEach(subject => {
                            const marks = student.marks[subject] || { percentage: '0.0' };
                            excelContent += `<td>${marks.percentage}%</td>`;
                        });
                        excelContent += `<td class="total">${student.overallPercentage}%</td>`;
                    }
                }
                
                excelContent += `</tr>`;
            });
            
            excelContent += `</tbody></table></body></html>`;
            
            const blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName + '.xls';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        function downloadPDF(data, layout, fileName, selectedClass, selectedTerm) {
            // Create a printable HTML version for PDF
            const { students, subjects, isCombined } = data;
            const tableHTML = createTabulationTable(data, layout);
            
            const pdfContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <title>Tabulation Sheet - Class ${selectedClass}</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .header h1 { color: #2196F3; margin: 5px 0; }
                        .header h2 { color: #4CAF50; margin: 5px 0; }
                        .info { display: flex; justify-content: space-between; margin: 10px 0; }
                        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                        th, td { border: 2px solid #000; padding: 4px; text-align: center; font-size: 12px; }
                        th { background-color: #4CAF50; color: white; font-weight: bold; }
                        .total { background-color: #FF9800; color: white; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f2f2f2; }
                        .signature { margin-top: 40px; display: flex; justify-content: space-between; }
                        .signature div { text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>🏫 PRIMARY SCHOOL KARANPUR</h1>
                        <h2>📍 Block-Behjam, District-Lakhimpur-Kheri</h2>
                        <div class="info">
                            <div><strong>Class:</strong> ${selectedClass}</div>
                            <div><strong>Term:</strong> ${selectedTerm === 'COMBINED_VIEW' ? 'Combined View (All Terms)' : selectedTerm}</div>
                            <div><strong>Students:</strong> ${students.length}</div>
                            <div><strong>Type:</strong> ${isCombined ? 'Combined Report' : 'Single Term Report'}</div>
                        </div>
                    </div>
                    
                    ${tableHTML}
                    
                    <div class="signature">
                        <div>
                            <br><br>
                            ________________________<br>
                            <strong>Class Teacher</strong>
                        </div>
                        <div>
                            <br><br>
                            ________________________<br>
                            <strong>Head Teacher</strong>
                        </div>
                    </div>
                    
                    <div class="no-print" style="margin-top: 20px; text-align: center;">
                        <button onclick="window.print()" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                            🖨️ Print PDF
                        </button>
                        <button onclick="window.close()" style="background: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                            ❌ Close
                        </button>
                    </div>
                </body>
                </html>
            `;
            
            const newWindow = window.open('', '_blank');
            newWindow.document.write(pdfContent);
            newWindow.document.close();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9810845da461793b',t:'MTc1ODE5NTA4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
